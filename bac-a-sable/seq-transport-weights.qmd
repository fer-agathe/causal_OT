---
title: "sequential transport"
format: html
editor: visual
---

# Theoretical

```{r}
M0=c(-1,-1)
M1=c(1.5,1.5)
S0=4*matrix(c(1,.5,.5,1)*1.2^2,2,2)
S1=4*matrix(c(1,-.4,-.4,1)*.9^2,2,2)
set.seed(1234)
couleur = c("#3fb3b2", "#ffdd55","#1b95e0")

x0 = c(-2,-1)

T1x0 = qnorm(pnorm(x0[1],M0[1],sqrt(S0[1,1])),M1[1],sqrt(S1[1,1]))
m10 = M0[2]+S0[1,2]/S0[1,1]*(x0[1]-M0[1])
s10 = S0[2,2]-S0[1,2]^2/S0[1,1]
m11 = M1[2]+S1[1,2]/S1[1,1]*(T1x0[1]-M1[1])
s11 = S1[2,2]-S1[1,2]^2/S1[1,1]
T2x0 = qnorm(pnorm(x0[2],m10,sqrt(s10)),m11,sqrt(s11)) 

Z0=as.data.frame(ellipse::ellipse(S0,level=.5))
Z0 = Z0+rep(M0,each=nrow(Z0))
Z1=as.data.frame(ellipse::ellipse(S1,level=.5))
Z1 = Z1+rep(M1,each=nrow(Z1))
plot(Z0,type="l",col=couleur[1],
     xlim=range(c(Z0[,1],Z1[,1])),
     ylim=range(c(Z0[,2],Z1[,2])),xlab="",ylab="")
lines(Z1,type="l",col=couleur[2])
points(x0[1],x0[2],pch=19,col=couleur[3],cex=2)
segments(x0[1],x0[2],T1x0,x0[2],col=couleur[3])
points(T1x0,x0[2],pch=19,col=couleur[3],cex=1)
segments(T1x0,T2x0,T1x0,x0[2],col=couleur[3])
points(T1x0,T2x0,pch=19,col=couleur[3],cex=2)

cat("...",round(T1x0,4),"...",round(T2x0,4),"\n")


library(mvtnorm)
set.seed(12345)
n = 1e6
X0 = mnormt::rmnorm(n, M0, S0)
X1 = mnormt::rmnorm(n, M1, S1)
Transp2x0 = function(h=.1){
u = mean(X0[,1]<=x0[1])
T1x0 = as.numeric(quantile(X1[,1],u))
w0x0=dnorm(X0[,1],x0[1],sd=h)
w0x0=w0x0/sum(w0x0)
w1x0=dnorm(X1[,1],T1x0,sd=h)
w1x0=w1x0/sum(w1x0)
u = weighted.mean(X0[,2]<=x0[2],w0x0)
# T2x0 = as.numeric(DescTools::Quantile(X1[,2],weights = w1x0, probs = u))
library(Hmisc)
T2x0 = as.numeric(Hmisc::wtd.quantile(X1[,2],weights = w1x0, probs = u, normwt = TRUE))
return(T2x0)
}

library(mvtnorm)
Transp2x0 = function(n=1e3){
  h=.0001+runif(1)
X0 = mnormt::rmnorm(n, M0, S0)
X1 = mnormt::rmnorm(n, M1, S1)
u = mean(X0[,1]<=x0[1])
T1x0 = as.numeric(quantile(X1[,1],u))
w0x0=dnorm(X0[,1],x0[1],sd=h)
w0x0=w0x0/sum(w0x0)
w1x0=dnorm(X1[,1],T1x0,sd=h)
w1x0=w1x0/sum(w1x0)
u = weighted.mean(X0[,2]<=x0[2],w0x0)
# T2x0 = as.numeric(DescTools::Quantile(X1[,2],weights = w1x0, probs = u))
library(Hmisc)
T2x0 = as.numeric(Hmisc::wtd.quantile(X1[,2],weights = w1x0, probs = u, normwt = TRUE))
return(c(x=h,y=T2x0))
}
V=Vectorize(Transp2x0)(rep(1e5,5000))
# vh = c(1,.5,.2,.1,.05,.01,.005)
# T2 = Vectorize(Transp2x0)(vh)
plot(V[1,],V[2,],cex=.5, col=scales::alpha(couleur[3],.4),
       xlab="Size of neighborhood (bandwidth)",
       ylab="Transported value, Gaussian kernel",
     ylim=c(2,2.4))
abline(h = T2x0, lty=2, col="darkred")
library(mgcv)
base = data.frame(x=V[1,],y=V[2,])
reg = mgcv::gam(y~s(x),data=base)
nbase = data.frame(x = (1:100)/100)
p <- predict(reg, newdata = nbase, type = "link", se.fit = TRUE)
# upr <- p$fit + (2 * p$se.fit)
# lwr <- p$fit - (2 * p$se.fit)
# lines(nbase$x,upr,col=couleur[3])
# lines(nbase$x,lwr,col=couleur[3])
lines(nbase$x,p$fit,col=couleur[3],lwd=5)

library(mvtnorm)
Transp2x0 = function(n=1e3){
  h=.0001+runif(1)
X0 = mnormt::rmnorm(n, M0, S0)
X1 = mnormt::rmnorm(n, M1, S1)
u = mean(X0[,1]<=x0[1])
T1x0 = as.numeric(quantile(X1[,1],u))
w0x0=(abs(X0[,1]-x0[1])<(h))*1
w0x0=w0x0/sum(w0x0)
w1x0=(abs(X1[,1]-T1x0)<h)*1
w1x0=w1x0/sum(w1x0)
u = weighted.mean(X0[,2]<=x0[2],w0x0)
# T2x0 = as.numeric(DescTools::Quantile(X1[,2],weights = w1x0, probs = u))
library(Hmisc)
T2x0 = as.numeric(Hmisc::wtd.quantile(X1[,2],weights = w1x0, probs = u, normwt = TRUE))
return(c(x=h,y=T2x0))
}
V=Vectorize(Transp2x0)(rep(1e5,5000))
# vh = c(1,.5,.2,.1,.05,.01,.005)
# T2 = Vectorize(Transp2x0)(vh)
plot(V[1,],V[2,],cex=.5, col=scales::alpha(couleur[3],.4),
       xlab="Size of neighborhood (bandwidth)",
       ylab="Transported value, Uniform kernel",
      ylim=c(2,2.4))
     #ylim=c(1.45,1.8))
abline(h = T2x0, lty=2, col="darkred")
library(mgcv)
base = data.frame(x=V[1,],y=V[2,])
reg = mgcv::gam(y~s(x),data=base)
nbase = data.frame(x = (1:100)/100)
p <- predict(reg, newdata = nbase, type = "link", se.fit = TRUE)
# upr <- p$fit + (2 * p$se.fit)
# lwr <- p$fit - (2 * p$se.fit)
# lines(nbase$x,upr,col=couleur[3])
# lines(nbase$x,lwr,col=couleur[3])
lines(nbase$x,p$fit,col=couleur[3],lwd=5)
```
