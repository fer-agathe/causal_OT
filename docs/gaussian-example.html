<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; Gaussian Example â€“ Sequential Transport for Causal Mediation Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./gaussian-example-mc.html" rel="next">
<link href="./functions.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea4e51666191dd6ded9f775c5bce66c9.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-e845f871f76c909dd0a2a1d88316b656.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cb634faf95f4fcf0c327d115ec3f3fb3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-273aab03a32095346a75c1f293c006aa.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	   MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';


		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
		 
		 MathJax.Extension["TeX/color"].colors["colA"] = '#ffdd55';
		 MathJax.Extension["TeX/color"].colors["colB"] = '#944edf';
		 MathJax.Extension["TeX/color"].colors["colC"] = '#3fb3b2';
		 
		 MathJax.Extension["TeX/color"].colors["col0"] = '#7F170E';
		 MathJax.Extension["TeX/color"].colors["col1"] = '#1b95e0';
	});
</script>
<script>
MathJax = {
  loader: {
    load: ['[tex]/boldsymbol']
  },
  tex: {
    tags: "all",
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    packages: {
      '[+]': ['boldsymbol']
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Sequential Transport for Causal Mediation Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fer-agathe/causal_OT"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./gaussian-example.html">II. A Gaussian Example</a></li><li class="breadcrumb-item"><a href="./gaussian-example.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gaussian Example</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">I. Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reminders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Reminders and Definitions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Miscellaneous functions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Functions for Sequential Transport</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">II. A Gaussian Example</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-example.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gaussian Example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-example-mc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Monte Carlo Simulations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">III. Counterfactuals for Categorical Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-objectives.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Objectives</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-coupling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Random Matching</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-discrete.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimal Transport on Label-Encoded Variables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-transport.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Transport on Simplex</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-small-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Small Example</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">IV. Transport with Weights</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transport-gaussian-local-weights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Gaussian Conditional Univariate Transport with Local Weights</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">V. Experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./xp-simulated.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulated Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./xp-compas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Compas</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-dgp" id="toc-sec-dgp" class="nav-link active" data-scroll-target="#sec-dgp"><span class="header-section-number">5.1</span> Data Generating Process</a></li>
  <li><a href="#sec-cf" id="toc-sec-cf" class="nav-link" data-scroll-target="#sec-cf"><span class="header-section-number">5.2</span> Counterfactuals</a>
  <ul class="collapse">
  <li><a href="#sec-cf-ot" id="toc-sec-cf-ot" class="nav-link" data-scroll-target="#sec-cf-ot"><span class="header-section-number">5.2.1</span> Optimal Transport</a></li>
  <li><a href="#sec-cf-tmatch" id="toc-sec-cf-tmatch" class="nav-link" data-scroll-target="#sec-cf-tmatch"><span class="header-section-number">5.2.2</span> Transport-based Many-to-1 Matching</a></li>
  <li><a href="#sec-cf-sm" id="toc-sec-cf-sm" class="nav-link" data-scroll-target="#sec-cf-sm"><span class="header-section-number">5.2.3</span> Soft Matching</a></li>
  <li><a href="#sec-cf-skh" id="toc-sec-cf-skh" class="nav-link" data-scroll-target="#sec-cf-skh"><span class="header-section-number">5.2.4</span> Entropic Regularization via Sinkhorn Algorithm</a></li>
  <li><a href="#sec-cf-sot" id="toc-sec-cf-sot" class="nav-link" data-scroll-target="#sec-cf-sot"><span class="header-section-number">5.2.5</span> Sequential Transport</a></li>
  <li><a href="#illustration-for-a-single-unit" id="toc-illustration-for-a-single-unit" class="nav-link" data-scroll-target="#illustration-for-a-single-unit"><span class="header-section-number">5.2.6</span> Illustration for a Single Unit</a></li>
  </ul></li>
  <li><a href="#sec-causal-effects" id="toc-sec-causal-effects" class="nav-link" data-scroll-target="#sec-causal-effects"><span class="header-section-number">5.3</span> Causal Effect</a>
  <ul class="collapse">
  <li><a href="#with-causal-mediation-analysis" id="toc-with-causal-mediation-analysis" class="nav-link" data-scroll-target="#with-causal-mediation-analysis"><span class="header-section-number">5.3.1</span> With Causal Mediation Analysis</a></li>
  <li><a href="#with-optimal-transport" id="toc-with-optimal-transport" class="nav-link" data-scroll-target="#with-optimal-transport"><span class="header-section-number">5.3.2</span> With Optimal Transport</a></li>
  <li><a href="#with-transport-based-matching" id="toc-with-transport-based-matching" class="nav-link" data-scroll-target="#with-transport-based-matching"><span class="header-section-number">5.3.3</span> With Transport-based Matching</a></li>
  <li><a href="#with-entropic-regularization" id="toc-with-entropic-regularization" class="nav-link" data-scroll-target="#with-entropic-regularization"><span class="header-section-number">5.3.4</span> With Entropic Regularization</a></li>
  <li><a href="#with-sequential-optimal-transport" id="toc-with-sequential-optimal-transport" class="nav-link" data-scroll-target="#with-sequential-optimal-transport"><span class="header-section-number">5.3.5</span> With Sequential Optimal Transport</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">5.3.6</span> Summary</a></li>
  <li><a href="#some-individuals" id="toc-some-individuals" class="nav-link" data-scroll-target="#some-individuals"><span class="header-section-number">5.3.7</span> Some Individuals</a></li>
  </ul></li>
  <li><a href="#monte-carlo-simulations" id="toc-monte-carlo-simulations" class="nav-link" data-scroll-target="#monte-carlo-simulations"><span class="header-section-number">5.4</span> Monte-Carlo Simulations</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./gaussian-example.html">II. A Gaussian Example</a></li><li class="breadcrumb-item"><a href="./gaussian-example.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gaussian Example</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-motivation-gaussian" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gaussian Example</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we generate a binary treatment <span class="math inline">\(a\in\{0,1\}\)</span> (assigned in a well-balances manner) which affects two mediators, <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>, as well as an outcome <span class="math inline">\(y\)</span>. The outcome is generated according to a linear model. We then compute causal effects using different methods (causal mediation analysis, as well as transport-based methods).</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tikzDevice)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mnormt)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fairadapt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes for graphical parameters</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extrafont, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>col_group <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#00A08A"</span>,<span class="st">"#F2AD00"</span>, <span class="st">"#1b95e0"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>colour_methods <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"OT"</span> <span class="ot">=</span> <span class="st">"#CC79A7"</span>, <span class="st">"OT-M"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"skh"</span> <span class="ot">=</span> <span class="st">"darkgray"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seq_1"</span> <span class="ot">=</span> <span class="st">"#0072B2"</span>, <span class="st">"seq_2"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fairadapt"</span> <span class="ot">=</span> <span class="st">"#9966FF"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>colGpe1 <span class="ot">&lt;-</span> col_group[<span class="dv">2</span>]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>colGpe0 <span class="ot">&lt;-</span> col_group[<span class="dv">1</span>]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>colGpet <span class="ot">&lt;-</span> col_group[<span class="dv">3</span>]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"pdf"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>font_size <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>font_family <span class="ot">&lt;-</span> <span class="st">"CMU Serif"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">"./figs/"</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(path)) <span class="fu">dir.create</span>(path)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../scripts/utils.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><span class="math display">\[
\definecolor{wongBlack}{RGB}{0,0,0}
\definecolor{wongGold}{RGB}{230, 159, 0}
\definecolor{wongLightBlue}{RGB}{86, 180, 233}
\definecolor{wongGreen}{RGB}{0, 158, 115}
\definecolor{wongYellow}{RGB}{240, 228, 66}
\definecolor{wongBlue}{RGB}{0, 114, 178}
\definecolor{wongOrange}{RGB}{213, 94, 0}
\definecolor{wongPurple}{RGB}{204, 121, 167}
\definecolor{colGpe1}{RGB}{0, 160, 138}
\definecolor{colGpe0}{RGB}{242, 173, 0}
\]</span></p>
<section id="sec-dgp" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="sec-dgp"><span class="header-section-number">5.1</span> Data Generating Process</h2>
<p>We want to simulate potential outcomes in a binary treatment setting, with covariate shift between treatment groups.</p>
<p>Let <span class="math inline">\(n=500\)</span> denote the number of individuals (or unit), and let <span class="math inline">\(\boldsymbol{X}=(X_1,X_2)\)</span> be drawn from bivariate normal distrubtions whose mean vectors and covariance matrices depend on the treatment assignment <span class="math inline">\(A\in\{0,1\}\)</span>.</p>
<p>For <span style="color: #00A08A;">untreated individuals</span> (<span class="math inline">\(A=\color{colGpe0}0\)</span>) the covariates <span class="math inline">\(\boldsymbol{X}^{(0)} = (X_1{(0)}, X_2{(0)})\)</span> are sampled from a <span class="math inline">\(\mathcal{N}(\mu_0, \Sigma_0)\)</span>, where <span class="math inline">\(\mu_0 = -1\)</span>, <span class="math inline">\(\Sigma_0 = \begin{pmatrix} 1 &amp; r_0 \\ r_0 &amp; 1 \end{pmatrix}\)</span> with <span class="math inline">\(r_0 = 0.7\)</span>.</p>
<p>For <span style="color: #F2AD00;">treated individuals</span> (<span class="math inline">\(A=\color{colGpe1}1\)</span>), covariates <span class="math inline">\(\boldsymbol{X}{(1)} = (X_1{(1)}, X_2{(1)})\)</span> follow a <span class="math inline">\(\mathcal{N}(\mu_1, \Sigma_1)\)</span>, where <span class="math inline">\(\mu_1 = +1\)</span>, <span class="math inline">\(\Sigma_1 = \begin{pmatrix} 1 &amp; r_1 \\ r_1 &amp; 1 \end{pmatrix}\)</span> with <span class="math inline">\(r_1 = -0.5\)</span>.</p>
<p>The treatment assignment <span class="math inline">\(A\)</span> is randomized with probability <span class="math inline">\(p_1 = 0.5\)</span>.</p>
<p>The potential outcomes are linear functions of the covariates: <span class="math display">\[
\begin{aligned}
Y(0) &amp;= a_1 X_1 + a_2 X_2 + \varepsilon,\\
Y(1) &amp;= a_1 X_1 + a_2 X_2 + a_0 + \varepsilon .
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\varepsilon \sim \mathcal{N}(0, 1)\)</span> and <span class="math inline">\(a_0 = 3\)</span>, <span class="math inline">\(a_1 = 2\)</span>, <span class="math inline">\(a_2 = -1.5\)</span>.</p>
<p>The observed outcome is <span class="math display">\[Y = A \cdot Y(1) + (1 - A) \cdot Y(0).\]</span></p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Natural Indirect Effect
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, with the current DGP, we have: <span class="math display">\[
\begin{cases}
  \delta_i(0) = a_1(X_{1,i}(1) - X_{1,i}(0)) + a_2(X_{2,i}(1)-X_{2,i}(0))\\
  \delta_i(1) = a_1(X_{1,i}(1) - X_{1,i}(0)) + a_2(X_{2,i}(1)-X_{2,i}(0))
\end{cases}
\]</span></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Average Natural Indirect Effect
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we have:</p>
<p><span class="math display">\[
\begin{cases}
  \bar{\delta}(0) = (a_1+a2)(\mu_1-\mu_0)\\
  \bar{\delta}(1) = (a_1+a2)(\mu_1-\mu_0)
\end{cases}
\]</span></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Natural Direct Effect
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we have:</p>
<p><span class="math display">\[
\begin{cases}
  \zeta_i{(0)} = a_0\\
  \zeta_i{(1)} = a_0\\
\end{cases}
\]</span></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Total Causal Effect
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we have:</p>
<p><span class="math display">\[
\tau_i = a_1(X_{1,i}(1) - X_{1,i}(0)) + a_2(X_{2,i}(1)-X_{2,i}(0)) + a_0
\]</span> and</p>
<p><span class="math display">\[
\bar{\delta}=(a_1+a_2)(\mu_1-\mu_0) + a0
\]</span></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>mu1 <span class="ot">&lt;-</span> <span class="sc">+</span><span class="dv">1</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>r0 <span class="ot">&lt;-</span> <span class="sc">+</span>.<span class="dv">7</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>r1 <span class="ot">&lt;-</span> <span class="sc">-</span>.<span class="dv">5</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>a0 <span class="ot">&lt;-</span>  <span class="dv">3</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span>  <span class="dv">2</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>a2 <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fl">1.5</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu0, <span class="dv">2</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu1, <span class="dv">2</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw covariates</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">rmnorm</span>(n, <span class="at">mean =</span> a <span class="sc">*</span> Mu0, <span class="at">varcov =</span> Sig0)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">rmnorm</span>(n, <span class="at">mean =</span> a <span class="sc">*</span> Mu1, <span class="at">varcov =</span> Sig1)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Random noise</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Binary treatment</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> p1, p1))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> X0</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>X[A<span class="sc">==</span><span class="dv">1</span>, ] <span class="ot">=</span> X1[A<span class="sc">==</span><span class="dv">1</span>, ]</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> X[, <span class="dv">1</span>],</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> X[, <span class="dv">2</span>],</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> A,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y0 =</span> a1 <span class="sc">*</span> X1 <span class="sc">+</span> a2 <span class="sc">*</span> X2 <span class="sc">+</span> E,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y1 =</span> a1 <span class="sc">*</span> X1 <span class="sc">+</span> a2 <span class="sc">*</span> X2 <span class="sc">+</span> a0 <span class="sc">+</span> E,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> A <span class="sc">*</span> Y1 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A) <span class="sc">*</span> Y0</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We define a function to wrap this DGP.</p>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">gen_data</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n Number of units.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mu0 Mean of the two covariates in group 0.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mu1 Mean of the two covariates in group 1.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param r0 Covariance of the two covariates in group 0.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param r1 Covariance of the two covariates in group 1.</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @parma a Shift parameter for the mean in both groups</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'  (default to 1: no shift). Larger values decreases overlapping.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>gen_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">500</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu0 =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mu1 =</span> <span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">r0 =</span> <span class="sc">+</span>.<span class="dv">7</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">r1 =</span> <span class="sc">-</span>.<span class="dv">5</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">a =</span> <span class="dv">1</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  a0 <span class="ot">&lt;-</span>  <span class="dv">3</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  a1 <span class="ot">&lt;-</span>  <span class="dv">2</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  a2 <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fl">1.5</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu0, <span class="dv">2</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(mu1, <span class="dv">2</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw covariates</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  X0 <span class="ot">&lt;-</span> <span class="fu">rmnorm</span>(n, <span class="at">mean =</span> a <span class="sc">*</span> Mu0, <span class="at">varcov =</span> Sig0)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  X1 <span class="ot">&lt;-</span> <span class="fu">rmnorm</span>(n, <span class="at">mean =</span> a <span class="sc">*</span> Mu1, <span class="at">varcov =</span> Sig1)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Random noise</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Binary treatment</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span> <span class="sc">-</span> p1, p1))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> X0</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  X[A<span class="sc">==</span><span class="dv">1</span>, ] <span class="ot">=</span> X1[A<span class="sc">==</span><span class="dv">1</span>, ]</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> X[, <span class="dv">1</span>],</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2 =</span> X[, <span class="dv">2</span>],</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> A,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y0 =</span> a1 <span class="sc">*</span> X1 <span class="sc">+</span> a2 <span class="sc">*</span> X2 <span class="sc">+</span> E,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y1 =</span> a1 <span class="sc">*</span> X1 <span class="sc">+</span> a2 <span class="sc">*</span> X2 <span class="sc">+</span> a0 <span class="sc">+</span> E,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> A <span class="sc">*</span> Y1 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>A) <span class="sc">*</span> Y0</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-cf" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="sec-cf"><span class="header-section-number">5.2</span> Counterfactuals</h2>
<p>Let us build counterfactuals for individuals from <span style="color: #00A08A;">group 0</span>, and for individuals from <span style="color: #F2AD00;">group 1</span>. We will consider the following methods:</p>
<ul>
<li>Multivariate Optimal Transport (since we know the parameters of the two Gaussians),</li>
<li>Regularized transport using Sinkhorn algorithm,</li>
<li>Sequential Optimal Transport.</li>
</ul>
<section id="sec-cf-ot" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="sec-cf-ot"><span class="header-section-number">5.2.1</span> Optimal Transport</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(expm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Given two collection of points <span class="math inline">\(\{\boldsymbol{x}_{0,1},\cdots,\boldsymbol{x}_{0,n_0}\}\)</span> and <span class="math inline">\(\{\boldsymbol{x}_{1,1},\cdots,\boldsymbol{x}_{1,n_1}\}\)</span> in <span class="math inline">\(\mathcal{X}_0\)</span> and <span class="math inline">\(\mathcal{X}_1\)</span>, and a cost <span class="math inline">\(c:\mathcal{X}_0\times\mathcal{X}_1\to\mathbb{R}_+\)</span>, define the cost matrix, <span class="math inline">\(n_0\times n_1\)</span>, <span class="math inline">\(\boldsymbol{C}:=[C_{i,j}]\)</span> where <span class="math inline">\(C_{i,j}=c(\boldsymbol{x}_{0,i},\boldsymbol{x}_{1,j})\)</span>. The optimal matching problem is [ <em>{(</em>{n_0},<em>{n_1})} ,,,,, =</em>{i=1}^{n_0}<em>{j=1}^{n_1}P</em>{ij},C_{ij}, ] where <span class="math inline">\(\mathcal{U}(\boldsymbol{1}_{n_0},\boldsymbol{1}_{n_1})\)</span> is the polytope [ {,P<em>+^{n_0n_1}: P,</em>{n_1}=,&nbsp; P^_{n_0}= }. ]</p>
<p>Here, in the Gaussian case, the optimal transport map <span class="math inline">\(T(x)\)</span> from <span class="math inline">\(\mathcal{N}(\boldsymbol{\mu}_0, \boldsymbol{\Sigma}_0)\)</span> to <span class="math inline">\(\mathcal{N}(\boldsymbol{\mu}_1, \boldsymbol{\Sigma}_1)\)</span> is: <span class="math display">\[T(x) = \boldsymbol{\mu}_1 + \boldsymbol{A}(x - \boldsymbol{\mu}_0)\]</span> where: <span class="math display">\[
\boldsymbol{A} = \boldsymbol{\Sigma}_0^{1/2}
       \left( \boldsymbol{\Sigma}_0^{1/2} \boldsymbol{\Sigma}_1 \boldsymbol{\Sigma}_0^{1/2} \right)^{-1/2}
      \boldsymbol{\Sigma}_0^{1/2}
\]</span></p>
<p>We define the function <code class="sourceCode r"><span class="fu">compute_ot_map</span>()</code> to compute the optimal mapping.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Optimal transport mapping between two Gaussian distributions </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'  (from \eqn{\mathcal{N}(\mu_{\text{source}}, \Sigma_{\text{source}})} to </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{\mathcal{N}(\mu_{\text{target}}, \Sigma_{\text{target}})})</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'  </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mu_source Mean vector of the source Gaussian.</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sigma_source Covariance matrix of the source Gaussian.</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mu_target Mean vector of the target Gaussian.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sigma_target Covariance matrix of the target Gaussian.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>compute_ot_map <span class="ot">&lt;-</span> <span class="cf">function</span>(mu_source, sigma_source, mu_target, sigma_target) {</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  sqrt_sigma_source <span class="ot">&lt;-</span> <span class="fu">sqrtm</span>(sigma_source)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  sqrt_sigma_source_inv <span class="ot">&lt;-</span> <span class="fu">solve</span>(sqrt_sigma_source)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  inner <span class="ot">&lt;-</span> sqrt_sigma_source <span class="sc">%*%</span> sigma_target <span class="sc">%*%</span> sqrt_sigma_source</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  sqrt_inner <span class="ot">&lt;-</span> <span class="fu">sqrtm</span>(inner)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> sqrt_sigma_source_inv <span class="sc">%*%</span> sqrt_inner <span class="sc">%*%</span> sqrt_sigma_source_inv</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">A =</span> A, <span class="at">shift =</span> mu_target <span class="sc">-</span> A <span class="sc">%*%</span> mu_source)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also define the <code class="sourceCode r"><span class="fu">apply_ot_transport</span>()</code> function which uses a transport plan to transport individuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Function to apply the transport map to simulated data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X Observations to transport.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mapping Optimal transport mapping (from `compute_ot_map()`)?</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>apply_ot_transport <span class="ot">&lt;-</span> <span class="cf">function</span>(X, mapping) {</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> mapping<span class="sc">$</span>A</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  shift <span class="ot">&lt;-</span> mapping<span class="sc">$</span>shift</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">apply</span>(X, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">as.vector</span>(shift <span class="sc">+</span> A <span class="sc">%*%</span> x)))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we generated the data, we know the exact transport plan to transport individuals from <span style="color: #00A08A;">group 0</span> to <span style="color: #F2AD00;">group 1</span>. We also know the exact transport plan to transport individuals from <span style="color: #F2AD00;">group 1</span> to <span style="color: #00A08A;">group 0</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>Sigma0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Sigma1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mapping from group 0 to group 1</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>ot_map_0_to_1 <span class="ot">&lt;-</span> <span class="fu">compute_ot_map</span>(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu_source =</span> Mu0, <span class="at">sigma_source =</span> Sigma0, </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu_target =</span> Mu1, <span class="at">sigma_target =</span> Sigma1</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Mapping from group 1 to group 0</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>ot_map_1_to_0 <span class="ot">&lt;-</span> <span class="fu">compute_ot_map</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu_source =</span> Mu1, <span class="at">sigma_source =</span> Sigma1, </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu_target =</span> Mu0, <span class="at">sigma_target =</span> Sigma0</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We apply the transport map to the <span style="color: #00A08A;">untreated units</span> (A = 0).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>X0_t <span class="ot">&lt;-</span> <span class="fu">apply_ot_transport</span>(<span class="at">X =</span> X0, <span class="at">mapping =</span> ot_map_0_to_1)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X0_t) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And to the transport map to the <span style="color: #F2AD00;">treated units</span> (A = 1).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>X1_t <span class="ot">&lt;-</span> <span class="fu">apply_ot_transport</span>(<span class="at">X =</span> X1, <span class="at">mapping =</span> ot_map_1_to_0)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X1_t) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us visualize the transported individuals. First, we define the function <code class="sourceCode r"><span class="fu">draw_ellipse</span>()</code> which will allow us to plot the 95% confidence ellipse in both groups.</p>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">draw_ellipse</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>draw_ellipse <span class="ot">&lt;-</span> <span class="cf">function</span>(mu, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                         sigma, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">col =</span> <span class="st">"black"</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lty =</span> <span class="dv">1</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lwd =</span> <span class="dv">1</span>, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">level =</span> <span class="fl">0.95</span>, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                         ...) {</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  angles <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> pi, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  vals <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">qchisq</span>(level, <span class="at">df =</span> <span class="dv">2</span>)) <span class="sc">*</span> <span class="fu">t</span>(<span class="fu">chol</span>(sigma)) <span class="sc">%*%</span> <span class="fu">rbind</span>(<span class="fu">cos</span>(angles), <span class="fu">sin</span>(angles)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(mu[<span class="dv">1</span>] <span class="sc">+</span> vals[<span class="dv">1</span>, ], mu[<span class="dv">2</span>] <span class="sc">+</span> vals[<span class="dv">2</span>, ], <span class="at">col =</span> col, <span class="at">lty =</span> lty, <span class="at">lwd =</span> lwd, ...)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We isolate the observations from <span style="color: #00A08A;">group 0</span> and from <span style="color: #F2AD00;">group 1</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for the plot</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The initial points and the <span style="color: #1b95e0;">transported values</span> are shown in <a href="#fig-gaussian-ot" class="quarto-xref">Figure&nbsp;<span>5.1</span></a></p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X0, </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"OT: from A=0 to A=1"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">family =</span> font_family</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_t, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1, <span class="at">y0 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_t[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_t[, <span class="dv">2</span>],</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># True mean and covariance (scaled by 'a')</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance of transported points (via OT map)</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>Sigma0_transport <span class="ot">&lt;-</span> ot_map_0_to_1<span class="sc">$</span>A <span class="sc">%*%</span> Sig0 <span class="sc">%*%</span> <span class="fu">t</span>(ot_map_0_to_1<span class="sc">$</span>A)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sigma0_transport, <span class="at">col =</span> colGpet, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co"># From 1 to 0</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"OT: from A=1 to A=0"</span>,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1_t, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X1<span class="sc">$</span>X1, <span class="at">y0 =</span> X1<span class="sc">$</span>X2,</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X1_t[, <span class="dv">1</span>], <span class="at">y1 =</span> X1_t[, <span class="dv">2</span>],</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance of transported points (via OT map)</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>Sigma0_transport <span class="ot">&lt;-</span> ot_map_1_to_0<span class="sc">$</span>A <span class="sc">%*%</span> Sig1 <span class="sc">%*%</span> <span class="fu">t</span>(ot_map_1_to_0<span class="sc">$</span>A)</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sigma0_transport, <span class="at">col =</span> colGpet, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-ot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-ot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: 500 points in each group drawn from bivariates Gaussian distributions and <span style="color:#1b95e0;">transported values</span> from <span style="color:#00A08A;">group 0</span> to <span style="color:#F2AD00;">group 1</span> (left), and from <span style="color:#F2AD00;">group 1</span> to <span style="color:#00A08A;">group 0</span> (right), using optimal transport.
</figcaption>
<div aria-describedby="fig-gaussian-ot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-ot-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-cf-tmatch" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="sec-cf-tmatch"><span class="header-section-number">5.2.2</span> Transport-based Many-to-1 Matching</h3>
<p>Let us use optimal transport to perform transport-based optimal many-to-1 matching. We use optimal transport with a uniform source and target distribution. For each unit from the source group (group~0), we select the matched unit from the target group (group~1) as the one wit the maximum transported mass. This way, each unit in the source is matched to exactly one in the target.</p>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">transport_many_to_one</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_source Source characteristics</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_target Target characteristics</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method Algorithm to use for transport</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>transport_many_to_one <span class="ot">&lt;-</span> <span class="cf">function</span>(X_source, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                  X_target, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">method =</span> <span class="st">"shortsimplex"</span>) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  n_source <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_source)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  n_target <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_target)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uniform weights</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  w_source <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_source, n_source)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  w_target <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_target, n_target)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cost matrix</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(X_source, X_target)))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> cost[<span class="dv">1</span><span class="sc">:</span>n_source, (n_source <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_source <span class="sc">+</span> n_target)]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solve OT plan</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  ot_plan <span class="ot">&lt;-</span> transport<span class="sc">::</span><span class="fu">transport</span>(</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    w_source, w_target, <span class="at">costm =</span> cost, <span class="at">method =</span> method</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each source unit, select the target with the highest mass</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  best_match <span class="ot">&lt;-</span> ot_plan <span class="sc">|&gt;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(from) <span class="sc">|&gt;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice_max</span>(mass, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matched matrix</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  X_matched <span class="ot">&lt;-</span> X_target[best_match<span class="sc">$</span>to, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  X_matched</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let us apply the <code class="sourceCode r"><span class="fu">transport_many_to_one</span>()</code> function to get the counterfactuals in both group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>X0_tmatch <span class="ot">&lt;-</span> <span class="fu">transport_many_to_one</span>(<span class="at">X_source =</span> X0, <span class="at">X_target =</span> X1)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>X1_tmatch <span class="ot">&lt;-</span> <span class="fu">transport_many_to_one</span>(<span class="at">X_source =</span> X1, <span class="at">X_target =</span> X0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Matching: from A=0 to A=1"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_tmatch, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0[, <span class="st">"X1"</span>], <span class="at">y0 =</span> X0[, <span class="st">"X2"</span>],</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_tmatch[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_tmatch[, <span class="dv">2</span>],</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co"># From 1 to 0</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Matching: from A=1 to A=0"</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1_tmatch, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X1[, <span class="st">"X1"</span>], <span class="at">y0 =</span> X1[, <span class="st">"X2"</span>],</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X1_tmatch[, <span class="dv">1</span>], <span class="at">y1 =</span> X1_tmatch[, <span class="dv">2</span>],</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-tmatch" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-tmatch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: 500 points in each group drawn from bivariates Gaussian distributions and <span style="color:#1b95e0;">transported values</span> from <span style="color:#00A08A;">group 0</span> to <span style="color:#F2AD00;">group 1</span> (left), and from <span style="color:#F2AD00;">group 1</span> to <span style="color:#00A08A;">group 0</span> (right), using transport-based many-to-one matching.
</figcaption>
<div aria-describedby="fig-gaussian-tmatch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-tmatch-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-cf-sm" class="level3" data-number="5.2.3">
<h3 data-number="5.2.3" class="anchored" data-anchor-id="sec-cf-sm"><span class="header-section-number">5.2.3</span> Soft Matching</h3>
<p>Let us now turn to optimal transportâ€“based matching where each unit is matched to a weighted combination of units in the other group. This allows us to produce synthetic treated units by assigning weights that sum to 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>n_0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X0)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>n_1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us use uniform weights:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>w_0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_0, n_0)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>w_1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_1, n_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use the Euclidean distance between units as costs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cost <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(X0, X1)))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>cost <span class="ot">&lt;-</span> cost[<span class="dv">1</span><span class="sc">:</span>n_0, (n_0 <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_0 <span class="sc">+</span> n_1)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us solve the optimal transport problem to transport units from group~0 to group~1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ot_plan <span class="ot">&lt;-</span> transport<span class="sc">::</span><span class="fu">transport</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  w_0, w_1, <span class="at">costm =</span> cost, <span class="at">method =</span> <span class="st">"shortsimplex"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use the mapping to create synthetic individuals in group~1. We use the weights given in the mapping to create the synthetic units as fractions of the other points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ot_plan <span class="ot">&lt;-</span> ot_plan <span class="sc">|&gt;</span> <span class="fu">group_by</span>(from) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">weight =</span> mass <span class="sc">/</span> <span class="fu">sum</span>(mass))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>assignment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_0)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>X0_sm <span class="ot">&lt;-</span> ot_plan <span class="sc">|&gt;</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(X1) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">to =</span> <span class="fu">row_number</span>()),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"to"</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">colnames</span>(X1), <span class="sc">~</span>.x <span class="sc">*</span> weight)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(from) <span class="sc">|&gt;</span> </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">colnames</span>(X1), <span class="sc">~</span> <span class="fu">sum</span>(.x))) <span class="sc">|&gt;</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(from) <span class="sc">|&gt;</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>from) <span class="sc">|&gt;</span> </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us create a function, <code class="sourceCode r"><span class="fu">soft_match</span>()</code> to wrap-up the previous codes.</p>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">soft_match</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_source Source characteristics</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_target Target characteristics</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method Algorithm to use for transport</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>soft_match <span class="ot">&lt;-</span> <span class="cf">function</span>(X_source, </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                       X_target, </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method =</span> <span class="st">"shortsimplex"</span>) {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  n_source <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_source)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  n_target <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_target)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uniform weights</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  w_source <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_source, n_source)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  w_target <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_target, n_target)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute cost matrix (Euclidean distances)</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(X_source, X_target)))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  cost <span class="ot">&lt;-</span> cost[<span class="dv">1</span><span class="sc">:</span>n_source, (n_source <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_source <span class="sc">+</span> n_target)]</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solve OT problem</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  ot_plan <span class="ot">&lt;-</span> transport<span class="sc">::</span><span class="fu">transport</span>(</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    w_source, w_target, <span class="at">costm =</span> cost, <span class="at">method =</span> method</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize weights per source unit</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  ot_plan <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(ot_plan, from)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  ot_plan <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(ot_plan, <span class="at">weight =</span> mass <span class="sc">/</span> <span class="fu">sum</span>(mass))</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build transported covariates</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  X_target_tbl <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(X_target) <span class="sc">|&gt;</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">to =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  X_sm <span class="ot">&lt;-</span> ot_plan <span class="sc">|&gt;</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(X_target_tbl, <span class="at">by =</span> <span class="st">"to"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="fu">colnames</span>(X_target), <span class="sc">~</span> .x <span class="sc">*</span> weight)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(from) <span class="sc">|&gt;</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="fu">colnames</span>(X_target), sum),</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(from) <span class="sc">|&gt;</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>from) <span class="sc">|&gt;</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  X_sm</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let us do soft-matching to get counterfactuals for units from both group 0 and group 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>X0_sm <span class="ot">&lt;-</span> <span class="fu">soft_match</span>(<span class="at">X_source =</span> X0 , <span class="at">X_target =</span> X1)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>X1_sm <span class="ot">&lt;-</span> <span class="fu">soft_match</span>(<span class="at">X_source =</span> X1 , <span class="at">X_target =</span> X0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"SM: from A=0 to A=1"</span>,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_sm, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0[, <span class="st">"X1"</span>], <span class="at">y0 =</span> X0[, <span class="st">"X2"</span>],</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_sm[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_sm[, <span class="dv">2</span>],</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co"># From 1 to 0</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"SM: from A=1 to A=0"</span>,</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1_sm, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X1[, <span class="st">"X1"</span>], <span class="at">y0 =</span> X1[, <span class="st">"X2"</span>],</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X1_sm[, <span class="dv">1</span>], <span class="at">y1 =</span> X1_sm[, <span class="dv">2</span>],</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-sm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-sm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: 500 points in each group drawn from bivariates Gaussian distributions and <span style="color:#1b95e0;">transported values</span> from <span style="color:#00A08A;">group 0</span> to <span style="color:#F2AD00;">group 1</span> (left), and from <span style="color:#F2AD00;">group 1</span> to <span style="color:#00A08A;">group 0</span> (right), using soft matching.
</figcaption>
<div aria-describedby="fig-gaussian-sm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-sm-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-cf-skh" class="level3" data-number="5.2.4">
<h3 data-number="5.2.4" class="anchored" data-anchor-id="sec-cf-skh"><span class="header-section-number">5.2.4</span> Entropic Regularization via Sinkhorn Algorithm</h3>
<p>The optimal transport problem can be computationally intensive (not here with the small amount of observations, though). In such cases, one can consider Entropic regularization via Sinkhorn algorithm, associated to the â€œMatrix Scaling Problemâ€ in <span class="citation" data-cites="sinkhorn1962factor">Sinkhorn (<a href="references.html#ref-sinkhorn1962factor" role="doc-biblioref">1962</a>)</span>. Entropic regularization modifies the previous problem by adding a Kullback-Leibler divergence (<span class="math inline">\(\mathrm{d}_{\mathrm{KL}}\)</span>) term to the optimization goal <span id="eq-regularization"><span class="math display">\[
\min_{\boldsymbol{P}\in\mathcal{U}(\boldsymbol{1}_{n_0},\boldsymbol{1}_{n_1})}
\Big\lbrace \langle \boldsymbol{P},\boldsymbol{C}\rangle +\gamma\cdot \mathrm{d}_{\mathrm{KL}}(\boldsymbol{P}||{\boldsymbol{1}_{n_0}}\otimes{\boldsymbol{1}_{n_1}}) \Big\rbrace
\tag{5.1}\]</span></span> where the Kullback-Leibler divergence term corresponds to the opposite of the discrete entropy of the coupling matrix <span class="math inline">\(\boldsymbol{P}\)</span>, <span class="math display">\[
H(\boldsymbol{P}) := -\sum_{i,j}P_{i,j}(\log(P_{i,j}) - 1).
\]</span> see Proposition 4.3 in <span class="citation" data-cites="peyre2019computational">PeyrÃ© and Cuturi (<a href="references.html#ref-peyre2019computational" role="doc-biblioref">2019</a>)</span>.</p>
<p>Let us make sure that the observations are stored in matrices for each group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of observations in each group:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>n_0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X0)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>n_1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use uniform weights:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>w_0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_0, n_0)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>w_1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_1, n_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We compute the pairwise cost matrix, which is simply the squared Euclidean distance in this example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cost_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(X0, X1)))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> cost_mat[<span class="dv">1</span><span class="sc">:</span>n_0, (n_0 <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_0 <span class="sc">+</span> n_1)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can apply the Sinkhorn algorithm to solve the problem.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>skh_res <span class="ot">&lt;-</span> T4transport<span class="sc">::</span><span class="fu">sinkhornD</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> C, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">wx =</span> w_0, <span class="at">wy =</span> w_1, <span class="at">lambda =</span> <span class="fl">0.1</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We extract the transport plan:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ot_plan_skh <span class="ot">&lt;-</span> skh_res<span class="sc">$</span>plan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We normalize the plan:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>row_sums <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(ot_plan_skh)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ot_plan_skh <span class="ot">&lt;-</span> <span class="fu">sweep</span>(ot_plan_skh, <span class="dv">1</span>, row_sums, <span class="at">FUN =</span> <span class="st">"/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The transported version of <code>X_1</code> is the barycentric projection:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>X0_skh <span class="ot">&lt;-</span> ot_plan_skh <span class="sc">%*%</span> X1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We wrap these steps in a function, <code class="sourceCode r"><span class="fu">transport_regul</span>()</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">transport_regul</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_source Matrix of observations to transport from the source group.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X_target Matrix of observations from the target group.</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gamma A regularization parameter (default to 0.1).</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>transport_regul <span class="ot">&lt;-</span> <span class="cf">function</span>(X_source, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                            X_target, </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                            gamma) {</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  X_source <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X_source)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  X_target <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X_target)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  n_source <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_source)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  n_target <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_target)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uniform weights</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  w_source <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_source, n_source)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  w_target <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n_target, n_target)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pairwise squared Euclidean distance</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  cost_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(X_source, X_target)))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  C <span class="ot">&lt;-</span> cost_mat[<span class="dv">1</span><span class="sc">:</span>n_source, (n_source <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_source <span class="sc">+</span> n_target)]</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run Sinkhorn with entropic regularization gamma</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  skh_res <span class="ot">&lt;-</span> T4transport<span class="sc">::</span><span class="fu">sinkhornD</span>(</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">D =</span> C, <span class="at">p =</span> <span class="dv">2</span>, <span class="at">wx =</span> w_source, <span class="at">wy =</span> w_target, <span class="at">lambda =</span> gamma</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract and normalize plan</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  ot_plan_skh <span class="ot">&lt;-</span> skh_res<span class="sc">$</span>plan</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  ot_plan_skh <span class="ot">&lt;-</span> <span class="fu">sweep</span>(ot_plan_skh, <span class="dv">1</span>, <span class="fu">rowSums</span>(ot_plan_skh), <span class="at">FUN =</span> <span class="st">"/"</span>)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  ot_plan_skh <span class="sc">%*%</span> X_target</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We consider the following values for <span class="math inline">\(\gamma\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>gammas <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We transport the observations from group~0 to group~1:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>X0_skh_l <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  gammas, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span><span class="fu">transport_regul</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_source =</span> X0, </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_target =</span> X1, </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> .x</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(X0_skh_l) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(gammas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And from group~1 to group~0:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>X1_skh_l <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  gammas, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span><span class="fu">transport_regul</span>(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_source =</span> X1, </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_target =</span> X0, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> .x</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(X1_skh_l) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(gammas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We visualize the results in <a href="#fig-gaussian-regularization" class="quarto-xref">Figure&nbsp;<span>5.4</span></a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">seq_len</span>(<span class="fu">length</span>(gammas) <span class="sc">+</span> <span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># par(mar = c(2.1, 2.1, 2.1, 0.1), mfrow = c(1, 2))</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="do">## OT----</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X0, </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"OT: from A=0 to A=1"</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0[, <span class="st">"X1"</span>], <span class="at">y0 =</span> X0[, <span class="st">"X2"</span>],</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_t[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_t[, <span class="dv">2</span>],</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_t, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co"># True mean and covariance (scaled by 'a')</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="do">## OT with Entropic Regularization----</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (gamma <span class="cf">in</span> gammas) {</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>  X0_skh <span class="ot">&lt;-</span> X0_skh_l[[<span class="fu">as.character</span>(gamma)]]</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># From 0 to 1</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    X0, </span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="fu">paste0</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">gamma="</span>, gamma, <span class="st">"$"</span>))</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>)</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add arrows from original to transported</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrows</span>(</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">x0 =</span> X0[, <span class="st">"X1"</span>], <span class="at">y0 =</span> X0[, <span class="st">"X2"</span>],</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1 =</span> X0_skh[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_skh[, <span class="dv">2</span>],</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">points</span>(X0_skh[, <span class="st">"X1"</span>], X0_skh[, <span class="st">"X2"</span>], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True mean and covariance (scaled by 'a')</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>  Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>  Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>  Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>  Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add ellipses</span></span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-regularization" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-regularization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: 500 points in each group drawn from bivariates Gaussian distributions and <span style="color:#1b95e0;">transported values</span> from <span style="color:#00A08A;">group 0</span> to <span style="color:#F2AD00;">group 1</span>, using optimal transport (first panel) and using entropic regularization and Sinkhorn Algorithm with different values of the regularization parameter <span class="math inline">\(\gamma\)</span>.
</figcaption>
<div aria-describedby="fig-gaussian-regularization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-regularization-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-cf-sot" class="level3" data-number="5.2.5">
<h3 data-number="5.2.5" class="anchored" data-anchor-id="sec-cf-sot"><span class="header-section-number">5.2.5</span> Sequential Transport</h3>
<p>We will now transport individuals using sequential transport. The results are sensitive to the ordering within the sequence. We will consider both ordering to illustrate this.</p>
<ul>
<li>a first marginal univariate optimal transport along the first dimension (<span class="math inline">\(X_1\)</span>), then a conditional transport for the second dimension (<span class="math inline">\(X_2 \mid X_1)\)</span>: <code class="sourceCode r"><span class="fu">sequential_transport_12</span>()</code>,</li>
<li>a first marginal univariate optimal transport along the second dimension (<span class="math inline">\(X_2\)</span>), then a conditional transport for the first dimension (<span class="math inline">\(X_1 \mid X_2)\)</span>: <code class="sourceCode r"><span class="fu">sequential_transport_21</span>()</code>.</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">sequential_transport_12</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sequential transport from N(M_source, S_source) to N(M_target, S_target),</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' along X1, then X2 | X1</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X n x 2 matrix of source observations.</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param M_source Mean vector of the source distribution (length 2).</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param S_source Covariance matrix of the source distribution (2x2).</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param M_target Mean vector of the target distribution.</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param S_target Covariance matrix of the target distribution.</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>sequential_transport_12 <span class="ot">&lt;-</span> <span class="cf">function</span>(X, </span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                                    M_source, </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>                                    S_source, </span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>                                    M_target, </span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>                                    S_target) {</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># marginal univariate transport along the first coordinate (X_1)</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  T1x <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>(X[, <span class="dv">1</span>], <span class="at">mean =</span> M_source[<span class="dv">1</span>], <span class="at">sd =</span> <span class="fu">sqrt</span>(S_source[<span class="dv">1</span>, <span class="dv">1</span>])),</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> M_target[<span class="dv">1</span>], <span class="at">sd =</span> <span class="fu">sqrt</span>(S_target[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conditional parameters for X_2 | X_1</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  m_source <span class="ot">&lt;-</span> M_source[<span class="dv">2</span>] <span class="sc">+</span> S_source[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">/</span> S_source[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">*</span> (X[, <span class="dv">1</span>] <span class="sc">-</span> M_source[<span class="dv">1</span>])</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  s_source <span class="ot">&lt;-</span> S_source[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">-</span> S_source[<span class="dv">1</span>, <span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> S_source[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  m_target <span class="ot">&lt;-</span> M_target[<span class="dv">2</span>] <span class="sc">+</span> S_target[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">/</span> S_target[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">*</span> (T1x <span class="sc">-</span> M_target[<span class="dv">1</span>])</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  s_target <span class="ot">&lt;-</span> S_target[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">-</span> S_target[<span class="dv">1</span>, <span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> S_target[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conditional transport for the second coordinate</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>  T2x <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>(X[, <span class="dv">2</span>], <span class="at">mean =</span> m_source, <span class="at">sd =</span> <span class="fu">sqrt</span>(s_source)),</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> m_target, <span class="at">sd =</span> <span class="fu">sqrt</span>(s_target)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(T1x, T2x)</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">sequential_transport_21</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sequential transport from N(M_source, S_source) to N(M_target, S_target),</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' along X2, then X1 | X2</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param X n x 2 matrix of source observations.</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param M_source Mean vector of the source distribution (length 2).</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param S_source Covariance matrix of the source distribution (2x2).</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param M_target Mean vector of the target distribution.</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param S_target Covariance matrix of the target distribution.</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>sequential_transport_21 <span class="ot">&lt;-</span> <span class="cf">function</span>(X, M_source, S_source, M_target, S_target) {</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># marginal univariate transport along X_2</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  T2x <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>(X[, <span class="dv">2</span>], <span class="at">mean =</span> M_source[<span class="dv">2</span>], <span class="at">sd =</span> <span class="fu">sqrt</span>(S_source[<span class="dv">2</span>, <span class="dv">2</span>])),</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> M_target[<span class="dv">2</span>], <span class="at">sd =</span> <span class="fu">sqrt</span>(S_target[<span class="dv">2</span>, <span class="dv">2</span>])</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conditional parameters for X_1 | X_2</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  m_source <span class="ot">&lt;-</span> M_source[<span class="dv">1</span>] <span class="sc">+</span> S_source[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">/</span> S_source[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">*</span> (X[, <span class="dv">2</span>] <span class="sc">-</span> M_source[<span class="dv">2</span>])</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  s_source <span class="ot">&lt;-</span> S_source[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> S_source[<span class="dv">1</span>, <span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> S_source[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  m_target <span class="ot">&lt;-</span> M_target[<span class="dv">1</span>] <span class="sc">+</span> S_target[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">/</span> S_target[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">*</span> (T2x <span class="sc">-</span> M_target[<span class="dv">2</span>])</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  s_target <span class="ot">&lt;-</span> S_target[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> S_target[<span class="dv">1</span>, <span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> S_target[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conditional transport for X1 | X_2</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  T1x <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>(X[, <span class="dv">1</span>], <span class="at">mean =</span> m_source, <span class="at">sd =</span> <span class="fu">sqrt</span>(s_source)),</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> m_target, <span class="at">sd =</span> <span class="fu">sqrt</span>(s_target)</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(T1x, T2x)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We isolate the observations from <span style="color: #00A08A;">group 0</span> and from <span style="color: #F2AD00;">group 1</span>, and store them as matrices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then transport from <span style="color: #00A08A;">group 0</span> to group <span style="color: #F2AD00;">group 1</span> with sequential transport, first transporting <span class="math inline">\(X_1\)</span> then <span class="math inline">\(X_2 | X_1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>X0_st_12 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_12</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X0, <span class="at">M_source =</span> Mu0, <span class="at">S_source =</span> Sig0, <span class="at">M_target =</span> Mu1, <span class="at">S_target =</span> Sig1</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do the same but for units in <span style="color: #F2AD00;">group 1</span> to <span style="color: #00A08A;">group 0</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>X1_st_12 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_12</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X1, <span class="at">M_source =</span> Mu1, <span class="at">S_source =</span> Sig1, <span class="at">M_target =</span> Mu0, <span class="at">S_target =</span> Sig0</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also transport from <span style="color: #00A08A;">group 0</span> to group <span style="color: #F2AD00;">group 1</span> with sequential transport, first transporting <span class="math inline">\(X_1\)</span> then <span class="math inline">\(X_2 | X_1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>X0_st_21 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_21</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X0, <span class="at">M_source =</span> Mu0, <span class="at">S_source =</span> Sig0, <span class="at">M_target =</span> Mu1, <span class="at">S_target =</span> Sig1</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do the same but for units in <span style="color: #F2AD00;">group 1</span> to <span style="color: #00A08A;">group 0</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>X1_st_21 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_21</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X1, <span class="at">M_source =</span> Mu1, <span class="at">S_source =</span> Sig1, <span class="at">M_target =</span> Mu0, <span class="at">S_target =</span> Sig0</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, we can visualize the results on a scatter plot (<a href="#fig-gaussian-seq-ot-x1-x2" class="quarto-xref">Figure&nbsp;<span>5.5</span></a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for the plot</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1, X1 then X2----</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"A=0 to A=1, X1 then X2"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_12, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1, <span class="at">y0 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_st_12[, <span class="dv">2</span>],</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="co"># True mean and covariance (scaled by 'a')</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a><span class="co"># From 1 to 0, X1 then X2----</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"A=1 to A=0, X1 then X2"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1_st_12, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X1<span class="sc">$</span>X1, <span class="at">y0 =</span> X1<span class="sc">$</span>X2,</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X1_st_12[, <span class="dv">1</span>], <span class="at">y1 =</span> X1_st_12[, <span class="dv">2</span>],</span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a><span class="co"># From A=0 to A=1, X2 then X1</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"A=0 to A=1, X2 then X1"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_21, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1, <span class="at">y0 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_21[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_st_21[, <span class="dv">2</span>],</span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a><span class="co"># From A=1 to A=0, X2 then X1</span></span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"A=1 to A=0, X2 then X1"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1_st_21, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpet, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>)</span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X1<span class="sc">$</span>X1, <span class="at">y0 =</span> X1<span class="sc">$</span>X2,</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X1_st_21[, <span class="dv">1</span>], <span class="at">y1 =</span> X1_st_21[, <span class="dv">2</span>],</span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-seq-ot-x1-x2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-seq-ot-x1-x2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: 500 points in each group drawn from bivariates Gaussian distributions and <span style="color:#1b95e0;">transported values</span> from <span style="color:#00A08A;">group 0</span> to <span style="color:#F2AD00;">group 1</span> (left), and from <span style="color:#F2AD00;">group 1</span> to <span style="color:#00A08A;">group 0</span> (right), using sequential optimal transport, first transporting <span class="math inline">\(X_1\)</span>, then <span class="math inline">\(X_2 \mid X_1\)</span> (top), and first transporting <span class="math inline">\(X_2\)</span>, then <span class="math inline">\(X_1 \mid X_2\)</span> (bottom).
</figcaption>
<div aria-describedby="fig-gaussian-seq-ot-x1-x2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-seq-ot-x1-x2-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes for the Figure in the paper</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fl">1.42</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>filename <span class="ot">&lt;-</span> <span class="st">"gaussian-transport-0to1"</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tikz</span>(<span class="fu">paste0</span>(<span class="st">"figs/"</span>, filename, <span class="st">".tex"</span>), <span class="at">width =</span> scale<span class="sc">*</span><span class="fl">2.2</span>, <span class="at">height =</span> scale<span class="sc">*</span><span class="dv">1</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>), <span class="at">width =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(.<span class="dv">9</span>, <span class="dv">2</span>)))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>))</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>cex_pts <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>alpha_arrows <span class="ot">&lt;-</span> .<span class="dv">2</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>length_arrow <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1, with OT</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X0, </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">family =</span> font_family,</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="dv">1</span>, <span class="at">family =</span> font_family)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"OT"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family, <span class="at">font.main=</span><span class="dv">1</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_t, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT"</span>]], <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1, <span class="at">y0 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_t[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_t[, <span class="dv">2</span>],</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> alpha_arrows)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="co"># True mean and covariance (scaled by 'a')</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>Sig0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>Sig1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariance of transported points (via OT map)</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>Sigma0_transport <span class="ot">&lt;-</span> ot_map_0_to_1<span class="sc">$</span>A <span class="sc">%*%</span> Sig0 <span class="sc">%*%</span> <span class="fu">t</span>(ot_map_0_to_1<span class="sc">$</span>A)</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">1.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>))</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="co"># From 0 to 1, X1 then X2----</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts,</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family,</span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="dv">1</span>, <span class="at">family =</span> font_family)</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"ST(1)"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family, <span class="at">font.main=</span><span class="dv">1</span>)</span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_12, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1, <span class="at">y0 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_st_12[, <span class="dv">2</span>],</span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> .<span class="dv">4</span>)</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a><span class="co"># From A=0 to A=1, X2 then X1----</span></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts,</span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> alpha_arrows), </span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family,</span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="dv">1</span>, <span class="at">family =</span> font_family)</span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"ST(2)"</span>, <span class="at">line=</span>.<span class="dv">5</span>, <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family, <span class="at">font.main=</span><span class="dv">1</span>)</span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_21, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">17</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Add arrows from original to transported</span></span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1, <span class="at">y0 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_21[, <span class="dv">1</span>], <span class="at">y1 =</span> X0_st_21[, <span class="dv">2</span>],</span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(<span class="st">"gray"</span>, <span class="at">alpha =</span> alpha_arrows)</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses</span></span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu0, Sig0, <span class="at">col =</span> colGpe0, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a><span class="fu">draw_ellipse</span>(Mu1, Sig1, <span class="at">col =</span> colGpe1, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a><span class="co"># legend(</span></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a><span class="co">#   "bottomright",</span></span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a><span class="co">#   pch = c(16, 16, 17),</span></span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a><span class="co">#   col = c(colGpe0, colGpe1, colGpet),</span></span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a><span class="co">#   legend = c("$A=0$", "$A=1$", "Transp."),</span></span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a><span class="co">#   bty = "n"</span></span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_to_pdf</span>(<span class="at">filename =</span> filename, <span class="at">path =</span> <span class="st">"./figs/"</span>, <span class="at">keep_tex =</span> <span class="cn">FALSE</span>, <span class="at">crop =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="illustration-for-a-single-unit" class="level3" data-number="5.2.6">
<h3 data-number="5.2.6" class="anchored" data-anchor-id="illustration-for-a-single-unit"><span class="header-section-number">5.2.6</span> Illustration for a Single Unit</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>export_tikz <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus on a unit</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">11</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>) </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tikz</span>(<span class="st">'figs/gaussian-1-transport.tex'</span>, <span class="at">width =</span> <span class="dv">2</span>, <span class="at">height =</span> <span class="fl">2.2</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">1.8</span>, <span class="fl">0.1</span>))</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co"># X1 then X2</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co"># title(main = "X1 then X2", line=.5, cex.lab=1.2, family = font_family)</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual of interest</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0[i, ], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_t[i, <span class="dv">1</span>], X0_t[i, <span class="dv">2</span>], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_skh_l[[<span class="st">"0.1"</span>]][i, <span class="dv">1</span>], X0_skh_l[[<span class="st">"0.1"</span>]][i, <span class="dv">2</span>], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"skh"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_12[i, <span class="dv">1</span>], X0_st_12[i, <span class="dv">2</span>], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_21[i, <span class="dv">1</span>], X0_st_21[i, <span class="dv">2</span>], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>length_arrow <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>lwd_arrow <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="co"># OT</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[i], <span class="at">y0 =</span> X0<span class="sc">$</span>X2[i],</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_t[i, <span class="dv">1</span>], <span class="at">y1 =</span> X0_t[i, <span class="dv">2</span>],</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Regularization</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[i], <span class="at">y0 =</span> X0<span class="sc">$</span>X2[i],</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_skh_l[[<span class="st">"0.1"</span>]][i, <span class="dv">1</span>], <span class="at">y1 =</span> X0_skh_l[[<span class="st">"0.1"</span>]][i, <span class="dv">2</span>],</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"skh"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Seq OT (1): X_1 first</span></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0_st_12[i, <span class="dv">1</span>], X0<span class="sc">$</span>X2[i], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[i], <span class="at">y0 =</span> X0<span class="sc">$</span>X2[i],</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[i, <span class="dv">1</span>], <span class="at">y1 =</span> X0<span class="sc">$</span>X2[i],</span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0_st_12[i, <span class="dv">1</span>], <span class="at">y0 =</span> X0<span class="sc">$</span>X2[i],</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[i, <span class="dv">1</span>], <span class="at">y1 =</span> X0_st_12[i, <span class="dv">2</span>],</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Seq OT (2): X_2 first</span></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X0<span class="sc">$</span>X1[i], X0_st_21[i,<span class="dv">2</span>], <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[i], <span class="at">y0 =</span> X0<span class="sc">$</span>X2[i],</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0<span class="sc">$</span>X1[i], <span class="at">y1 =</span> X0_st_21[i,<span class="dv">2</span>],</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[i], <span class="at">y0 =</span> X0_st_21[i,<span class="dv">2</span>],</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_21[i, <span class="dv">1</span>], <span class="at">y1 =</span> X0_st_21[i, <span class="dv">2</span>],</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topleft"</span>, </span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"$x_i$ (Obs.)"</span>, <span class="st">"OT"</span>, <span class="st">"Sinkhorn"</span>, <span class="st">"Seq. OT (1)"</span>, <span class="st">"Seq. OT (2)"</span>), </span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(colGpe0, colour_methods[<span class="fu">c</span>(<span class="st">"OT"</span>, <span class="st">"skh"</span>, <span class="st">"seq_1"</span>, <span class="st">"seq_2"</span>)]), </span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">pt.cex =</span> <span class="fl">1.5</span>, <span class="at">cex =</span> <span class="dv">1</span>,</span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">"n"</span></span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="gaussian-example_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_to_pdf</span>(<span class="at">filename =</span> <span class="st">"gaussian-1-transport"</span>, <span class="at">path =</span> <span class="st">"./figs/"</span>, <span class="at">keep_tex =</span> <span class="cn">FALSE</span>, <span class="at">crop =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sec-causal-effects" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="sec-causal-effects"><span class="header-section-number">5.3</span> Causal Effect</h2>
<p>We first generate (again) some data, using the DGP presented in <a href="xp-simulated.html#sec-dgp" class="quarto-xref"><span>Section 13.1</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">500</span>, </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu0 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">mu1 =</span> <span class="sc">+</span><span class="dv">1</span>, </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">r0 =</span> <span class="sc">+</span>.<span class="dv">7</span>, <span class="at">r1 =</span> <span class="sc">-</span>.<span class="dv">5</span>, <span class="at">a =</span> <span class="dv">1</span>, </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">12345</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="with-causal-mediation-analysis" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="with-causal-mediation-analysis"><span class="header-section-number">5.3.1</span> With Causal Mediation Analysis</h3>
<p>Let us create a dataset, <code>tb</code>, with only the binary response (Y), the binary treatment (A), and the two covariates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>tb <span class="ot">&lt;-</span> df[, <span class="fu">c</span>(<span class="st">"Y"</span>, <span class="st">"A"</span>, <span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>A_name <span class="ot">&lt;-</span> <span class="st">"A"</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>A_untreated <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>Y_name <span class="ot">&lt;-</span> <span class="st">"Y"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>med_mod_12 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.main =</span> <span class="st">"X1"</span>, </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.alt =</span> <span class="st">"X2"</span>, </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>med_mod_21 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.main =</span> <span class="st">"X2"</span>, </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.alt =</span> <span class="st">"X1"</span>, </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>We do not load the {mediation} package since it creates multiple conflicts with useful functions from tidyverse (including <code class="sourceCode r"><span class="fu">select</span>()</code>).</p>
</div>
</div>
<p>Let us retrieve <span class="math inline">\(\bar{\delta}(0)\)</span> (average causal mediation effect for <span class="math inline">\(a=0\)</span>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>delta_0_med <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_12<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_12<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>((med_mod_21<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_21<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>delta_0_med</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9085616</code></pre>
</div>
</div>
<p>The total average effect, <span class="math inline">\(\bar{\tau}\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>(tot_effect_med <span class="ot">&lt;-</span> med_mod_12<span class="sc">$</span>tau)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       A 
3.943122 </code></pre>
</div>
</div>
<p>We can then deduct the average direct effect for <span class="math inline">\(a=1\)</span>, i.e., <span class="math inline">\(\bar{\zeta}(1)\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>(zeta_1_med <span class="ot">&lt;-</span> tot_effect_med<span class="sc">-</span>delta_0_med)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      A 
3.03456 </code></pre>
</div>
</div>
<p>Let us also retrieve <span class="math inline">\(\bar{\delta}(1)\)</span> (average causal mediation effect for <span class="math inline">\(a=1\)</span>) and <span class="math inline">\(\bar{\zeta}(0)\)</span> (average direct effect for <span class="math inline">\(a=0\)</span>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>delta_1_med <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_12<span class="sc">$</span>d1.lb <span class="sc">+</span> med_mod_12<span class="sc">$</span>d1.ub) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>((med_mod_21<span class="sc">$</span>d1.lb <span class="sc">+</span> med_mod_21<span class="sc">$</span>d1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>zeta_0_med <span class="ot">&lt;-</span> tot_effect_med <span class="sc">-</span> delta_1_med</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(delta_1_med, zeta_0_med)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  A 
0.6905634 3.2525583 </code></pre>
</div>
</div>
</section>
<section id="with-optimal-transport" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="with-optimal-transport"><span class="header-section-number">5.3.2</span> With Optimal Transport</h3>
<p>We define a function, <code class="sourceCode r"><span class="fu">causal_effects_cf</span>()</code> to compute the causal effect of <span class="math inline">\(A\)</span> on the outcome <span class="math inline">\(Y\)</span>, for the treated individuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Estimation of total causal effect using counterfactuals.</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data_untreated Dataset with the untreated units only.</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data_treated Dataset with the treated units only.</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data_cf_untreated Counterfactuals for untreated had they been treated.</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data_cf_treated Counterfactuals for treated had they been untreated.</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param Y_name Name of the column with the outcome variable.</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param A_name Name of the column with the treatment variable.</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param A_untreated Value of the treatment for the untreated units.</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns A list:</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `delta_0_i`: \eqn{\delta_(0)}, individual causal mediation effects for </span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=0} (computed on untreated),</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `delta_0`: \eqn{\bar{\delta}(0)}, average causal mediation effect for </span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=0} (computed on untreated),</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `delta_1_i`: \eqn{\delta_(1)}, individual causal mediation effects for </span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=1} (computed on treated),</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `delta_1`: \eqn{\bar{\delta}(1)}, average causal mediation effect for </span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=1} (computed on treated),</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `zeta_0_i`: \eqn{\zeta_(0)}, individual causal mediation effects for </span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=0} (computed on treaded),</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `zeta_0`: \eqn{\bar{\zeta}(0)}, average causal mediation effect for </span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=0} (computed on treated),</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `zeta_1_i`: \eqn{\zeta_(1)}, individual causal mediation effects for </span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=1} (computed on untreaded),</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `zeta_1`: \eqn{\bar{\zeta}(1)}, average causal mediation effect for </span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \eqn{a=1} (computed on untreated),</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `tot_effect`: \eqb{\tau}: average total effect (\eqn{\bar{\delta}(0) + </span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \bar{\zeta}(1)}).</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom randomForest randomForest</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr pull select</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom stats predict</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="co">#' @md</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>causal_effects_cf <span class="ot">&lt;-</span> <span class="cf">function</span>(data_untreated,</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>                              data_treated,</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>                              data_cf_untreated,</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>                              data_cf_treated,</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>                              Y_name,</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>                              A_name,</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>                              A_untreated) {</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>  n_untreated <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_untreated)</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>  n_treated <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_treated)</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome model for untreated</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>  mu_untreated_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> data_untreated <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-!!</span>Y_name, <span class="sc">-!!</span>A_name),</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">pull</span>(data_untreated, <span class="sc">!!</span>Y_name)</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome model for treated</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>  mu_treated_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(</span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> data_treated <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-!!</span>Y_name, <span class="sc">-!!</span>A_name),</span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">pull</span>(data_treated, <span class="sc">!!</span>Y_name)</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observed outcome</span></span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>  y_untreated_obs <span class="ot">&lt;-</span> data_untreated <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>Y_name)</span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>  y_treated_obs <span class="ot">&lt;-</span> data_treated <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>Y_name)</span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Natural Indirect Effect, using predictions</span></span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>  delta_0_i <span class="ot">&lt;-</span> <span class="fu">predict</span>(mu_untreated_model, <span class="at">newdata =</span> data_cf_untreated) <span class="sc">-</span></span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(mu_untreated_model)</span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>  delta_0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(delta_0_i)</span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a>  delta_1_i <span class="ot">&lt;-</span> <span class="fu">predict</span>(mu_treated_model) <span class="sc">-</span> </span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(mu_treated_model, <span class="at">newdata =</span> data_cf_treated)</span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a>  delta_1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(delta_1_i)</span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Natural Indirect Effect, using observed variables</span></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a>  delta_0_i_obs <span class="ot">&lt;-</span> <span class="fu">predict</span>(mu_untreated_model, <span class="at">newdata =</span> data_cf_untreated) <span class="sc">-</span> </span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a>    y_untreated_obs</span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a>  delta_0_obs <span class="ot">&lt;-</span> <span class="fu">mean</span>(delta_0_i_obs)</span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a>  delta_1_i_obs <span class="ot">&lt;-</span> y_treated_obs <span class="sc">-</span> </span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(mu_treated_model, <span class="at">newdata =</span> data_cf_treated)</span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a>  delta_1_obs <span class="ot">&lt;-</span> <span class="fu">mean</span>(delta_1_i_obs)</span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Natural Direct Effect (only predictions)</span></span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a>  zeta_0_i <span class="ot">&lt;-</span> <span class="fu">predict</span>(mu_treated_model, <span class="at">newdata =</span> data_cf_treated) <span class="sc">-</span></span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(mu_untreated_model, <span class="at">newdata =</span> data_cf_treated)</span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a>  zeta_0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(zeta_0_i)</span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a>  zeta_1_i <span class="ot">&lt;-</span> <span class="fu">predict</span>(mu_treated_model, <span class="at">newdata =</span> data_cf_untreated) <span class="sc">-</span> </span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(mu_untreated_model, <span class="at">newdata =</span> data_cf_untreated)</span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a>  zeta_1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(zeta_1_i)</span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total Causal Effect for treated</span></span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a>  tot_effect <span class="ot">&lt;-</span> delta_0 <span class="sc">+</span> zeta_1  </span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a>  tot_effect_obs <span class="ot">&lt;-</span> delta_0_obs <span class="sc">+</span> zeta_1</span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i =</span> delta_0_i,</span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_i =</span> delta_1_i,</span>
<span id="cb60-95"><a href="#cb60-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_i =</span> zeta_0_i,</span>
<span id="cb60-96"><a href="#cb60-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_i =</span> zeta_1_i,</span>
<span id="cb60-97"><a href="#cb60-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i_obs =</span> delta_0_i_obs,</span>
<span id="cb60-98"><a href="#cb60-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_i_obs =</span> delta_1_i_obs,</span>
<span id="cb60-99"><a href="#cb60-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0 =</span> delta_0,</span>
<span id="cb60-100"><a href="#cb60-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1 =</span> delta_1,</span>
<span id="cb60-101"><a href="#cb60-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0 =</span> zeta_0,</span>
<span id="cb60-102"><a href="#cb60-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1 =</span> zeta_1,</span>
<span id="cb60-103"><a href="#cb60-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_obs =</span> delta_0_obs,</span>
<span id="cb60-104"><a href="#cb60-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_obs =</span> delta_1_obs,</span>
<span id="cb60-105"><a href="#cb60-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect =</span> tot_effect,</span>
<span id="cb60-106"><a href="#cb60-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_obs =</span> tot_effect_obs</span>
<span id="cb60-107"><a href="#cb60-107" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-108"><a href="#cb60-108" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use a random forest to estimate the outcome model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We apply this function to our simulated dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>tb_untreated <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(A_name) <span class="sc">==</span> <span class="sc">!!</span>A_untreated)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>tb_treated <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(A_name) <span class="sc">!=</span> <span class="sc">!!</span>A_untreated)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>causal_effects_ot <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_t),</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_t),</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_0 =</span> causal_effects_ot<span class="sc">$</span>delta_0,</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeta_1 =</span> causal_effects_ot<span class="sc">$</span>zeta_1,</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_1 =</span> causal_effects_ot<span class="sc">$</span>delta_1,</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeta_0 =</span> causal_effects_ot<span class="sc">$</span>zeta_0,</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">tot_effect =</span> causal_effects_ot<span class="sc">$</span>tot_effect,</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">tot_effect_obs =</span> causal_effects_ot<span class="sc">$</span>tot_effect_obs</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       delta_0   zeta_1   delta_1   zeta_0 tot_effect tot_effect_obs
[1,] 0.9422158 3.153563 0.2031006 3.781928   4.095779       4.083447</code></pre>
</div>
</div>
</section>
<section id="with-transport-based-matching" class="level3" data-number="5.3.3">
<h3 data-number="5.3.3" class="anchored" data-anchor-id="with-transport-based-matching"><span class="header-section-number">5.3.3</span> With Transport-based Matching</h3>
<p>We apply the same function as that used with the counterfactuals obtained with optimal transport (<code class="sourceCode r"><span class="fu">causal_effects_cf</span>()</code>). However, here, we feed it with the counterfactuals obtained with the transport-based many-to-one matching (<a href="#sec-cf-tmatch" class="quarto-xref"><span>Section 5.2.2</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>causal_effects_tmatch <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_tmatch) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_tmatch) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="with-entropic-regularization" class="level3" data-number="5.3.4">
<h3 data-number="5.3.4" class="anchored" data-anchor-id="with-entropic-regularization"><span class="header-section-number">5.3.4</span> With Entropic Regularization</h3>
<p>We apply the same function as that used with the counterfactuals obtained with optimal transport (<code class="sourceCode r"><span class="fu">causal_effects_cf</span>()</code>). However, here, we feed it with the counterfactuals obtained with the regularization method (<a href="#sec-cf-skh" class="quarto-xref"><span>Section 5.2.4</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>causal_effect_skh <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  X0_skh_l, X1_skh_l, </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span><span class="fu">causal_effects_cf</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(.x) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(.y) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  causal_effect_skh,</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span><span class="fu">tibble</span>(</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0 =</span> .x<span class="sc">$</span>delta_0,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1 =</span> .x<span class="sc">$</span>zeta_1,</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1 =</span> .x<span class="sc">$</span>delta_1,</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0 =</span> .x<span class="sc">$</span>zeta_0,</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect =</span> .x<span class="sc">$</span>tot_effect,</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_obs =</span> .x<span class="sc">$</span>tot_effect_obs</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>(<span class="at">names_to =</span> <span class="st">"gamma"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 Ã— 7
  gamma delta_0 zeta_1 delta_1 zeta_0 tot_effect tot_effect_obs
  &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;
1 0.1     0.793   3.12  0.0992   3.61       3.92           3.91
2 1       0.854   3.10  0.0181   3.88       3.95           3.96
3 5       0.834   3.14  0.214    3.68       3.98           3.97
4 10      0.830   3.16 -0.0158   3.92       3.99           3.98
5 100     0.825   3.24  0.380    3.46       4.07           4.06
6 1000    1.18    2.78  0.383    3.97       3.96           3.96
7 10000   1.18    2.74  0.495    3.84       3.93           3.92</code></pre>
</div>
</div>
</section>
<section id="with-sequential-optimal-transport" class="level3" data-number="5.3.5">
<h3 data-number="5.3.5" class="anchored" data-anchor-id="with-sequential-optimal-transport"><span class="header-section-number">5.3.5</span> With Sequential Optimal Transport</h3>
<p>Again, we <code class="sourceCode r"><span class="fu">causal_effects_cf</span>()</code>), feeding it with the counterfactuals obtained with sequential transport (sec-cf-sot). For those where we first transport <span class="math inline">\(X_1\)</span> and then <span class="math inline">\(X_2 \mid X_1\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>causal_effect_sot_12 <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_st_12) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_st_12) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And for the counterfactuales obtained by sequential transport where we first transport <span class="math inline">\(X_2\)</span> and then <span class="math inline">\(X_1 \mid X_2\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>causal_effect_sot_21 <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_st_21) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_st_21) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary" class="level3" data-number="5.3.6">
<h3 data-number="5.3.6" class="anchored" data-anchor-id="summary"><span class="header-section-number">5.3.6</span> Summary</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Method, <span class="sc">~</span>Name, <span class="sc">~</span>Value,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Theoretical"</span>, <span class="st">"delta(0)"</span>, (a1<span class="sc">+</span>a2) <span class="sc">*</span> (mu1<span class="sc">-</span>mu0),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Theoretical"</span>, <span class="st">"delta(1)"</span>, (a1<span class="sc">+</span>a2) <span class="sc">*</span> (mu1<span class="sc">-</span>mu0),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Theoretical"</span>, <span class="st">"zeta(0)"</span>, a0,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Theoretical"</span>, <span class="st">"zeta(1)"</span>, a0,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Theoretical"</span>, <span class="st">"tau"</span>, (a1<span class="sc">+</span>a2) <span class="sc">*</span> (mu1<span class="sc">-</span>mu0) <span class="sc">+</span> a0,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mediation"</span>, <span class="st">"delta(0)"</span>, delta_0_med,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mediation"</span>, <span class="st">"delta(1)"</span>, delta_1_med,</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mediation"</span>, <span class="st">"zeta(0)"</span>, zeta_0_med,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mediation"</span>, <span class="st">"zeta(1)"</span>, zeta_1_med,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mediation"</span>, <span class="st">"tau"</span>, tot_effect_med,</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span>, <span class="st">"delta(0)"</span>, causal_effects_ot<span class="sc">$</span>delta_0,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span>, <span class="st">"delta(1)"</span>, causal_effects_ot<span class="sc">$</span>delta_1,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span>, <span class="st">"zeta(0)"</span>, causal_effects_ot<span class="sc">$</span>zeta_0,  </span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span>, <span class="st">"zeta(1)"</span>, causal_effects_ot<span class="sc">$</span>zeta_1,</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span>, <span class="st">"tau"</span>, causal_effects_ot<span class="sc">$</span>tot_effect,</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT (Obs)"</span>, <span class="st">"delta(0)"</span>, causal_effects_ot<span class="sc">$</span>delta_0_obs,</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT (Obs)"</span>, <span class="st">"delta(1)"</span>, causal_effects_ot<span class="sc">$</span>delta_1_obs,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT (Obs)"</span>, <span class="st">"tau"</span>, causal_effects_ot<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching"</span>, <span class="st">"delta(0)"</span>, causal_effects_tmatch<span class="sc">$</span>delta_0,</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching"</span>, <span class="st">"delta(1)"</span>, causal_effects_tmatch<span class="sc">$</span>delta_1,</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching"</span>, <span class="st">"zeta(0)"</span>, causal_effects_tmatch<span class="sc">$</span>zeta_0,  </span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching"</span>, <span class="st">"zeta(1)"</span>, causal_effects_tmatch<span class="sc">$</span>zeta_1,</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching"</span>, <span class="st">"tau"</span>, causal_effects_tmatch<span class="sc">$</span>tot_effect,</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching (Obs)"</span>, <span class="st">"delta(0)"</span>, causal_effects_tmatch<span class="sc">$</span>delta_0_obs,</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching (Obs)"</span>, <span class="st">"delta(1)"</span>, causal_effects_tmatch<span class="sc">$</span>delta_1_obs,</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Matching (Obs)"</span>, <span class="st">"tau"</span>, causal_effects_tmatch<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1)"</span>, <span class="st">"delta(0)"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>delta_0,</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1)"</span>, <span class="st">"delta(1)"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>delta_1,</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1)"</span>, <span class="st">"zeta(0)"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>zeta_0,  </span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1)"</span>, <span class="st">"zeta(1)"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>zeta_1,</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1)"</span>, <span class="st">"tau"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>tot_effect,</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1) (Obs)"</span>, <span class="st">"delta(0)"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>delta_0_obs,</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1) (Obs)"</span>, <span class="st">"delta(1)"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>delta_1_obs,</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sinkhorn (gamma=.1) (Obs)"</span>, <span class="st">"tau"</span>, causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1)"</span>, <span class="st">"delta(0)"</span>, causal_effect_sot_12<span class="sc">$</span>delta_0,</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1)"</span>, <span class="st">"delta(1)"</span>, causal_effect_sot_12<span class="sc">$</span>delta_1,</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1)"</span>, <span class="st">"zeta(0)"</span>, causal_effect_sot_12<span class="sc">$</span>zeta_0,  </span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1)"</span>, <span class="st">"zeta(1)"</span>, causal_effect_sot_12<span class="sc">$</span>zeta_1,</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1)"</span>, <span class="st">"tau"</span>, causal_effect_sot_12<span class="sc">$</span>tot_effect,</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1) (Obs)"</span>, <span class="st">"delta(0)"</span>, causal_effect_sot_12<span class="sc">$</span>delta_0_obs,</span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1) (Obs)"</span>, <span class="st">"delta(1)"</span>, causal_effect_sot_12<span class="sc">$</span>delta_1_obs,</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (1) (Obs)"</span>, <span class="st">"tau"</span>, causal_effect_sot_12<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2)"</span>, <span class="st">"delta(0)"</span>, causal_effect_sot_21<span class="sc">$</span>delta_0,</span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2)"</span>, <span class="st">"delta(1)"</span>, causal_effect_sot_21<span class="sc">$</span>delta_1,</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2)"</span>, <span class="st">"zeta(0)"</span>, causal_effect_sot_21<span class="sc">$</span>zeta_0,</span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2)"</span>, <span class="st">"zeta(1)"</span>, causal_effect_sot_21<span class="sc">$</span>zeta_1,</span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2)"</span>, <span class="st">"tau"</span>, causal_effect_sot_21<span class="sc">$</span>tot_effect,</span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2) (Obs)"</span>, <span class="st">"delta(0)"</span>, causal_effect_sot_21<span class="sc">$</span>delta_0_obs,</span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2) (Obs)"</span>, <span class="st">"delta(1)"</span>, causal_effect_sot_21<span class="sc">$</span>delta_1_obs,</span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SOT (2) (Obs)"</span>, <span class="st">"tau"</span>, causal_effect_sot_21<span class="sc">$</span>tot_effect_obs</span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"Name"</span>, <span class="at">values_from =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 Ã— 6
   Method                    `delta(0)` `delta(1)` `zeta(0)` `zeta(1)`   tau
   &lt;chr&gt;                          &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1 Theoretical                    1         1           3         3     4   
 2 Mediation                      0.909     0.691       3.25      3.03  3.94
 3 OT                             0.942     0.203       3.78      3.15  4.10
 4 OT (Obs)                       0.930     0.208      NA        NA     4.08
 5 Matching                       0.862     0.0860      3.85      3.08  3.94
 6 Matching (Obs)                 0.858     0.0880     NA        NA     3.93
 7 Sinkhorn (gamma=.1)            0.793     0.0992      3.61      3.12  3.92
 8 Sinkhorn (gamma=.1) (Obs)      0.791     0.117      NA        NA     3.91
 9 SOT (1)                        1.01      0.116       3.90      3.14  4.15
10 SOT (1) (Obs)                  1.00      0.118      NA        NA     4.14
11 SOT (2)                        0.904     0.114       3.95      3.04  3.94
12 SOT (2) (Obs)                  0.889     0.122      NA        NA     3.93</code></pre>
</div>
</div>
<p>Let us have a look at the distribution of the individual causal effects (<a href="#fig-gaussian-dist-indiv-effects" class="quarto-xref">Figure&nbsp;<span>5.6</span></a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>plot_hist_effects <span class="ot">&lt;-</span> <span class="cf">function</span>(x,</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>                              var_name,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">tikz =</span> <span class="cn">FALSE</span>,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">fill =</span> <span class="st">"red"</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method_main =</span> <span class="st">""</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">x_lim =</span> <span class="cn">NULL</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">effect_ylab =</span> <span class="st">""</span>,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">print_method_main =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">print_x_axis =</span> <span class="cn">TRUE</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">print_y_axis =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># effect label (LaTeX)</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  name_effect <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(var_name, <span class="st">"^delta_0"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">delta_i(0)$"</span>,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(var_name, <span class="st">"^zeta_1"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">zeta_i(1)$"</span>,</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_detect</span>(var_name, <span class="st">"^tot_effect"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i(1)$"</span>,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"other"</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (tikz <span class="sc">==</span> <span class="cn">FALSE</span>) name_effect <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(name_effect)</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>  data_plot <span class="ot">&lt;-</span> <span class="cf">if</span> (var_name <span class="sc">==</span> <span class="st">"tot_effect"</span>) x[[<span class="st">"delta_0_i"</span>]] <span class="sc">+</span> x[[<span class="st">"zeta_1_i"</span>]] <span class="cf">else</span> x[[var_name]]</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># hist</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(x_lim)) {</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(data_plot, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">family =</span> font_family,</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> fill, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(data_plot, <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">family =</span> font_family,</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">col =</span> fill, <span class="at">xlim =</span> x_lim, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (print_x_axis) <span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">family =</span> font_family)</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (print_y_axis) <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># main title = method (only first row)</span></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (print_method_main <span class="sc">&amp;&amp;</span> method_main <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(<span class="at">main =</span> method_main, <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family, <span class="at">font.main =</span> <span class="dv">1</span>)</span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y-axis label = effect name (only first column)</span></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (effect_ylab <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(<span class="at">ylab =</span> effect_ylab, <span class="at">line =</span> <span class="dv">2</span>, <span class="at">cex.lab =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family, <span class="at">font.main =</span> <span class="dv">1</span>)</span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(data_plot), <span class="at">col =</span> <span class="st">"darkred"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(name_effect)</span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a>export_tikz <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fl">1.475</span></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="st">"gaussian-indiv-effects"</span></span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a>width_tikz <span class="ot">&lt;-</span> <span class="fl">2.7</span><span class="sc">*</span>scale</span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>height_tikz <span class="ot">&lt;-</span> <span class="fl">1.5</span><span class="sc">*</span>scale</span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tikz</span>(<span class="fu">paste0</span>(<span class="st">"figs/"</span>, file_name, <span class="st">".tex"</span>), <span class="at">width =</span> width_tikz, <span class="at">height =</span> height_tikz)</span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span><span class="dv">5</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">3</span>)),</span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">widths  =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(.<span class="dv">72</span>, <span class="dv">4</span>)),   <span class="co"># 5 columns</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(.<span class="dv">9</span>, <span class="dv">2</span>))     <span class="co"># 3 rows</span></span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a>x_lim_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a>  <span class="st">"delta_0_i"</span>  <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,  <span class="dv">6</span>),</span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a>  <span class="st">"zeta_1_i"</span>   <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,  <span class="dv">8</span>),</span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tot_effect"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">14</span>)</span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> causal_effects_ot,</span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># i == 2 ~ causal_effects_tmatch,</span></span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> causal_effect_skh[[<span class="st">"0.1"</span>]],</span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> causal_effect_sot_12,</span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> causal_effect_sot_21</span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"OT"</span>,</span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># i == 2 ~ "OT-M",</span></span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"SKH"</span>,</span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"ST(1)"</span>,</span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"ST(2)"</span></span>
<span id="cb71-87"><a href="#cb71-87" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-88"><a href="#cb71-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a>  colour <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb71-90"><a href="#cb71-90" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> colour_methods[[<span class="st">"OT"</span>]],</span>
<span id="cb71-91"><a href="#cb71-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># i == 2 ~ colour_methods[["OT-M"]],</span></span>
<span id="cb71-92"><a href="#cb71-92" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> colour_methods[[<span class="st">"skh"</span>]],</span>
<span id="cb71-93"><a href="#cb71-93" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> colour_methods[[<span class="st">"seq_1"</span>]],</span>
<span id="cb71-94"><a href="#cb71-94" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> colour_methods[[<span class="st">"seq_2"</span>]]</span>
<span id="cb71-95"><a href="#cb71-95" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-96"><a href="#cb71-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-97"><a href="#cb71-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var_name <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"delta_0_i"</span>, <span class="st">"zeta_1_i"</span>, <span class="st">"tot_effect"</span>)) {</span>
<span id="cb71-98"><a href="#cb71-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-99"><a href="#cb71-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># margins after transpose:</span></span>
<span id="cb71-100"><a href="#cb71-100" aria-hidden="true" tabindex="-1"></a>    mar_bottom <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(var_name <span class="sc">==</span> <span class="st">"tot_effect"</span>, <span class="fl">2.1</span>, .<span class="dv">6</span>)  <span class="co"># bottom row</span></span>
<span id="cb71-101"><a href="#cb71-101" aria-hidden="true" tabindex="-1"></a>    mar_left   <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i <span class="sc">==</span> <span class="dv">1</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>)                   <span class="co"># first column</span></span>
<span id="cb71-102"><a href="#cb71-102" aria-hidden="true" tabindex="-1"></a>    mar_top    <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(var_name <span class="sc">==</span> <span class="st">"delta_0_i"</span>, <span class="fl">2.1</span>, .<span class="dv">1</span>)   <span class="co"># first row</span></span>
<span id="cb71-103"><a href="#cb71-103" aria-hidden="true" tabindex="-1"></a>    mar_right  <span class="ot">&lt;-</span> .<span class="dv">4</span></span>
<span id="cb71-104"><a href="#cb71-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-105"><a href="#cb71-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(mar_bottom, mar_left, mar_top, mar_right))</span>
<span id="cb71-106"><a href="#cb71-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-107"><a href="#cb71-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># effect label only in first column</span></span>
<span id="cb71-108"><a href="#cb71-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb71-109"><a href="#cb71-109" aria-hidden="true" tabindex="-1"></a>      effect_label <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb71-110"><a href="#cb71-110" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(var_name, <span class="st">"^delta_0"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">delta_i$"</span>,</span>
<span id="cb71-111"><a href="#cb71-111" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(var_name, <span class="st">"^zeta_1"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">zeta_i$"</span>,</span>
<span id="cb71-112"><a href="#cb71-112" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(var_name, <span class="st">"^tot_effect"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i$"</span>,</span>
<span id="cb71-113"><a href="#cb71-113" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"other"</span></span>
<span id="cb71-114"><a href="#cb71-114" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb71-115"><a href="#cb71-115" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">FALSE</span>) effect_label <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(effect_label)</span>
<span id="cb71-116"><a href="#cb71-116" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb71-117"><a href="#cb71-117" aria-hidden="true" tabindex="-1"></a>      effect_label <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb71-118"><a href="#cb71-118" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-119"><a href="#cb71-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-120"><a href="#cb71-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-121"><a href="#cb71-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_hist_effects</span>(</span>
<span id="cb71-122"><a href="#cb71-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x,</span>
<span id="cb71-123"><a href="#cb71-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_name =</span> var_name,</span>
<span id="cb71-124"><a href="#cb71-124" aria-hidden="true" tabindex="-1"></a>      <span class="at">tikz =</span> export_tikz,</span>
<span id="cb71-125"><a href="#cb71-125" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> colour,</span>
<span id="cb71-126"><a href="#cb71-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">method_main =</span> method,</span>
<span id="cb71-127"><a href="#cb71-127" aria-hidden="true" tabindex="-1"></a>      <span class="at">x_lim =</span> x_lim_list[[var_name]],</span>
<span id="cb71-128"><a href="#cb71-128" aria-hidden="true" tabindex="-1"></a>      <span class="at">effect_ylab =</span> effect_label,</span>
<span id="cb71-129"><a href="#cb71-129" aria-hidden="true" tabindex="-1"></a>      <span class="at">print_method_main =</span> (var_name <span class="sc">==</span> <span class="st">"delta_0_i"</span>),      <span class="co"># first row only</span></span>
<span id="cb71-130"><a href="#cb71-130" aria-hidden="true" tabindex="-1"></a>      <span class="at">print_x_axis =</span> (var_name <span class="sc">==</span> <span class="st">"tot_effect"</span>),          <span class="co"># bottom row only</span></span>
<span id="cb71-131"><a href="#cb71-131" aria-hidden="true" tabindex="-1"></a>      <span class="at">print_y_axis =</span> <span class="cn">TRUE</span></span>
<span id="cb71-132"><a href="#cb71-132" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-133"><a href="#cb71-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-134"><a href="#cb71-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-135"><a href="#cb71-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-136"><a href="#cb71-136" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb71-137"><a href="#cb71-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb71-138"><a href="#cb71-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_to_pdf</span>(</span>
<span id="cb71-139"><a href="#cb71-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file_name, </span>
<span id="cb71-140"><a href="#cb71-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"./figs/"</span>, <span class="at">keep_tex =</span> <span class="cn">FALSE</span>, <span class="at">crop =</span> T</span>
<span id="cb71-141"><a href="#cb71-141" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb71-142"><a href="#cb71-142" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-dist-indiv-effects" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-dist-indiv-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: Distribution of individual direct effect (<span class="math inline">\(\delta_i(0)\)</span>), indirect effect (<span class="math inline">\(\zeta_i(0)\)</span>), and total causal effect (<span class="math inline">\(\tau_i\)</span>) estimated with transport-based counterfactuals with optimal transport (OT), penalized transport (SKH), and sequential transport (ST).
</figcaption>
<div aria-describedby="fig-gaussian-dist-indiv-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-dist-indiv-effects-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="some-individuals" class="level3" data-number="5.3.7">
<h3 data-number="5.3.7" class="anchored" data-anchor-id="some-individuals"><span class="header-section-number">5.3.7</span> Some Individuals</h3>
<p>Let us have a look at some individuals. We focus on the one with the predicted <span class="math inline">\(\tau_i\)</span> estimated using Optimal Transport which is the closest to the theoretical value, and the one that is the farthest. Let us get the theoretical values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>(tau_theo <span class="ot">&lt;-</span> (a1 <span class="sc">+</span> a2) <span class="sc">*</span> (mu1 <span class="sc">-</span> mu0) <span class="sc">+</span> a0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>(tau_med <span class="ot">&lt;-</span> tot_effect_med[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.943122</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>(tau_ot <span class="ot">&lt;-</span> causal_effects_ot<span class="sc">$</span>tot_effect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.095779</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>(tau_tmatch <span class="ot">&lt;-</span> causal_effects_tmatch<span class="sc">$</span>tot_effect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.937629</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>(tau_skh <span class="ot">&lt;-</span> causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>tot_effect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.915611</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>(tau_sot_12 <span class="ot">&lt;-</span> causal_effect_sot_12<span class="sc">$</span>tot_effect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.15099</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>(tau_sot_21 <span class="ot">&lt;-</span> causal_effect_sot_21<span class="sc">$</span>tot_effect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.94203</code></pre>
</div>
</div>
<p>We create a table that contains the coordinates of individuals from <span style="color: #00A08A;">group 0</span>), their transported coordinates (using OT, and sequential transport), and their estimated values for <span class="math inline">\(\delta_i(0)\)</span>, <span class="math inline">\(\zeta_i(1)\)</span>, and <span class="math inline">\(\tau_i\)</span>, obtained with the different counterfactuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>tb_indiv_0 <span class="ot">&lt;-</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> X0<span class="sc">$</span>X1,</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2 =</span> X0<span class="sc">$</span>X2,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_t =</span> X0_t[, <span class="dv">1</span>], <span class="co"># with OT</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2_t =</span> X0_t[, <span class="dv">2</span>], <span class="co"># idem</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_tmatch =</span> X0_tmatch[, <span class="dv">1</span>], <span class="co"># with transport-based matching</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2_tmatch =</span> X0_tmatch[, <span class="dv">2</span>], <span class="co"># idem</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_skh =</span> X0_skh_l[[<span class="st">"0.1"</span>]][, <span class="dv">1</span>], <span class="co"># with Regularization</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2_skh =</span> X0_skh_l[[<span class="st">"0.1"</span>]][, <span class="dv">2</span>], <span class="co"># idem</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_sot_12 =</span> X0_st_12[, <span class="dv">1</span>], <span class="co"># with Seq T (1)</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2_sot_12 =</span> X0_st_12[, <span class="dv">2</span>], <span class="co"># idem</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_sot_21 =</span> X0_st_21[, <span class="dv">1</span>], <span class="co"># with Seq T (2)</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2_sot_21 =</span> X0_st_21[, <span class="dv">2</span>], <span class="co"># idem</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OT</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i_ot =</span> causal_effects_ot<span class="sc">$</span>delta_0_i,</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_i_ot =</span> causal_effects_ot<span class="sc">$</span>zeta_1_i,</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matching</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>delta_0_i,</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_i_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>zeta_1_i,</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skh</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i_skh =</span> causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>delta_0_i,</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_i_skh =</span> causal_effect_skh[[<span class="st">"0.1"</span>]]<span class="sc">$</span>zeta_1_i,</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ST (1)</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>delta_0_i,</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_i_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>zeta_1_i,</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ST (2)</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_i_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>delta_0_i,</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_i_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>zeta_1_i</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total causal effect</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_ot =</span> delta_0_i_ot <span class="sc">+</span> zeta_1_i_ot,</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_tmatch =</span> delta_0_i_tmatch <span class="sc">+</span> zeta_1_i_tmatch,</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_skh =</span> delta_0_i_skh <span class="sc">+</span> zeta_1_i_skh,</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_sot_12 =</span> delta_0_i_sot_12 <span class="sc">+</span> zeta_1_i_sot_12,</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_sot_21 =</span> delta_0_i_ot <span class="sc">+</span> zeta_1_i_sot_21</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distance to the theoretical value</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_ot_dist =</span> <span class="fu">abs</span>(tau_i_ot <span class="sc">-</span> tau_theo),</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_tmatch_dist =</span> <span class="fu">abs</span>(tau_i_tmatch <span class="sc">-</span> tau_theo),</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_skh_dist =</span> <span class="fu">abs</span>(tau_i_skh <span class="sc">-</span> tau_theo),</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_sot_12_dist =</span> <span class="fu">abs</span>(tau_i_sot_12 <span class="sc">-</span> tau_theo),</span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_i_sot_21_dist =</span> <span class="fu">abs</span>(tau_i_sot_21 <span class="sc">-</span> tau_theo)</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In that table, we identify the two untreated units of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ind_closest <span class="ot">&lt;-</span> <span class="fu">order</span>(tb_indiv_0<span class="sc">$</span>tau_i_ot_dist)[<span class="dv">1</span>]</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>ind_farthest <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">order</span>(tb_indiv_0<span class="sc">$</span>tau_i_ot_dist))[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Their coordinates are shown in <a href="#tbl-individual-causal-effects-toy-obs" class="quarto-xref">Table&nbsp;<span>5.1</span></a>, as well as the coordinates of their counterfactuals.</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Table.</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>format_num <span class="ot">&lt;-</span> <span class="cf">function</span>(x) scales<span class="sc">::</span><span class="fu">number</span>(x, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>tb_indiv_0_short <span class="ot">&lt;-</span> </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  tb_indiv_0 <span class="sc">|&gt;</span> </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"dist"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">where</span>(is.numeric),</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>           <span class="sc">~</span><span class="fu">format_num</span>(.x)</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">row_number</span>() <span class="sc">==</span> ind_closest <span class="sc">~</span> <span class="st">"Closest"</span>,</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">row_number</span>() <span class="sc">==</span> ind_farthest <span class="sc">~</span> <span class="st">"Farthest"</span>,</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(obs_type <span class="sc">!=</span> <span class="st">"Other"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">coord =</span> <span class="fu">str_c</span>(<span class="st">"("</span>, X1, <span class="st">", "</span>, X2, <span class="st">")"</span>),</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">coord_OT =</span> <span class="fu">str_c</span>(<span class="st">"("</span>, X1_t, <span class="st">", "</span>, X2_t, <span class="st">")"</span>),</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">coord_TM =</span> <span class="fu">str_c</span>(<span class="st">"("</span>, X1_tmatch, <span class="st">", "</span>, X2_tmatch, <span class="st">")"</span>),</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">coord_SKH =</span> <span class="fu">str_c</span>(<span class="st">"("</span>, X1_skh, <span class="st">", "</span>, X2_skh, <span class="st">")"</span>),</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">coord_ST1 =</span> <span class="fu">str_c</span>(<span class="st">"("</span>, X1_sot_12, <span class="st">", "</span>, X2_sot_12, <span class="st">")"</span>),</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">coord_ST2 =</span> <span class="fu">str_c</span>(<span class="st">"("</span>, X1_sot_21, <span class="st">", "</span>, X2_sot_21, <span class="st">")"</span>)</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>X1, <span class="sc">-</span>X2, <span class="sc">-</span>X1_t, <span class="sc">-</span>X2_t, <span class="sc">-</span>X1_tmatch, <span class="sc">-</span>X2_tmatch,</span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>X1_skh, <span class="sc">-</span>X2_skh,</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>X1_sot_12, <span class="sc">-</span>X2_sot_12, <span class="sc">-</span>X1_sot_21, <span class="sc">-</span>X2_sot_21</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>obs_type, <span class="sc">-</span>coord, <span class="sc">-</span>coord_OT, <span class="sc">-</span>coord_TM, <span class="sc">-</span>coord_SKH, <span class="sc">-</span>coord_ST1, <span class="sc">-</span>coord_ST2</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"^delta"</span>) <span class="sc">~</span> <span class="st">"delta"</span>,</span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"^zeta"</span>) <span class="sc">~</span> <span class="st">"zeta"</span>,</span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"^tau"</span>) <span class="sc">~</span> <span class="st">"tau"</span>,</span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">factor</span>(</span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>      type, </span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"delta"</span>, <span class="st">"zeta"</span>, <span class="st">"tau"</span>)</span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="fu">case_when</span>(</span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_med$"</span>) <span class="sc">~</span> <span class="st">"CM"</span>,</span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_ot$"</span>) <span class="sc">~</span> <span class="st">"OT"</span>,</span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_tmatch$"</span>) <span class="sc">~</span> <span class="st">"OT-M"</span>,</span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_skh$"</span>) <span class="sc">~</span> <span class="st">"SKH"</span>,</span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_sot_12$"</span>) <span class="sc">~</span> <span class="st">"ST(1)"</span>,</span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"sot_21$"</span>) <span class="sc">~</span> <span class="st">"ST(2)"</span>,</span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">|&gt;</span> </span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> type, <span class="at">values_from =</span> value</span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a><span class="co"># tb_indiv_0_short |&gt;</span></span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(obs_type, method, delta, zeta, tau) |&gt;</span></span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a><span class="co">#   pivot_longer(cols = c(delta, zeta, tau)) |&gt;</span></span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   pivot_wider(names_from = method, values_from = value) |&gt;</span></span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a><span class="co">#   arrange(name, obs_type) |&gt;</span></span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-obs_type) |&gt;</span></span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a><span class="co">#   kableExtra::kbl(booktabs = TRUE, format = "latex")</span></span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>tb_indiv_0_short <span class="sc">|&gt;</span> </span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(obs_type) <span class="sc">|&gt;</span> </span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(coord, coord_OT, coord_TM, coord_SKH, coord_ST1, coord_ST2) <span class="sc">|&gt;</span> </span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-individual-causal-effects-toy-obs" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-individual-causal-effects-toy-obs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5.1: Coordinates of two untreated units before and after transport.
</figcaption>
<div aria-describedby="tbl-individual-causal-effects-toy-obs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">obs_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">coord</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">coord_OT</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">coord_TM</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">coord_SKH</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">coord_ST1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">coord_ST2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Closest</td>
<td style="text-align: left;">(-1.5, -1.4)</td>
<td style="text-align: left;">(0.6, 0.9)</td>
<td style="text-align: left;">(0.2, 0.6)</td>
<td style="text-align: left;">(0.3, 0.6)</td>
<td style="text-align: left;">(0.5, 1.2)</td>
<td style="text-align: left;">(0.9, 0.6)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Farthest</td>
<td style="text-align: left;">(-2.4, -3.8)</td>
<td style="text-align: left;">(1.4, -1.6)</td>
<td style="text-align: left;">(3.5, -1.5)</td>
<td style="text-align: left;">(-0.6, -0.9)</td>
<td style="text-align: left;">(-0.4, -0.4)</td>
<td style="text-align: left;">(3.0, -1.8)</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>The estimation of the direct, indirect and total effects are reported in <a href="#tbl-individual-causal-effects-toy" class="quarto-xref">Table&nbsp;<span>5.2</span></a>, depending on the method used to create the counterfactual.</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Table.</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>tb_indiv_0_short <span class="sc">|&gt;</span> </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(method, delta, zeta, tau) <span class="sc">|&gt;</span> </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-individual-causal-effects-toy" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-individual-causal-effects-toy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5.2: Estimated values of <span class="math inline">\(\delta_i(0)\)</span>, <span class="math inline">\(\zeta_i(1)\)</span>, and <span class="math inline">\(\tau_i\)</span> for the two individuals, depending on the transport method.
</figcaption>
<div aria-describedby="tbl-individual-causal-effects-toy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">method</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">delta</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">zeta</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">tau</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">OT</td>
<td style="text-align: left;">4.2</td>
<td style="text-align: left;">4.5</td>
<td style="text-align: left;">8.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">OT-M</td>
<td style="text-align: left;">4.1</td>
<td style="text-align: left;">7.7</td>
<td style="text-align: left;">11.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SKH</td>
<td style="text-align: left;">1.0</td>
<td style="text-align: left;">3.4</td>
<td style="text-align: left;">4.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">ST(1)</td>
<td style="text-align: left;">1.1</td>
<td style="text-align: left;">3.3</td>
<td style="text-align: left;">4.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ST(2)</td>
<td style="text-align: left;">3.9</td>
<td style="text-align: left;">7.6</td>
<td style="text-align: left;">11.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">OT</td>
<td style="text-align: left;">1.3</td>
<td style="text-align: left;">2.7</td>
<td style="text-align: left;">4.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">OT-M</td>
<td style="text-align: left;">0.4</td>
<td style="text-align: left;">3.2</td>
<td style="text-align: left;">3.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">SKH</td>
<td style="text-align: left;">0.5</td>
<td style="text-align: left;">3.2</td>
<td style="text-align: left;">3.7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ST(1)</td>
<td style="text-align: left;">-0.4</td>
<td style="text-align: left;">3.7</td>
<td style="text-align: left;">3.3</td>
</tr>
<tr class="even">
<td style="text-align: left;">ST(2)</td>
<td style="text-align: left;">1.4</td>
<td style="text-align: left;">3.5</td>
<td style="text-align: left;">4.9</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>export_tikz <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="st">"gaussian-tau-two-indiv"</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fl">1.45</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>width_tikz <span class="ot">&lt;-</span> <span class="fl">3.3</span><span class="sc">*</span>scale</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>height_tikz <span class="ot">&lt;-</span> <span class="fl">1.55</span><span class="sc">*</span>scale</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tikz</span>(<span class="fu">paste0</span>(<span class="st">"figs/"</span>, file_name, <span class="st">".tex"</span>), <span class="at">width =</span> width_tikz, <span class="at">height =</span> height_tikz)</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="co"># par(mar = c(2.1, 2.1, .1, .1), mfrow = c(1, 2))</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>), <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="fl">8.1</span>))</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, .<span class="dv">1</span>, .<span class="dv">1</span>))</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Closest----</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>cex_pts <span class="ot">&lt;-</span> .<span class="dv">3</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>lwd_arrow <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>length_arrow <span class="ot">&lt;-</span> .<span class="dv">05</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family,</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> cex_pts</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">labels =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">labels =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Individuals of interest</span></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrows to OT</span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_t[<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>], </span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_t[<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>],</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrows to OT-Matching</span></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_tmatch[<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>], </span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_tmatch[<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>],</span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT-M"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb90-49"><a href="#cb90-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb90-50"><a href="#cb90-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-51"><a href="#cb90-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrows to SKH</span></span>
<span id="cb90-52"><a href="#cb90-52" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-53"><a href="#cb90-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-54"><a href="#cb90-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-55"><a href="#cb90-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>], </span>
<span id="cb90-56"><a href="#cb90-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>],</span>
<span id="cb90-57"><a href="#cb90-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"skh"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb90-58"><a href="#cb90-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb90-59"><a href="#cb90-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-60"><a href="#cb90-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Seq OT (1): X_1 first</span></span>
<span id="cb90-61"><a href="#cb90-61" aria-hidden="true" tabindex="-1"></a><span class="co"># points(</span></span>
<span id="cb90-62"><a href="#cb90-62" aria-hidden="true" tabindex="-1"></a><span class="co">#   X0_st_12[c(ind_closest), 1], </span></span>
<span id="cb90-63"><a href="#cb90-63" aria-hidden="true" tabindex="-1"></a><span class="co">#   X0$X2[c(ind_closest)], </span></span>
<span id="cb90-64"><a href="#cb90-64" aria-hidden="true" tabindex="-1"></a><span class="co">#   col = adjustcolor(colour_methods[["seq_1"]], alpha = .5), pch = 16, cex = 1</span></span>
<span id="cb90-65"><a href="#cb90-65" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb90-66"><a href="#cb90-66" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-67"><a href="#cb90-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)], </span>
<span id="cb90-68"><a href="#cb90-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-69"><a href="#cb90-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb90-70"><a href="#cb90-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-71"><a href="#cb90-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb90-72"><a href="#cb90-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb90-73"><a href="#cb90-73" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-74"><a href="#cb90-74" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-75"><a href="#cb90-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb90-76"><a href="#cb90-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-77"><a href="#cb90-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb90-78"><a href="#cb90-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">2</span>],</span>
<span id="cb90-79"><a href="#cb90-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb90-80"><a href="#cb90-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb90-81"><a href="#cb90-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-82"><a href="#cb90-82" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-83"><a href="#cb90-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)], </span>
<span id="cb90-84"><a href="#cb90-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)],</span>
<span id="cb90-85"><a href="#cb90-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)], </span>
<span id="cb90-86"><a href="#cb90-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_st_21[<span class="fu">c</span>(ind_closest),<span class="dv">2</span>],</span>
<span id="cb90-87"><a href="#cb90-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb90-88"><a href="#cb90-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb90-89"><a href="#cb90-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-90"><a href="#cb90-90" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb90-91"><a href="#cb90-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)], </span>
<span id="cb90-92"><a href="#cb90-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0_st_21[<span class="fu">c</span>(ind_closest),<span class="dv">2</span>],</span>
<span id="cb90-93"><a href="#cb90-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_21[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb90-94"><a href="#cb90-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_st_21[<span class="fu">c</span>(ind_closest), <span class="dv">2</span>],</span>
<span id="cb90-95"><a href="#cb90-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb90-96"><a href="#cb90-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb90-97"><a href="#cb90-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-98"><a href="#cb90-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-99"><a href="#cb90-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Individuals</span></span>
<span id="cb90-100"><a href="#cb90-100" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb90-101"><a href="#cb90-101" aria-hidden="true" tabindex="-1"></a>  tb_indiv_0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_closest)], </span>
<span id="cb90-102"><a href="#cb90-102" aria-hidden="true" tabindex="-1"></a>  tb_indiv_0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_closest)], </span>
<span id="cb90-103"><a href="#cb90-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb90-104"><a href="#cb90-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-105"><a href="#cb90-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported values for those individuals (OT)</span></span>
<span id="cb90-106"><a href="#cb90-106" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb90-107"><a href="#cb90-107" aria-hidden="true" tabindex="-1"></a>  X0_t[<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>], </span>
<span id="cb90-108"><a href="#cb90-108" aria-hidden="true" tabindex="-1"></a>  X0_t[<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>], </span>
<span id="cb90-109"><a href="#cb90-109" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT"</span>]], <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb90-110"><a href="#cb90-110" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-111"><a href="#cb90-111" aria-hidden="true" tabindex="-1"></a><span class="co"># With OT_based matching</span></span>
<span id="cb90-112"><a href="#cb90-112" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb90-113"><a href="#cb90-113" aria-hidden="true" tabindex="-1"></a>  X0_tmatch[<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>], </span>
<span id="cb90-114"><a href="#cb90-114" aria-hidden="true" tabindex="-1"></a>  X0_tmatch[<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>], </span>
<span id="cb90-115"><a href="#cb90-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT-M"</span>]], <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb90-116"><a href="#cb90-116" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-117"><a href="#cb90-117" aria-hidden="true" tabindex="-1"></a><span class="co"># With Sinkhorn</span></span>
<span id="cb90-118"><a href="#cb90-118" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb90-119"><a href="#cb90-119" aria-hidden="true" tabindex="-1"></a>  X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>], </span>
<span id="cb90-120"><a href="#cb90-120" aria-hidden="true" tabindex="-1"></a>  X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>], </span>
<span id="cb90-121"><a href="#cb90-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"skh"</span>]], <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb90-122"><a href="#cb90-122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-123"><a href="#cb90-123" aria-hidden="true" tabindex="-1"></a><span class="co"># With Sequential transport (1)</span></span>
<span id="cb90-124"><a href="#cb90-124" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb90-125"><a href="#cb90-125" aria-hidden="true" tabindex="-1"></a>  X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb90-126"><a href="#cb90-126" aria-hidden="true" tabindex="-1"></a>  X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">2</span>], </span>
<span id="cb90-127"><a href="#cb90-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb90-128"><a href="#cb90-128" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-129"><a href="#cb90-129" aria-hidden="true" tabindex="-1"></a><span class="co"># With Sequential transport (2)</span></span>
<span id="cb90-130"><a href="#cb90-130" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb90-131"><a href="#cb90-131" aria-hidden="true" tabindex="-1"></a>  X0_st_21[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb90-132"><a href="#cb90-132" aria-hidden="true" tabindex="-1"></a>  X0_st_21[<span class="fu">c</span>(ind_closest), <span class="dv">2</span>], </span>
<span id="cb90-133"><a href="#cb90-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb90-134"><a href="#cb90-134" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-135"><a href="#cb90-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-136"><a href="#cb90-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-137"><a href="#cb90-137" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb90-138"><a href="#cb90-138" aria-hidden="true" tabindex="-1"></a>  lab_points_ot <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{OT}$"</span>)</span>
<span id="cb90-139"><a href="#cb90-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># round(tb_indiv_0$tau_i_ot[c(ind_closest)], 1)</span></span>
<span id="cb90-140"><a href="#cb90-140" aria-hidden="true" tabindex="-1"></a>  lab_points_tmatch <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{OT-M}$"</span>)</span>
<span id="cb90-141"><a href="#cb90-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># round(tb_indiv_0$tau_i_tmatch[c(ind_closest)], 1)</span></span>
<span id="cb90-142"><a href="#cb90-142" aria-hidden="true" tabindex="-1"></a>  lab_points_skh <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{SKH}$"</span>)</span>
<span id="cb90-143"><a href="#cb90-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># round(tb_indiv_0$tau_i_skh[c(ind_closest)], 1)</span></span>
<span id="cb90-144"><a href="#cb90-144" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_12 <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{ST(1)}$"</span>)</span>
<span id="cb90-145"><a href="#cb90-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(tb_indiv_0<span class="sc">$</span>tau_i_sot_12[<span class="fu">c</span>(ind_closest)], <span class="dv">1</span>)</span>
<span id="cb90-146"><a href="#cb90-146" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_21 <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{ST(2)}$"</span>)</span>
<span id="cb90-147"><a href="#cb90-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(tb_indiv_0<span class="sc">$</span>tau_i_sot_21[<span class="fu">c</span>(ind_closest)], <span class="dv">1</span>)</span>
<span id="cb90-148"><a href="#cb90-148" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb90-149"><a href="#cb90-149" aria-hidden="true" tabindex="-1"></a>  lab_points_ot <span class="ot">&lt;-</span> <span class="st">"OT"</span></span>
<span id="cb90-150"><a href="#cb90-150" aria-hidden="true" tabindex="-1"></a>  lab_points_tmatch <span class="ot">&lt;-</span> <span class="st">"OT-M"</span></span>
<span id="cb90-151"><a href="#cb90-151" aria-hidden="true" tabindex="-1"></a>  lab_points_skh <span class="ot">&lt;-</span> <span class="st">"SKH"</span></span>
<span id="cb90-152"><a href="#cb90-152" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_12 <span class="ot">&lt;-</span> <span class="st">"ST(1)"</span></span>
<span id="cb90-153"><a href="#cb90-153" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_21 <span class="ot">&lt;-</span> <span class="st">"ST(2)"</span></span>
<span id="cb90-154"><a href="#cb90-154" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>180 
4.9 </code></pre>
</div>
<details class="code-fold">
<summary>Codes to create the Figure</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># \tau_i with OT</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_t[<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>] <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_t[<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>] <span class="sc">+</span> .<span class="dv">5</span>, </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_ot,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT"</span>]]</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co"># \tau_i with OT-M</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_tmatch[<span class="fu">c</span>(ind_closest), <span class="st">"X1"</span>] <span class="sc">-</span><span class="fl">1.5</span>, </span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_tmatch[<span class="fu">c</span>(ind_closest), <span class="st">"X2"</span>] <span class="sc">+</span> .<span class="dv">5</span>, </span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_tmatch,</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT-M"</span>]]</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="co"># \tau_i with SKH</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_closest), <span class="dv">1</span>] <span class="sc">-</span> .<span class="dv">25</span>, </span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_closest), <span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_skh,</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"skh"</span>]]</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>], </span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_st_12[<span class="fu">c</span>(ind_closest), <span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_sot_12,</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"seq_1"</span>]]</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_st_21[<span class="fu">c</span>(ind_closest), <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_st_21[<span class="fu">c</span>(ind_closest), <span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_sot_21,</span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"seq_2"</span>]]</span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a><span class="do">## Farthest----</span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, .<span class="dv">1</span>, .<span class="dv">1</span>, .<span class="dv">1</span>))</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>  X0, </span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">16</span>, </span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe0, <span class="at">alpha =</span> .<span class="dv">3</span>), </span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> x_lim, <span class="at">ylim =</span> y_lim, </span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">""</span>,</span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> font_family,</span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> cex_pts</span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">labels =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a><span class="co"># axis(2, at = -3:3, labels = TRUE)</span></span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab=</span><span class="st">"X2"</span>, <span class="at">line=</span><span class="dv">2</span>, <span class="at">cex.lab=</span><span class="fl">1.2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X1, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colGpe1, <span class="at">alpha =</span> .<span class="dv">3</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> cex_pts)</span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Individuals of interest</span></span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrows to OT</span></span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-57"><a href="#cb92-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-58"><a href="#cb92-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_t[<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-59"><a href="#cb92-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_t[<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>],</span>
<span id="cb92-60"><a href="#cb92-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb92-61"><a href="#cb92-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb92-62"><a href="#cb92-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-63"><a href="#cb92-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrows to OT-Matching</span></span>
<span id="cb92-64"><a href="#cb92-64" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-65"><a href="#cb92-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-66"><a href="#cb92-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-67"><a href="#cb92-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_tmatch[<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-68"><a href="#cb92-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_tmatch[<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>],</span>
<span id="cb92-69"><a href="#cb92-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"OT-M"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb92-70"><a href="#cb92-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb92-71"><a href="#cb92-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-72"><a href="#cb92-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrows to SKH</span></span>
<span id="cb92-73"><a href="#cb92-73" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-74"><a href="#cb92-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-75"><a href="#cb92-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-76"><a href="#cb92-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-77"><a href="#cb92-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>],</span>
<span id="cb92-78"><a href="#cb92-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"skh"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>),</span>
<span id="cb92-79"><a href="#cb92-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb92-80"><a href="#cb92-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-81"><a href="#cb92-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Seq OT (1): X_1 first</span></span>
<span id="cb92-82"><a href="#cb92-82" aria-hidden="true" tabindex="-1"></a><span class="co"># points(</span></span>
<span id="cb92-83"><a href="#cb92-83" aria-hidden="true" tabindex="-1"></a><span class="co">#   X0_st_12[c(ind_farthest), 1], </span></span>
<span id="cb92-84"><a href="#cb92-84" aria-hidden="true" tabindex="-1"></a><span class="co">#   X0$X2[c(ind_farthest)], </span></span>
<span id="cb92-85"><a href="#cb92-85" aria-hidden="true" tabindex="-1"></a><span class="co">#   col = adjustcolor(colour_methods[["seq_1"]], alpha = .5), pch = 16, cex = 1</span></span>
<span id="cb92-86"><a href="#cb92-86" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb92-87"><a href="#cb92-87" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-88"><a href="#cb92-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)], </span>
<span id="cb92-89"><a href="#cb92-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-90"><a href="#cb92-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-91"><a href="#cb92-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-92"><a href="#cb92-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb92-93"><a href="#cb92-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb92-94"><a href="#cb92-94" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-95"><a href="#cb92-95" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-96"><a href="#cb92-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-97"><a href="#cb92-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-98"><a href="#cb92-98" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-99"><a href="#cb92-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">2</span>],</span>
<span id="cb92-100"><a href="#cb92-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb92-101"><a href="#cb92-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb92-102"><a href="#cb92-102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-103"><a href="#cb92-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Seq OT (2): X_2 first</span></span>
<span id="cb92-104"><a href="#cb92-104" aria-hidden="true" tabindex="-1"></a><span class="co"># points(</span></span>
<span id="cb92-105"><a href="#cb92-105" aria-hidden="true" tabindex="-1"></a><span class="co">#   X0$X1[c(ind_farthest)], </span></span>
<span id="cb92-106"><a href="#cb92-106" aria-hidden="true" tabindex="-1"></a><span class="co">#   X0_st_21[c(ind_farthest),2], </span></span>
<span id="cb92-107"><a href="#cb92-107" aria-hidden="true" tabindex="-1"></a><span class="co">#   col = adjustcolor(colour_methods[["seq_2"]], alpha = .5), pch = 16, cex = 1</span></span>
<span id="cb92-108"><a href="#cb92-108" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb92-109"><a href="#cb92-109" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-110"><a href="#cb92-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)], </span>
<span id="cb92-111"><a href="#cb92-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)],</span>
<span id="cb92-112"><a href="#cb92-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)], </span>
<span id="cb92-113"><a href="#cb92-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_st_21[<span class="fu">c</span>(ind_farthest),<span class="dv">2</span>],</span>
<span id="cb92-114"><a href="#cb92-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb92-115"><a href="#cb92-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb92-116"><a href="#cb92-116" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-117"><a href="#cb92-117" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(</span>
<span id="cb92-118"><a href="#cb92-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> X0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)], </span>
<span id="cb92-119"><a href="#cb92-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> X0_st_21[<span class="fu">c</span>(ind_farthest),<span class="dv">2</span>],</span>
<span id="cb92-120"><a href="#cb92-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> X0_st_21[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-121"><a href="#cb92-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> X0_st_21[<span class="fu">c</span>(ind_farthest), <span class="dv">2</span>],</span>
<span id="cb92-122"><a href="#cb92-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> length_arrow, <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb92-123"><a href="#cb92-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> lwd_arrow</span>
<span id="cb92-124"><a href="#cb92-124" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-125"><a href="#cb92-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-126"><a href="#cb92-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Individuals</span></span>
<span id="cb92-127"><a href="#cb92-127" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb92-128"><a href="#cb92-128" aria-hidden="true" tabindex="-1"></a>  tb_indiv_0<span class="sc">$</span>X1[<span class="fu">c</span>(ind_farthest)], </span>
<span id="cb92-129"><a href="#cb92-129" aria-hidden="true" tabindex="-1"></a>  tb_indiv_0<span class="sc">$</span>X2[<span class="fu">c</span>(ind_farthest)], </span>
<span id="cb92-130"><a href="#cb92-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb92-131"><a href="#cb92-131" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-132"><a href="#cb92-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported values for those individuals (OT)</span></span>
<span id="cb92-133"><a href="#cb92-133" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb92-134"><a href="#cb92-134" aria-hidden="true" tabindex="-1"></a>  X0_t[<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-135"><a href="#cb92-135" aria-hidden="true" tabindex="-1"></a>  X0_t[<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>], </span>
<span id="cb92-136"><a href="#cb92-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT"</span>]], <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb92-137"><a href="#cb92-137" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-138"><a href="#cb92-138" aria-hidden="true" tabindex="-1"></a><span class="co"># With OT-Matching</span></span>
<span id="cb92-139"><a href="#cb92-139" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb92-140"><a href="#cb92-140" aria-hidden="true" tabindex="-1"></a>  X0_tmatch[<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-141"><a href="#cb92-141" aria-hidden="true" tabindex="-1"></a>  X0_tmatch[<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>], </span>
<span id="cb92-142"><a href="#cb92-142" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT-M"</span>]], <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb92-143"><a href="#cb92-143" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-144"><a href="#cb92-144" aria-hidden="true" tabindex="-1"></a><span class="co"># With Sinkhorn</span></span>
<span id="cb92-145"><a href="#cb92-145" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb92-146"><a href="#cb92-146" aria-hidden="true" tabindex="-1"></a>  X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-147"><a href="#cb92-147" aria-hidden="true" tabindex="-1"></a>  X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>], </span>
<span id="cb92-148"><a href="#cb92-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"skh"</span>]], <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>), <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb92-149"><a href="#cb92-149" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-150"><a href="#cb92-150" aria-hidden="true" tabindex="-1"></a><span class="co"># With Sequential transport (1)</span></span>
<span id="cb92-151"><a href="#cb92-151" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb92-152"><a href="#cb92-152" aria-hidden="true" tabindex="-1"></a>  X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-153"><a href="#cb92-153" aria-hidden="true" tabindex="-1"></a>  X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">2</span>], </span>
<span id="cb92-154"><a href="#cb92-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_1"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb92-155"><a href="#cb92-155" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-156"><a href="#cb92-156" aria-hidden="true" tabindex="-1"></a><span class="co"># With Sequential transport (2)</span></span>
<span id="cb92-157"><a href="#cb92-157" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb92-158"><a href="#cb92-158" aria-hidden="true" tabindex="-1"></a>  X0_st_21[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-159"><a href="#cb92-159" aria-hidden="true" tabindex="-1"></a>  X0_st_21[<span class="fu">c</span>(ind_farthest), <span class="dv">2</span>], </span>
<span id="cb92-160"><a href="#cb92-160" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">adjustcolor</span>(colour_methods[[<span class="st">"seq_2"</span>]], <span class="at">alpha =</span> <span class="dv">1</span>), <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> <span class="dv">1</span></span>
<span id="cb92-161"><a href="#cb92-161" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-162"><a href="#cb92-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-163"><a href="#cb92-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-164"><a href="#cb92-164" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb92-165"><a href="#cb92-165" aria-hidden="true" tabindex="-1"></a>  lab_points_ot <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{OT}"</span>)</span>
<span id="cb92-166"><a href="#cb92-166" aria-hidden="true" tabindex="-1"></a>  lab_points_tmatch <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{OT-M}$"</span>)</span>
<span id="cb92-167"><a href="#cb92-167" aria-hidden="true" tabindex="-1"></a>  lab_points_skh <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{SKH}$"</span>)</span>
<span id="cb92-168"><a href="#cb92-168" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_12 <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{ST(1)}$"</span>)</span>
<span id="cb92-169"><a href="#cb92-169" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_21 <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i^{ST(2)}$"</span>)</span>
<span id="cb92-170"><a href="#cb92-170" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-171"><a href="#cb92-171" aria-hidden="true" tabindex="-1"></a>  lab_points_ot <span class="ot">&lt;-</span> <span class="st">"OT"</span></span>
<span id="cb92-172"><a href="#cb92-172" aria-hidden="true" tabindex="-1"></a>  lab_points_tmatch <span class="ot">&lt;-</span> <span class="st">"OT-M"</span></span>
<span id="cb92-173"><a href="#cb92-173" aria-hidden="true" tabindex="-1"></a>  lab_points_skh <span class="ot">&lt;-</span> <span class="st">"SKH"</span></span>
<span id="cb92-174"><a href="#cb92-174" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_12 <span class="ot">&lt;-</span> <span class="st">"ST(1)"</span></span>
<span id="cb92-175"><a href="#cb92-175" aria-hidden="true" tabindex="-1"></a>  lab_points_sot_21 <span class="ot">&lt;-</span> <span class="st">"ST(2)"</span></span>
<span id="cb92-176"><a href="#cb92-176" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-177"><a href="#cb92-177" aria-hidden="true" tabindex="-1"></a><span class="co"># \tau with OT</span></span>
<span id="cb92-178"><a href="#cb92-178" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-179"><a href="#cb92-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_t[<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>], </span>
<span id="cb92-180"><a href="#cb92-180" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_t[<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>] <span class="sc">+</span> .<span class="dv">75</span>, </span>
<span id="cb92-181"><a href="#cb92-181" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_ot,</span>
<span id="cb92-182"><a href="#cb92-182" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT"</span>]]</span>
<span id="cb92-183"><a href="#cb92-183" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-184"><a href="#cb92-184" aria-hidden="true" tabindex="-1"></a><span class="co"># \tau with OT-Matching</span></span>
<span id="cb92-185"><a href="#cb92-185" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-186"><a href="#cb92-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_tmatch[<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>] <span class="sc">-</span> .<span class="dv">25</span>, </span>
<span id="cb92-187"><a href="#cb92-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_tmatch[<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>] <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb92-188"><a href="#cb92-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_tmatch,</span>
<span id="cb92-189"><a href="#cb92-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"OT-M"</span>]]</span>
<span id="cb92-190"><a href="#cb92-190" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-191"><a href="#cb92-191" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-192"><a href="#cb92-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_farthest), <span class="st">"X1"</span>] <span class="sc">-</span> <span class="fl">1.5</span>, </span>
<span id="cb92-193"><a href="#cb92-193" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_skh_l[[<span class="st">"0.1"</span>]][<span class="fu">c</span>(ind_farthest), <span class="st">"X2"</span>], </span>
<span id="cb92-194"><a href="#cb92-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_skh,</span>
<span id="cb92-195"><a href="#cb92-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"skh"</span>]]</span>
<span id="cb92-196"><a href="#cb92-196" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-197"><a href="#cb92-197" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-198"><a href="#cb92-198" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-199"><a href="#cb92-199" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_st_12[<span class="fu">c</span>(ind_farthest), <span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb92-200"><a href="#cb92-200" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_sot_12,</span>
<span id="cb92-201"><a href="#cb92-201" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"seq_1"</span>]]</span>
<span id="cb92-202"><a href="#cb92-202" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-203"><a href="#cb92-203" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb92-204"><a href="#cb92-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> X0_st_21[<span class="fu">c</span>(ind_farthest), <span class="dv">1</span>], </span>
<span id="cb92-205"><a href="#cb92-205" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> X0_st_21[<span class="fu">c</span>(ind_farthest), <span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb92-206"><a href="#cb92-206" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> lab_points_sot_21,</span>
<span id="cb92-207"><a href="#cb92-207" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_methods[[<span class="st">"seq_2"</span>]]</span>
<span id="cb92-208"><a href="#cb92-208" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="gaussian-example_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Codes to create the Figure</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_to_pdf</span>(<span class="at">filename =</span> file_name, <span class="at">path =</span> <span class="st">"./figs/"</span>, <span class="at">keep_tex =</span> <span class="cn">FALSE</span>, <span class="at">crop =</span> <span class="cn">FALSE</span>)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="monte-carlo-simulations" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="monte-carlo-simulations"><span class="header-section-number">5.4</span> Monte-Carlo Simulations</h2>
<p>Let us perform Monte-Carlo simulations to observe the stability of the previous estimations. We define a function, <code class="sourceCode r"><span class="fu">sim_f</span>()</code>, to perform three steps:</p>
<ol type="1">
<li>Generate a sample from the DGP shown in <a href="xp-simulated.html#sec-dgp" class="quarto-xref"><span>Section 13.1</span></a>,</li>
<li>Build the counterfactuals using OT, entropy regularized transport, and Sequential transport as in <a href="#sec-cf" class="quarto-xref"><span>Section 5.2</span></a>,</li>
<li>Compute the causal effects as in <a href="#sec-causal-effects" class="quarto-xref"><span>Section 5.3</span></a>.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">sim_f</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>sim_f <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">500</span>,</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>                  mu0, </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>                  mu1, </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>                  r0, </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>                  r1, </span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>                  a, </span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Generate data</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">500</span>, </span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu0 =</span> mu0, <span class="at">mu1 =</span> mu1, </span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">r0 =</span> r0, <span class="at">r1 =</span> r1, <span class="at">a =</span> a, </span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Building Counterfactuals</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## With Optimal Transport</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transporting map for source: group 1, target: group 0 (careful here)</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>  Sigma0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r0, r0, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>  Sigma1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, r1, r1, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>  Mu0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu0, <span class="dv">2</span>)</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>  Mu1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(a <span class="sc">*</span> mu1, <span class="dv">2</span>)</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mapping from group 0 to group 1</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>  ot_map_0_to_1 <span class="ot">&lt;-</span> <span class="fu">compute_ot_map</span>(</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_source =</span> Mu0, <span class="at">sigma_source =</span> Sigma0, </span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_target =</span> Mu1, <span class="at">sigma_target =</span> Sigma1</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mapping from group 1 to group 0</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>  ot_map_1_to_0 <span class="ot">&lt;-</span> <span class="fu">compute_ot_map</span>(</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_source =</span> Mu1, <span class="at">sigma_source =</span> Sigma0, </span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_target =</span> Mu0, <span class="at">sigma_target =</span> Sigma0</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply transport map to treated units (A = 1)</span></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>  X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>  X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[df<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>  X0_t <span class="ot">&lt;-</span> <span class="fu">apply_ot_transport</span>(<span class="at">X =</span> X0, <span class="at">mapping =</span> ot_map_0_to_1)</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X0_t) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>))</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>  X1_t <span class="ot">&lt;-</span> <span class="fu">apply_ot_transport</span>(<span class="at">X =</span> X1, <span class="at">mapping =</span> ot_map_1_to_0)</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X1_t) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>))</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With OT-Matching</span></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a>  X0_tmatch <span class="ot">&lt;-</span> <span class="fu">transport_many_to_one</span>(<span class="at">X_source =</span> X0, <span class="at">X_target =</span> X1)</span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>  X1_tmatch <span class="ot">&lt;-</span> <span class="fu">transport_many_to_one</span>(<span class="at">X_source =</span> X1, <span class="at">X_target =</span> X0)</span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a>  <span class="do">## With Entropy regularized transport</span></span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport from group 0 to group 1:</span></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a>  X0_skh <span class="ot">&lt;-</span> <span class="fu">transport_regul</span>(</span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_source =</span> X0, </span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_target =</span> X1, </span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> <span class="fl">0.1</span></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport from group 1 to group 0:</span></span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a>  X1_skh <span class="ot">&lt;-</span> <span class="fu">transport_regul</span>(</span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_source =</span> X1, </span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">X_target =</span> X0, </span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> <span class="fl">0.1</span></span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## With Sequential Transport</span></span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport from group 0 to group 1: X1 then X2 | X1</span></span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a>  X0_st_12 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_12</span>(</span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> X0, <span class="at">M_source =</span> Mu0, <span class="at">S_source =</span> Sigma0, <span class="at">M_target =</span> Mu1, <span class="at">S_target =</span> Sigma1</span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-70"><a href="#cb94-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport from group 1 to group 0: X1 then X2 | X1</span></span>
<span id="cb94-71"><a href="#cb94-71" aria-hidden="true" tabindex="-1"></a>  X1_st_12 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_12</span>(</span>
<span id="cb94-72"><a href="#cb94-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> X1, <span class="at">M_source =</span> Mu1, <span class="at">S_source =</span> Sigma1, <span class="at">M_target =</span> Mu0, <span class="at">S_target =</span> Sigma0</span>
<span id="cb94-73"><a href="#cb94-73" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-74"><a href="#cb94-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport from group 0 to group 1: X2 then X1 | X2</span></span>
<span id="cb94-75"><a href="#cb94-75" aria-hidden="true" tabindex="-1"></a>  X0_st_21 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_21</span>(</span>
<span id="cb94-76"><a href="#cb94-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> X0, <span class="at">M_source =</span> Mu0, <span class="at">S_source =</span> Sigma0, <span class="at">M_target =</span> Mu1, <span class="at">S_target =</span> Sigma1</span>
<span id="cb94-77"><a href="#cb94-77" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-78"><a href="#cb94-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport from group 1 to group 0: X2 then X1 | X2</span></span>
<span id="cb94-79"><a href="#cb94-79" aria-hidden="true" tabindex="-1"></a>  X1_st_21 <span class="ot">&lt;-</span> <span class="fu">sequential_transport_21</span>(</span>
<span id="cb94-80"><a href="#cb94-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> X1, <span class="at">M_source =</span> Mu1, <span class="at">S_source =</span> Sigma1, <span class="at">M_target =</span> Mu0, <span class="at">S_target =</span> Sigma0</span>
<span id="cb94-81"><a href="#cb94-81" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-82"><a href="#cb94-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-83"><a href="#cb94-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Measuring Total Causal Effect</span></span>
<span id="cb94-84"><a href="#cb94-84" aria-hidden="true" tabindex="-1"></a>  tb <span class="ot">&lt;-</span> df[, <span class="fu">c</span>(<span class="st">"Y"</span>, <span class="st">"A"</span>, <span class="st">"X1"</span>, <span class="st">"X2"</span>)]</span>
<span id="cb94-85"><a href="#cb94-85" aria-hidden="true" tabindex="-1"></a>  A_name <span class="ot">&lt;-</span> <span class="st">"A"</span></span>
<span id="cb94-86"><a href="#cb94-86" aria-hidden="true" tabindex="-1"></a>  A_untreated <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb94-87"><a href="#cb94-87" aria-hidden="true" tabindex="-1"></a>  Y_name <span class="ot">&lt;-</span> <span class="st">"Y"</span></span>
<span id="cb94-88"><a href="#cb94-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-89"><a href="#cb94-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Causal Mediation Analysis</span></span>
<span id="cb94-90"><a href="#cb94-90" aria-hidden="true" tabindex="-1"></a>  med_mod_12 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb94-91"><a href="#cb94-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb94-92"><a href="#cb94-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.main =</span> <span class="st">"X1"</span>, </span>
<span id="cb94-93"><a href="#cb94-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.alt =</span> <span class="st">"X2"</span>, </span>
<span id="cb94-94"><a href="#cb94-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb94-95"><a href="#cb94-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df</span>
<span id="cb94-96"><a href="#cb94-96" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-97"><a href="#cb94-97" aria-hidden="true" tabindex="-1"></a>  med_mod_21 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb94-98"><a href="#cb94-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb94-99"><a href="#cb94-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.main =</span> <span class="st">"X2"</span>, </span>
<span id="cb94-100"><a href="#cb94-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.alt =</span> <span class="st">"X1"</span>, </span>
<span id="cb94-101"><a href="#cb94-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb94-102"><a href="#cb94-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df</span>
<span id="cb94-103"><a href="#cb94-103" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-104"><a href="#cb94-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-105"><a href="#cb94-105" aria-hidden="true" tabindex="-1"></a>  delta_0_med <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_12<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_12<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb94-106"><a href="#cb94-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((med_mod_21<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_21<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb94-107"><a href="#cb94-107" aria-hidden="true" tabindex="-1"></a>  delta_1_med <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_12<span class="sc">$</span>d1.lb <span class="sc">+</span> med_mod_12<span class="sc">$</span>d1.ub) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb94-108"><a href="#cb94-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((med_mod_21<span class="sc">$</span>d1.lb <span class="sc">+</span> med_mod_21<span class="sc">$</span>d1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb94-109"><a href="#cb94-109" aria-hidden="true" tabindex="-1"></a>  tot_effect_med <span class="ot">&lt;-</span> med_mod_12<span class="sc">$</span>tau</span>
<span id="cb94-110"><a href="#cb94-110" aria-hidden="true" tabindex="-1"></a>  zeta_0_med <span class="ot">&lt;-</span> tot_effect_med <span class="sc">-</span> delta_1_med</span>
<span id="cb94-111"><a href="#cb94-111" aria-hidden="true" tabindex="-1"></a>  zeta_1_med <span class="ot">&lt;-</span> tot_effect_med<span class="sc">-</span>delta_0_med</span>
<span id="cb94-112"><a href="#cb94-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-113"><a href="#cb94-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With OT counterfactuals</span></span>
<span id="cb94-114"><a href="#cb94-114" aria-hidden="true" tabindex="-1"></a>  tb_untreated <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(A_name) <span class="sc">==</span> <span class="sc">!!</span>A_untreated)</span>
<span id="cb94-115"><a href="#cb94-115" aria-hidden="true" tabindex="-1"></a>  tb_treated <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(A_name) <span class="sc">!=</span> <span class="sc">!!</span>A_untreated)</span>
<span id="cb94-116"><a href="#cb94-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-117"><a href="#cb94-117" aria-hidden="true" tabindex="-1"></a>  causal_effects_ot <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb94-118"><a href="#cb94-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb94-119"><a href="#cb94-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb94-120"><a href="#cb94-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_t),</span>
<span id="cb94-121"><a href="#cb94-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_t),</span>
<span id="cb94-122"><a href="#cb94-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb94-123"><a href="#cb94-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb94-124"><a href="#cb94-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb94-125"><a href="#cb94-125" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-126"><a href="#cb94-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-127"><a href="#cb94-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With OT-Matching counterfactuals</span></span>
<span id="cb94-128"><a href="#cb94-128" aria-hidden="true" tabindex="-1"></a>  causal_effects_tmatch <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb94-129"><a href="#cb94-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb94-130"><a href="#cb94-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb94-131"><a href="#cb94-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_tmatch),</span>
<span id="cb94-132"><a href="#cb94-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_tmatch),</span>
<span id="cb94-133"><a href="#cb94-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb94-134"><a href="#cb94-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb94-135"><a href="#cb94-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb94-136"><a href="#cb94-136" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-137"><a href="#cb94-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-138"><a href="#cb94-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With entropy regularized transport</span></span>
<span id="cb94-139"><a href="#cb94-139" aria-hidden="true" tabindex="-1"></a>  causal_effects_skh <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb94-140"><a href="#cb94-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb94-141"><a href="#cb94-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb94-142"><a href="#cb94-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_skh),</span>
<span id="cb94-143"><a href="#cb94-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_skh),</span>
<span id="cb94-144"><a href="#cb94-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb94-145"><a href="#cb94-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb94-146"><a href="#cb94-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb94-147"><a href="#cb94-147" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-148"><a href="#cb94-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-149"><a href="#cb94-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With Sequential Transport counterfactuals</span></span>
<span id="cb94-150"><a href="#cb94-150" aria-hidden="true" tabindex="-1"></a>  causal_effect_sot_12 <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb94-151"><a href="#cb94-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb94-152"><a href="#cb94-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb94-153"><a href="#cb94-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_st_12) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb94-154"><a href="#cb94-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_st_12) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb94-155"><a href="#cb94-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb94-156"><a href="#cb94-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb94-157"><a href="#cb94-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb94-158"><a href="#cb94-158" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-159"><a href="#cb94-159" aria-hidden="true" tabindex="-1"></a>  causal_effect_sot_21 <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb94-160"><a href="#cb94-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb94-161"><a href="#cb94-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb94-162"><a href="#cb94-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(X0_st_21) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb94-163"><a href="#cb94-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_treated =</span> <span class="fu">as_tibble</span>(X1_st_21) <span class="sc">|&gt;</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)),</span>
<span id="cb94-164"><a href="#cb94-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb94-165"><a href="#cb94-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb94-166"><a href="#cb94-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb94-167"><a href="#cb94-167" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-168"><a href="#cb94-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-169"><a href="#cb94-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb94-170"><a href="#cb94-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mediation</span></span>
<span id="cb94-171"><a href="#cb94-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_med =</span> delta_0_med,</span>
<span id="cb94-172"><a href="#cb94-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_med =</span> delta_1_med,</span>
<span id="cb94-173"><a href="#cb94-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_med =</span> zeta_0_med,</span>
<span id="cb94-174"><a href="#cb94-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_med =</span> zeta_1_med,</span>
<span id="cb94-175"><a href="#cb94-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_med =</span> tot_effect_med,</span>
<span id="cb94-176"><a href="#cb94-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OT</span></span>
<span id="cb94-177"><a href="#cb94-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_ot =</span> causal_effects_ot<span class="sc">$</span>delta_0,</span>
<span id="cb94-178"><a href="#cb94-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_ot =</span> causal_effects_ot<span class="sc">$</span>delta_1,</span>
<span id="cb94-179"><a href="#cb94-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_ot_obs =</span> causal_effects_ot<span class="sc">$</span>delta_0_obs,</span>
<span id="cb94-180"><a href="#cb94-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_ot_obs =</span> causal_effects_ot<span class="sc">$</span>delta_1_obs,</span>
<span id="cb94-181"><a href="#cb94-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_ot =</span> causal_effects_ot<span class="sc">$</span>zeta_0,</span>
<span id="cb94-182"><a href="#cb94-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_ot =</span> causal_effects_ot<span class="sc">$</span>zeta_1,</span>
<span id="cb94-183"><a href="#cb94-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_ot =</span> causal_effects_ot<span class="sc">$</span>tot_effect,</span>
<span id="cb94-184"><a href="#cb94-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_ot_obs =</span> causal_effects_ot<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb94-185"><a href="#cb94-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OT-M</span></span>
<span id="cb94-186"><a href="#cb94-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>delta_0,</span>
<span id="cb94-187"><a href="#cb94-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>delta_1,</span>
<span id="cb94-188"><a href="#cb94-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_tmatch_obs =</span> causal_effects_tmatch<span class="sc">$</span>delta_0_obs,</span>
<span id="cb94-189"><a href="#cb94-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_tmatch_obs =</span> causal_effects_tmatch<span class="sc">$</span>delta_1_obs,</span>
<span id="cb94-190"><a href="#cb94-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>zeta_0,</span>
<span id="cb94-191"><a href="#cb94-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>zeta_1,</span>
<span id="cb94-192"><a href="#cb94-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_tmatch =</span> causal_effects_tmatch<span class="sc">$</span>tot_effect,</span>
<span id="cb94-193"><a href="#cb94-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_tmatch_obs =</span> causal_effects_tmatch<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb94-194"><a href="#cb94-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SKH</span></span>
<span id="cb94-195"><a href="#cb94-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_skh =</span> causal_effects_skh<span class="sc">$</span>delta_0,</span>
<span id="cb94-196"><a href="#cb94-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_skh =</span> causal_effects_skh<span class="sc">$</span>delta_1,</span>
<span id="cb94-197"><a href="#cb94-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_skh_obs =</span> causal_effects_skh<span class="sc">$</span>delta_0_obs,</span>
<span id="cb94-198"><a href="#cb94-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_skh_obs =</span> causal_effects_skh<span class="sc">$</span>delta_1_obs,</span>
<span id="cb94-199"><a href="#cb94-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_skh =</span> causal_effects_skh<span class="sc">$</span>zeta_0,</span>
<span id="cb94-200"><a href="#cb94-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_skh =</span> causal_effects_skh<span class="sc">$</span>zeta_1,</span>
<span id="cb94-201"><a href="#cb94-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_skh =</span> causal_effects_skh<span class="sc">$</span>tot_effect,</span>
<span id="cb94-202"><a href="#cb94-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_skh_obs =</span> causal_effects_skh<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb94-203"><a href="#cb94-203" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SOT 12</span></span>
<span id="cb94-204"><a href="#cb94-204" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>delta_0,</span>
<span id="cb94-205"><a href="#cb94-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>delta_1,</span>
<span id="cb94-206"><a href="#cb94-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_sot_12_obs =</span> causal_effect_sot_12<span class="sc">$</span>delta_0_obs,</span>
<span id="cb94-207"><a href="#cb94-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_sot_12_obs =</span> causal_effect_sot_12<span class="sc">$</span>delta_1_obs,</span>
<span id="cb94-208"><a href="#cb94-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>zeta_0,</span>
<span id="cb94-209"><a href="#cb94-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>zeta_1,</span>
<span id="cb94-210"><a href="#cb94-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_sot_12 =</span> causal_effect_sot_12<span class="sc">$</span>tot_effect,</span>
<span id="cb94-211"><a href="#cb94-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_sot_12_obs =</span> causal_effect_sot_12<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb94-212"><a href="#cb94-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SOT 21</span></span>
<span id="cb94-213"><a href="#cb94-213" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>delta_0,</span>
<span id="cb94-214"><a href="#cb94-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>delta_1,</span>
<span id="cb94-215"><a href="#cb94-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_sot_21_obs =</span> causal_effect_sot_21<span class="sc">$</span>delta_0_obs,</span>
<span id="cb94-216"><a href="#cb94-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_1_sot_21_obs =</span> causal_effect_sot_21<span class="sc">$</span>delta_1_obs,</span>
<span id="cb94-217"><a href="#cb94-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_0_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>zeta_0,</span>
<span id="cb94-218"><a href="#cb94-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>zeta_1,</span>
<span id="cb94-219"><a href="#cb94-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_sot_21 =</span> causal_effect_sot_21<span class="sc">$</span>tot_effect,</span>
<span id="cb94-220"><a href="#cb94-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_sot_21_obs =</span> causal_effect_sot_21<span class="sc">$</span>tot_effect_obs,</span>
<span id="cb94-221"><a href="#cb94-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n,</span>
<span id="cb94-222"><a href="#cb94-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb94-223"><a href="#cb94-223" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu0 =</span> mu0,</span>
<span id="cb94-224"><a href="#cb94-224" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu1 =</span> mu1,</span>
<span id="cb94-225"><a href="#cb94-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">r0 =</span> r0,</span>
<span id="cb94-226"><a href="#cb94-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">r1 =</span> r1,</span>
<span id="cb94-227"><a href="#cb94-227" aria-hidden="true" tabindex="-1"></a>    <span class="at">a =</span> a</span>
<span id="cb94-228"><a href="#cb94-228" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-229"><a href="#cb94-229" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The simulations can be run in parallel, as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This chunk takes 3 minutes and 40 seconds to run</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (MB Pro 2023, Apple M2 Pro ship, 32 GB RAM).</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We do not evaluate when compiling the document.</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead, we load previously obtained results.</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>ncl <span class="ot">&lt;-</span> <span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>(cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncl))</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(cl, {</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(mnormt)</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(expm)</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(randomForest)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>()</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterExport</span>(</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cl, <span class="fu">c</span>(</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gen_data"</span>, <span class="st">"compute_ot_map"</span>, <span class="st">"apply_ot_transport"</span>,</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"transport_regul"</span>, <span class="st">"transport_many_to_one"</span>,</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sequential_transport_12"</span>, <span class="st">"sequential_transport_21"</span>,</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"causal_effects_cf"</span>, <span class="st">"sim_f"</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>res_sim <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>, <span class="cf">function</span>(seed) {</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sim_f</span>(<span class="at">n =</span> <span class="dv">500</span>, <span class="at">mu0 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">mu1 =</span> <span class="sc">+</span><span class="dv">1</span>, <span class="at">r0 =</span> <span class="sc">+</span>.<span class="dv">7</span>, <span class="at">r1 =</span> <span class="sc">-</span>.<span class="dv">5</span>, <span class="at">a =</span> <span class="dv">1</span>, <span class="at">seed =</span> seed)</span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>}, <span class="at">cl =</span> cl)</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>res_sim <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(res_sim)</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(res_sim, <span class="at">file =</span> <span class="st">"../output/res_sim-gaussian-mc-a1.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We load previously obtained results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/res_sim-gaussian-mc-a1.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @parma metric_name Name of the metric (e.g., "tot_effect_ot")</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param method_label Label of the method (for title, e.g., "OT")</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>plot_hist_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(metric_name, </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>                          method_label,</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">x_lim =</span> <span class="cn">NULL</span>,</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y_axis =</span> <span class="cn">TRUE</span>,</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">export_tikz =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># type &lt;- match.arg(type)</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  type <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(metric_name, <span class="st">"^delta"</span>) <span class="sc">~</span> <span class="st">"delta"</span>,</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(metric_name, <span class="st">"^zeta"</span>) <span class="sc">~</span> <span class="st">"zeta"</span>,</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(metric_name, <span class="st">"^tot_effect"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(metric_name, <span class="st">"obs$"</span>) <span class="sc">~</span> <span class="st">"tau"</span>,</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(metric_name, <span class="st">"^tot_effect"</span>) <span class="sc">&amp;</span> <span class="fu">str_detect</span>(metric_name, <span class="st">"obs$"</span>) <span class="sc">~</span> <span class="st">"theta"</span>,</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>  group <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(metric_name, <span class="st">"_0_"</span>) <span class="sc">~</span> <span class="st">"0"</span>,</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(metric_name, <span class="st">"_1_"</span>) <span class="sc">~</span> <span class="st">"1"</span>,</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"delta"</span>) {</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>    title_lab <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">delta}_"</span>, group, <span class="st">"$, "</span>, method_label)</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"zeta"</span>) {</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>    title_lab <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">zeta}_"</span>, group, <span class="st">"$, "</span>, method_label)</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"tau"</span>) {</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    title_lab <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">tau}$, "</span>, method_label)</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>    title_lab <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">theta}$, "</span>, method_label)</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>    title_lab <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(title_lab)</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (group <span class="sc">==</span> <span class="st">"0"</span>) {</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>    fill_col <span class="ot">&lt;-</span> colGpe0</span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (group <span class="sc">==</span> <span class="st">"1"</span>) {</span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>    fill_col <span class="ot">&lt;-</span> colGpe1</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>    fill_col <span class="ot">&lt;-</span> <span class="st">"gray"</span></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(x_lim)) x_lim <span class="ot">&lt;-</span> <span class="fu">range</span>(res_sim <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>metric_name))</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>(</span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>    res_sim <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>metric_name), </span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> title_lab,</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">""</span>,</span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="fu">adjustcolor</span>(fill_col, <span class="at">alpha =</span> .<span class="dv">5</span>),</span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> x_lim,</span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (y_axis <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="fu">axis</span>(<span class="dv">2</span>)</span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"delta"</span>) {</span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> (a1<span class="sc">+</span>a2)<span class="sc">*</span>(mu1<span class="sc">-</span>mu0), <span class="at">col =</span> <span class="st">"darkred"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"zeta"</span>) {</span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> a0, <span class="at">col =</span> <span class="st">"darkred"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"tau"</span>, <span class="st">"theta"</span>)) {</span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> (a1<span class="sc">+</span>a2)<span class="sc">*</span>(mu1<span class="sc">-</span>mu0) <span class="sc">+</span> a0, <span class="at">col =</span> <span class="st">"darkred"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>export_tikz <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="st">"gaussian-hist-mc"</span></span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tikz</span>(<span class="fu">paste0</span>(<span class="st">"figs/"</span>, file_name, <span class="st">".tex"</span>), <span class="at">width =</span> <span class="fl">2.8</span>, <span class="at">height =</span> <span class="fl">2.8</span>)</span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, .<span class="dv">5</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">3</span>))</span>
<span id="cb97-73"><a href="#cb97-73" aria-hidden="true" tabindex="-1"></a><span class="co"># CM</span></span>
<span id="cb97-74"><a href="#cb97-74" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_0_med"</span>, <span class="at">method_label =</span> <span class="st">"CM"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-75"><a href="#cb97-75" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_1_med"</span>, <span class="at">method_label =</span> <span class="st">"CM"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-76"><a href="#cb97-76" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_med"</span>, <span class="at">method_label =</span> <span class="st">"CM"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-77"><a href="#cb97-77" aria-hidden="true" tabindex="-1"></a><span class="co"># OT</span></span>
<span id="cb97-78"><a href="#cb97-78" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_0_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-79"><a href="#cb97-79" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_1_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-80"><a href="#cb97-80" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-81"><a href="#cb97-81" aria-hidden="true" tabindex="-1"></a><span class="co"># OT-M</span></span>
<span id="cb97-82"><a href="#cb97-82" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_0_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-83"><a href="#cb97-83" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_1_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-84"><a href="#cb97-84" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-85"><a href="#cb97-85" aria-hidden="true" tabindex="-1"></a><span class="co"># SKH</span></span>
<span id="cb97-86"><a href="#cb97-86" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_0_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-87"><a href="#cb97-87" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_1_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-88"><a href="#cb97-88" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-89"><a href="#cb97-89" aria-hidden="true" tabindex="-1"></a><span class="co"># ST(1)</span></span>
<span id="cb97-90"><a href="#cb97-90" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_0_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-91"><a href="#cb97-91" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_1_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-92"><a href="#cb97-92" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim=</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-93"><a href="#cb97-93" aria-hidden="true" tabindex="-1"></a><span class="co"># ST(2)</span></span>
<span id="cb97-94"><a href="#cb97-94" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_0_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-95"><a href="#cb97-95" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_1_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-96"><a href="#cb97-96" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim=</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb97-97"><a href="#cb97-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-98"><a href="#cb97-98" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb97-99"><a href="#cb97-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb97-100"><a href="#cb97-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_to_pdf</span>(<span class="at">filename =</span> file_name, <span class="at">path =</span> <span class="st">"./figs/"</span>, <span class="at">keep_tex =</span> <span class="cn">FALSE</span>, <span class="at">crop =</span> <span class="cn">TRUE</span>)</span>
<span id="cb97-101"><a href="#cb97-101" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-hist-mc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-hist-mc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7: Estimated values of <span class="math inline">\(\bar{\delta}(0)\)</span>, <span class="math inline">\(\bar{\zeta}(1)\)</span>, and <span class="math inline">\(\bar{\tau}\)</span> across 200 Monte Carlo simulations using Causal Mediation (CM), Optimal Transport (OT), Entropy Regularized Transports using Sinkhorn (SKH), and Sequential Transport ST (1) (moving <span class="math inline">\(X_1\)</span> first) and ST (2) (moving <span class="math inline">\(X_2\)</span> first). The red vertical bar denotes the theoretical value.
</figcaption>
<div aria-describedby="fig-gaussian-hist-mc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-hist-mc-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, .<span class="dv">5</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">3</span>))</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># CM</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_1_med"</span>, <span class="at">method_label =</span> <span class="st">"CM"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_0_med"</span>, <span class="at">method_label =</span> <span class="st">"CM"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_med"</span>, <span class="at">method_label =</span> <span class="st">"CM"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co"># OT</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_1_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_0_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co"># OT-M</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_1_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_0_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co"># SKH</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_1_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_0_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ST(1)</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_1_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_0_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim=</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ST(2)</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"delta_1_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"zeta_0_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>); <span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim=</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-hist-mc-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-hist-mc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.8: Estimated values of <span class="math inline">\(\bar{\delta}(1)\)</span>, <span class="math inline">\(\bar{\zeta}(0)\)</span>, and <span class="math inline">\(\bar{\tau}\)</span> across 200 Monte Carlo simulations using Causal Mediation (CM), Optimal Transport (OT), Entropy Regularized Transports using Sinkhorn (SKH), and Sequential Transport ST (1) (moving <span class="math inline">\(X_1\)</span> first) and ST (2) (moving <span class="math inline">\(X_2\)</span> first). The red vertical bar denotes the theoretical value.
</figcaption>
<div aria-describedby="fig-gaussian-hist-mc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-hist-mc-2-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<p>The comparison of the estimates made using observed values for <span class="math inline">\(y\)</span> (whenever observed) is shown in <a href="#fig-gaussian-hist-mc-3" class="quarto-xref">Figure&nbsp;<span>5.9</span></a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">2.1</span>, .<span class="dv">5</span>), <span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">2</span>))</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_ot"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_tmatch"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_ot_obs"</span>, <span class="at">method_label =</span> <span class="st">"OT"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_tmatch_obs"</span>, <span class="at">method_label =</span> <span class="st">"OT-M"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_skh"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_12"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_skh_obs"</span>, <span class="at">method_label =</span> <span class="st">"SKH"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_12_obs"</span>, <span class="at">method_label =</span> <span class="st">"ST (1)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_21"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_hist_sim</span>(<span class="at">metric_name =</span> <span class="st">"tot_effect_sot_21_obs"</span>, <span class="at">method_label =</span> <span class="st">"ST (2)"</span>, <span class="at">x_lim =</span> x_lim, <span class="at">export_tikz =</span> export_tikz)</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-hist-mc-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-hist-mc-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.9: Estimated values of <span class="math inline">\(\bar{\tau}\)</span> and <span class="math inline">\(\bar{\theta}\)</span> across 200 Monte Carlo simulations using ptimal Transport (OT), and Sequential Transport ST (1) (moving <span class="math inline">\(X_1\)</span> first) and ST (2) (moving <span class="math inline">\(X_2\)</span> first). The red vertical bar denotes the theoretical value.
</figcaption>
<div aria-describedby="fig-gaussian-hist-mc-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-hist-mc-3-1.png" class="img-fluid figure-img" width="960">
</div>
</figure>
</div>
</div>
</div>
<p>We also use violin plots, since exporting these histograms in a two-column format paper is not a good idea.</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>export_pdf <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> res_sim <span class="sc">|&gt;</span> </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>      delta_0_med, delta_0_ot, delta_0_tmatch, </span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>      delta_0_skh, delta_0_sot_12, delta_0_sot_21,</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">#</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>      zeta_1_med, zeta_1_ot, zeta_1_tmatch, </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>      zeta_1_skh, zeta_1_sot_12, zeta_1_sot_21,</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">#</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>      tot_effect_med, tot_effect_ot, tot_effect_tmatch, </span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>      tot_effect_skh, tot_effect_sot_12, tot_effect_sot_21</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>row) <span class="sc">|&gt;</span> </span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"^delta"</span>) <span class="sc">~</span> <span class="st">"delta"</span>,</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"^zeta"</span>) <span class="sc">~</span> <span class="st">"zeta"</span>,</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"^tot_effect"</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">str_detect</span>(name, <span class="st">"obs$"</span>) <span class="sc">~</span> <span class="st">"tau"</span>,</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="fu">factor</span>(</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>        type, </span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"delta"</span>, <span class="st">"zeta"</span>, <span class="st">"tau"</span>),</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">delta}(0)$"</span>, <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">zeta}(1)$"</span>, </span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">tau}$"</span>)</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="fu">case_when</span>(</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"_med$"</span>) <span class="sc">~</span> <span class="st">"CM"</span>,</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"_ot$"</span>) <span class="sc">~</span> <span class="st">"OT"</span>,</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"_tmatch$"</span>) <span class="sc">~</span> <span class="st">"OT-M"</span>,</span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"_skh$"</span>) <span class="sc">~</span> <span class="st">"SKH"</span>,</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"_sot_12$"</span>) <span class="sc">~</span> <span class="st">"ST(1)"</span>,</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(name, <span class="st">"sot_21$"</span>) <span class="sc">~</span> <span class="st">"ST(2)"</span>,</span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="fu">factor</span>(</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>        method, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">c</span>(<span class="st">"CM"</span>, <span class="st">"OT"</span>, <span class="st">"OT-M"</span>, <span class="st">"SKH"</span>, <span class="st">"ST(1)"</span>, <span class="st">"ST(2)"</span>))</span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(</span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> method, <span class="at">fill =</span> method),</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">draw_quantiles =</span> <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>)) <span class="sc">+</span></span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `draw_quantiles` argument of `geom_violin()` is deprecated as of ggplot2
4.0.0.
â„¹ Please use the `quantiles.linetype` argument instead.</code></pre>
</div>
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_pdf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> type, <span class="at">scales =</span> <span class="st">"free_x"</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> type, <span class="at">scales =</span> <span class="st">"free_x"</span>,</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">labeller =</span> <span class="fu">as_labeller</span>(latex2exp<span class="sc">::</span>TeX, <span class="at">default =</span> label_parsed)</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">delta}(0)$"</span>, <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">zeta}(1)$"</span>, </span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>               <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">tau}$"</span>), </span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">val_theo =</span> <span class="fu">c</span>(</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>        (a1<span class="sc">+</span>a2)<span class="sc">*</span>(mu1<span class="sc">-</span>mu0),</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>        a0,</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>        (a1<span class="sc">+</span>a2)<span class="sc">*</span>(mu1<span class="sc">-</span>mu0) <span class="sc">+</span> a0</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">factor</span>(</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>          type, </span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">delta}(0)$"</span>, <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">zeta}(1)$"</span>, </span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">tau}$"</span>)</span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">xintercept =</span> val_theo),</span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"darkred"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span>, </span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CM"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span>,</span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">"OT"</span> <span class="ot">=</span> colour_methods[[<span class="st">"OT"</span>]], </span>
<span id="cb102-40"><a href="#cb102-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">"OT-M"</span> <span class="ot">=</span> colour_methods[[<span class="st">"OT-M"</span>]], </span>
<span id="cb102-41"><a href="#cb102-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SKH"</span> <span class="ot">=</span> colour_methods[[<span class="st">"skh"</span>]], </span>
<span id="cb102-42"><a href="#cb102-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ST(1)"</span> <span class="ot">=</span>  colour_methods[[<span class="st">"seq_1"</span>]],</span>
<span id="cb102-43"><a href="#cb102-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ST(2)"</span> <span class="ot">=</span>  colour_methods[[<span class="st">"seq_2"</span>]]</span>
<span id="cb102-44"><a href="#cb102-44" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb102-45"><a href="#cb102-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb102-46"><a href="#cb102-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb102-47"><a href="#cb102-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_paper</span>()</span>
<span id="cb102-48"><a href="#cb102-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-49"><a href="#cb102-49" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb102-50"><a href="#cb102-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-51"><a href="#cb102-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_pdf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb102-52"><a href="#cb102-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot2_to_pdf</span>(</span>
<span id="cb102-53"><a href="#cb102-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"lines"</span>)) <span class="sc">+</span></span>
<span id="cb102-54"><a href="#cb102-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_x_continuous</span>(</span>
<span id="cb102-55"><a href="#cb102-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"$"</span>, x, <span class="st">"$"</span>)</span>
<span id="cb102-56"><a href="#cb102-56" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb102-57"><a href="#cb102-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"gaussian-violin-mc"</span>, <span class="at">path =</span> <span class="st">"figs/"</span>, </span>
<span id="cb102-58"><a href="#cb102-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">3.4</span>, <span class="at">height =</span> <span class="dv">2</span>,</span>
<span id="cb102-59"><a href="#cb102-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">crop =</span> <span class="cn">TRUE</span></span>
<span id="cb102-60"><a href="#cb102-60" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-61"><a href="#cb102-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-62"><a href="#cb102-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(<span class="fu">paste0</span>(<span class="st">"pdfcrop figs/gaussian-violin-mc.pdf figs/gaussian-violin-mc.pdf"</span>))</span>
<span id="cb102-63"><a href="#cb102-63" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gaussian-violin-mc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-gaussian-violin-mc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.10: Estimated values of <span class="math inline">\(\bar{\delta}(0)\)</span>, <span class="math inline">\(\bar{\zeta}(1)\)</span>, and <span class="math inline">\(\bar{\tau}\)</span> across 200 Monte Carlo simulations using Causal Mediation (CM), Optimal Transport (OT), Entropy Regularized Transports using Sinkhorn (SKH), and Sequential Transport ST (1) (moving <span class="math inline">\(X_1\)</span> first) and ST (2) (moving <span class="math inline">\(X_2\)</span> first). The red vertical bar denotes the theoretical value.
</figcaption>
<div aria-describedby="fig-gaussian-violin-mc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="gaussian-example_files/figure-html/fig-gaussian-violin-mc-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-peyre2019computational" class="csl-entry" role="listitem">
PeyrÃ©, Gabriel, and Marco Cuturi. 2019. <span>â€œComputational Optimal Transport: With Applications to Data Science.â€</span> <em>Foundations and Trends in Machine Learning</em> 11 (5-6): 355â€“607.
</div>
<div id="ref-sinkhorn1962factor" class="csl-entry" role="listitem">
Sinkhorn, Richard. 1962. <span>â€œOn the Factor Spaces of the Complex Doubly Stochastic Matrices.â€</span> <em>Notices of the American Mathematical Society</em> 9: 334â€“35.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./functions.html" class="pagination-link" aria-label="Functions for Sequential Transport">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Functions for Sequential Transport</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./gaussian-example-mc.html" class="pagination-link" aria-label="Monte Carlo Simulations">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Monte Carlo Simulations</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




</body></html>