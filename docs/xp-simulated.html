<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13&nbsp; Simulated Data â€“ Sequential Transport for Causal Mediation Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./xp-compas.html" rel="next">
<link href="./transport-gaussian-local-weights.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea4e51666191dd6ded9f775c5bce66c9.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-e845f871f76c909dd0a2a1d88316b656.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cb634faf95f4fcf0c327d115ec3f3fb3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-273aab03a32095346a75c1f293c006aa.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	   MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';


		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
		 
		 MathJax.Extension["TeX/color"].colors["colA"] = '#ffdd55';
		 MathJax.Extension["TeX/color"].colors["colB"] = '#944edf';
		 MathJax.Extension["TeX/color"].colors["colC"] = '#3fb3b2';
		 
		 MathJax.Extension["TeX/color"].colors["col0"] = '#7F170E';
		 MathJax.Extension["TeX/color"].colors["col1"] = '#1b95e0';
	});
</script>
<script>
MathJax = {
  loader: {
    load: ['[tex]/boldsymbol']
  },
  tex: {
    tags: "all",
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    packages: {
      '[+]': ['boldsymbol']
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Sequential Transport for Causal Mediation Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fer-agathe/causal_OT"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./xp-simulated.html">V. Experiments</a></li><li class="breadcrumb-item"><a href="./xp-simulated.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulated Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">I. Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reminders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Reminders and Definitions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Miscellaneous functions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Functions for Sequential Transport</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">II. A Gaussian Example</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Gaussian Example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-example-mc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Monte Carlo Simulations</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">III. Counterfactuals for Categorical Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-objectives.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Objectives</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-coupling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Random Matching</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-discrete.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Optimal Transport on Label-Encoded Variables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-transport.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Transport on Simplex</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transp-categ-small-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Small Example</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">IV. Transport with Weights</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transport-gaussian-local-weights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Gaussian Conditional Univariate Transport with Local Weights</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">V. Experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./xp-simulated.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulated Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./xp-compas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Compas</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-dgp" id="toc-sec-dgp" class="nav-link active" data-scroll-target="#sec-dgp"><span class="header-section-number">13.1</span> Data Generating Process</a></li>
  <li><a href="#counterfactuals" id="toc-counterfactuals" class="nav-link" data-scroll-target="#counterfactuals"><span class="header-section-number">13.2</span> Counterfactuals</a>
  <ul class="collapse">
  <li><a href="#multivariate-optimal-transport" id="toc-multivariate-optimal-transport" class="nav-link" data-scroll-target="#multivariate-optimal-transport"><span class="header-section-number">13.2.1</span> Multivariate Optimal Transport</a></li>
  <li><a href="#penalized-optimal-transport" id="toc-penalized-optimal-transport" class="nav-link" data-scroll-target="#penalized-optimal-transport"><span class="header-section-number">13.2.2</span> Penalized Optimal Transport</a></li>
  <li><a href="#sequential-transport" id="toc-sequential-transport" class="nav-link" data-scroll-target="#sequential-transport"><span class="header-section-number">13.2.3</span> Sequential Transport</a></li>
  <li><a href="#fairadapt" id="toc-fairadapt" class="nav-link" data-scroll-target="#fairadapt"><span class="header-section-number">13.2.4</span> Fairadapt</a></li>
  </ul></li>
  <li><a href="#measuring-the-causal-effect" id="toc-measuring-the-causal-effect" class="nav-link" data-scroll-target="#measuring-the-causal-effect"><span class="header-section-number">13.3</span> Measuring the Causal Effect</a>
  <ul class="collapse">
  <li><a href="#with-causal-mediation-analysis" id="toc-with-causal-mediation-analysis" class="nav-link" data-scroll-target="#with-causal-mediation-analysis"><span class="header-section-number">13.3.1</span> With Causal Mediation Analysis</a></li>
  <li><a href="#with-optimal-transport" id="toc-with-optimal-transport" class="nav-link" data-scroll-target="#with-optimal-transport"><span class="header-section-number">13.3.2</span> With Optimal Transport</a></li>
  <li><a href="#with-penalized-optimal-transport" id="toc-with-penalized-optimal-transport" class="nav-link" data-scroll-target="#with-penalized-optimal-transport"><span class="header-section-number">13.3.3</span> With Penalized Optimal Transport</a></li>
  <li><a href="#with-sequential-transport" id="toc-with-sequential-transport" class="nav-link" data-scroll-target="#with-sequential-transport"><span class="header-section-number">13.3.4</span> With Sequential Transport</a></li>
  <li><a href="#with-fairadapt" id="toc-with-fairadapt" class="nav-link" data-scroll-target="#with-fairadapt"><span class="header-section-number">13.3.5</span> With Fairadapt</a></li>
  </ul></li>
  <li><a href="#monte-carlo-experiment" id="toc-monte-carlo-experiment" class="nav-link" data-scroll-target="#monte-carlo-experiment"><span class="header-section-number">13.4</span> Monte-Carlo Experiment</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./xp-simulated.html">V. Experiments</a></li><li class="breadcrumb-item"><a href="./xp-simulated.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulated Data</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-xp-simulated" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Simulated Data</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we illustrate how our methodology based on a sequential transport approach works on simulated data.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github(</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   repo = "fer-agathe/sequential_transport", subdir = "seqtransfairness"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(seqtransfairness)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github(repo = "fer-agathe/transport-simplex")</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(transportsimplex)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grf)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cluster)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fairadapt)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Also required:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(mlr3fairness)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[
\definecolor{wongBlack}{RGB}{0,0,0}
\definecolor{wongGold}{RGB}{230, 159, 0}
\definecolor{wongLightBlue}{RGB}{86, 180, 233}
\definecolor{wongGreen}{RGB}{0, 158, 115}
\definecolor{wongYellow}{RGB}{240, 228, 66}
\definecolor{wongBlue}{RGB}{0, 114, 178}
\definecolor{wongOrange}{RGB}{213, 94, 0}
\definecolor{wongPurple}{RGB}{204, 121, 167}
\definecolor{colA}{RGB}{255, 221, 85}
\definecolor{colB}{RGB}{148, 78, 223}
\definecolor{colC}{RGB}{63, 179, 178}
\definecolor{colGpeZero}{RGB}{127, 23, 14}
\definecolor{colGpeUn}{RGB}{27, 149, 224}
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Codes for graphical parameters.</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extrafont, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>col_group <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#00A08A"</span>,<span class="st">"#F2AD00"</span>, <span class="st">"#1b95e0"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>colour_methods <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"OT"</span> <span class="ot">=</span> <span class="st">"#CC79A7"</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"OT-M"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"skh"</span> <span class="ot">=</span> <span class="st">"darkgray"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"seq_1"</span> <span class="ot">=</span> <span class="st">"#0072B2"</span>, <span class="st">"seq_2"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fairadapt_1"</span> <span class="ot">=</span> <span class="st">"#9966FF"</span>, <span class="st">"fairadapt_2"</span> <span class="ot">=</span> <span class="st">"#7CAE00"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>colGpe1 <span class="ot">&lt;-</span> col_group[<span class="dv">2</span>]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>colGpe0 <span class="ot">&lt;-</span> col_group[<span class="dv">1</span>]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>colGpet <span class="ot">&lt;-</span> col_group[<span class="dv">3</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"pdf"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>font_size <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>font_family <span class="ot">&lt;-</span> <span class="st">"serif"</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">"./figs/"</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(path)) <span class="fu">dir.create</span>(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We load the functions that will allow us to build the counterfactuals (see <a href="functions.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>), and some graphical themes for the plots (see [Chapter <a href="utils.html" class="quarto-xref"><span>3</span></a>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../scripts/functions.R"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../scripts/utils.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sec-dgp" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="sec-dgp"><span class="header-section-number">13.1</span> Data Generating Process</h2>
<p>We simulate a dataset comprising a binary treatment indicator <span class="math inline">\(A \in \{0,1\}\)</span>, a binary outcome <span class="math inline">\(Y \in \{0,1\}\)</span>, and three covariates: two continuous variables <span class="math inline">\(X_1, X_2 \in \mathbb{R}\)</span> and one categorical variable <span class="math inline">\(X_3 \in \{\text{A}, \text{B}, \text{C}\}\)</span>. For individuals with <span class="math inline">\(A = 0\)</span>, the vector <span class="math inline">\((X_1, X_2)\)</span> is drawn from a bivariate normal distribution with mean vector <span class="math inline">\(\mu_0 = (-1, -1)\)</span> and covariance matrix <span class="math inline">\(\Sigma_0 = 1.2^2 \begin{bmatrix} 1 &amp; 0.5 \\ 0.5 &amp; 1 \end{bmatrix}\)</span>. For those with <span class="math inline">\(A = 1\)</span>, the distribution shifts to mean <span class="math inline">\(\mu_1 = (1.5, 1.5)\)</span> and covariance <span class="math inline">\(\Sigma_1 = 0.9^2 \begin{bmatrix} 1 &amp; -0.4 \\ -0.4 &amp; 1 \end{bmatrix}\)</span>. This leads to distinct location and dependence structures across treatment groups.</p>
<p>The categorical variable <span class="math inline">\(X_3\)</span> is generated conditionally on <span class="math inline">\(X_1, X_2\)</span>, and <span class="math inline">\(A\)</span> via a multinomial logistic model. Letting <span class="math inline">\(p_{\text{A}}, p_{\text{B}}, p_{\text{C}}\)</span> denote the unnormalized logit scores for each level of <span class="math inline">\(X_3\)</span>, we set:</p>
<p><span class="math display">\[
\begin{aligned}
p_{\text{A}} &amp;= 0.5 + 0.3 X_1 - 0.4 X_2 + 0.2 A, \\
p_{\text{B}} &amp;= -0.3 + 0.5 X_2 - 0.2 X_1 - 0.1 A, \\
p_{\text{C}} &amp;= 0,
\end{aligned}
\]</span></p>
<p>with the associated probabilities obtained via softmax normalization:</p>
<p><span class="math display">\[
P(X_3 = k) = \frac{\exp(p_k)}{\exp(p_{\text{A}}) + \exp(p_{\text{B}}) + \exp(p_{\text{C}})}, \quad \text{for } k \in \{\text{A}, \text{B}, \text{C}\}.
\]</span></p>
<p>The binary outcome <span class="math inline">\(Y\)</span> is modeled using a logistic regression, with functional forms differing across treatment groups. For <span class="math inline">\(A = 0\)</span>, the log-odds is defined as:</p>
<p><span class="math display">\[
\eta_0 = -0.2 + 0.6 X_1 - 0.6 X_2 + \gamma(X_3),
\]</span></p>
<p>and for <span class="math inline">\(A = 1\)</span>:</p>
<p><span class="math display">\[
\eta_1 = 0.1 - 0.2 X_1 + 0.8 X_2 + \gamma(X_3),
\]</span></p>
<p>where the contribution of <span class="math inline">\(X_3\)</span> is encoded as:</p>
<p><span class="math display">\[
\gamma(X_3) =
\begin{cases}
0.2 &amp; \text{if } X_3 = \text{B}, \\
-0.3 &amp; \text{if } X_3 = \text{C}, \\
0 &amp; \text{if } X_3 = \text{A},
\end{cases}
\quad \text{(for } A = 0\text{)},
\]</span></p>
<p>and similarly, for <span class="math inline">\(A = 1\)</span>:</p>
<p><span class="math display">\[
\gamma(X_3) =
\begin{cases}
-0.2 &amp; \text{if } X_3 = \text{B}, \\
-0.1 &amp; \text{if } X_3 = \text{C}, \\
0 &amp; \text{if } X_3 = \text{A}.
\end{cases}
\]</span></p>
<p>The outcome <span class="math inline">\(Y\)</span> is then drawn from a Bernoulli distribution with success probability <span class="math inline">\(P[Y = 1] = \mathrm{logit}^{-1}(\eta_A)\)</span>.</p>
<p>For each observation, we additionally simulate a counterfactual covariate vector and outcome under the opposite treatment status. This includes drawing <span class="math inline">\((X_1^{\text{cf}}, X_2^{\text{cf}})\)</span> from the treatment-specific bivariate normal distribution of the opposite group, computing the corresponding <span class="math inline">\(X_3^{\text{cf}}\)</span> using the same multinomial model (with <span class="math inline">\(A\)</span> flipped), and evaluating <span class="math inline">\(Y^{\text{cf}}\)</span> via the appropriate counterfactual logit model.</p>
<p>We draw <span class="math inline">\(n_0=400\)</span> observations in <span style="color: #00A08A;">group&nbsp;0</span> and <span class="math inline">\(n_1=200\)</span> observations in <span style="color: #F2AD00;">group&nbsp;1</span>. We generate a function, <code class="sourceCode r"><span class="fu">gen_data</span>()</code> to generate data from this data generating process.</p>
<div class="cell">
<details class="code-fold">
<summary>The <code class="sourceCode r"><span class="fu">gen_data</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gen_data <span class="ot">&lt;-</span> <span class="cf">function</span>(seed) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  n_0 <span class="ot">&lt;-</span> <span class="dv">400</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  n_1 <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X1 and X2 in both groups from sensitive-specific multivariate normal </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># distributions</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  M_0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  S_0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, .<span class="dv">5</span>, .<span class="dv">5</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">1.2</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  M_1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  S_1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span>.<span class="dv">4</span>, <span class="sc">-</span>.<span class="dv">4</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">0.9</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  X_0 <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> n_0, <span class="at">mu =</span> M_0, <span class="at">Sigma =</span> S_0)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  X_1 <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> n_1, <span class="at">mu =</span> M_1, <span class="at">Sigma =</span> S_1)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Counterfactuals</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  X_0_cf <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> n_0, <span class="at">mu =</span> M_1, <span class="at">Sigma =</span> S_1)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  X_1_cf <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n =</span> n_1, <span class="at">mu =</span> M_0, <span class="at">Sigma =</span> S_0)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X3: categorical, depends on S, X1, X3</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  scores <span class="ot">&lt;-</span> <span class="cf">function</span>(x1, x2, a) {</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    p_A <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> x1 <span class="sc">-</span> <span class="fl">0.4</span> <span class="sc">*</span> x2 <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> a</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    p_B <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.3</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x2 <span class="sc">-</span> <span class="fl">0.2</span><span class="sc">*</span>x1 <span class="sc">-</span> <span class="fl">0.1</span> <span class="sc">*</span> a</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    p_C <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    exps <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">cbind</span>(p_A, p_B, p_C))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> exps <span class="sc">/</span> <span class="fu">rowSums</span>(exps)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    prob</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  prob_X3_0 <span class="ot">&lt;-</span> <span class="fu">scores</span>(<span class="at">x1 =</span> X_0[, <span class="dv">1</span>], <span class="at">x2 =</span> X_0[, <span class="dv">2</span>], <span class="at">a =</span> <span class="dv">0</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  prob_X3_1 <span class="ot">&lt;-</span> <span class="fu">scores</span>(<span class="at">x1 =</span> X_1[, <span class="dv">1</span>], <span class="at">x2 =</span> X_1[, <span class="dv">2</span>], <span class="at">a =</span> <span class="dv">1</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  X3_0 <span class="ot">&lt;-</span> <span class="fu">apply</span>(prob_X3_0, <span class="dv">1</span>, <span class="cf">function</span>(p) <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="dv">1</span>, <span class="at">prob =</span> p))</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  X3_1 <span class="ot">&lt;-</span> <span class="fu">apply</span>(prob_X3_1, <span class="dv">1</span>, <span class="cf">function</span>(p) <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="dv">1</span>, <span class="at">prob =</span> p))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Counterfactuals</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  prob_X3_0_cf <span class="ot">&lt;-</span> <span class="fu">scores</span>(<span class="at">x1 =</span> X_0_cf[, <span class="dv">1</span>], <span class="at">x2 =</span> X_0_cf[, <span class="dv">2</span>], <span class="at">a =</span> <span class="dv">1</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  prob_X3_1_cf <span class="ot">&lt;-</span> <span class="fu">scores</span>(<span class="at">x1 =</span> X_1_cf[, <span class="dv">1</span>], <span class="at">x2 =</span> X_1_cf[, <span class="dv">2</span>], <span class="at">a =</span> <span class="dv">0</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  X3_0_cf <span class="ot">&lt;-</span> <span class="fu">apply</span>(prob_X3_0_cf, <span class="dv">1</span>, <span class="cf">function</span>(p) <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="dv">1</span>, <span class="at">prob =</span> p))</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  X3_1_cf <span class="ot">&lt;-</span> <span class="fu">apply</span>(prob_X3_1_cf, <span class="dv">1</span>, <span class="cf">function</span>(p) <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>), <span class="dv">1</span>, <span class="at">prob =</span> p))</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predictor for Y:</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  eta_0 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> X_0[, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.6</span> <span class="sc">*</span> X_0[, <span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(X3_0 <span class="sc">==</span> <span class="st">"B"</span>, <span class="fl">0.2</span>, <span class="fu">ifelse</span>(X3_0 <span class="sc">==</span> <span class="st">"C"</span>, <span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">0</span>))</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  eta_1 <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> X_1[, <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> X_1[, <span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(X3_1 <span class="sc">==</span> <span class="st">"B"</span>, <span class="sc">-</span><span class="fl">0.2</span>, <span class="fu">ifelse</span>(X3_1 <span class="sc">==</span> <span class="st">"C"</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="dv">0</span>))</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  p_0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_0) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta_0))</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  p_1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_1) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta_1))</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predictor for Y, counterfactuals</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>  eta_0_cf <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">-</span> <span class="fl">0.2</span> <span class="sc">*</span> X_0_cf[, <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> X_0_cf[, <span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(X3_0_cf <span class="sc">==</span> <span class="st">"B"</span>, <span class="sc">-</span><span class="fl">0.2</span>, <span class="fu">ifelse</span>(X3_0_cf <span class="sc">==</span> <span class="st">"C"</span>, <span class="sc">-</span><span class="fl">0.1</span>, <span class="dv">0</span>))</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  eta_1_cf <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.2</span> <span class="sc">+</span> <span class="fl">0.6</span> <span class="sc">*</span> X_1_cf[, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.6</span> <span class="sc">*</span> X_1_cf[, <span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(X3_1_cf <span class="sc">==</span> <span class="st">"B"</span>, <span class="fl">0.2</span>, <span class="fu">ifelse</span>(X3_1_cf <span class="sc">==</span> <span class="st">"C"</span>, <span class="sc">-</span><span class="fl">0.3</span>, <span class="dv">0</span>))</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  p_0_cf <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_0_cf) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta_0_cf))</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  p_1_cf <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_1_cf) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta_1_cf))</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  Y_0 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_0, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p_0)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  Y_1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_1, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p_1)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  Y_0_cf <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_0, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p_0_cf)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  Y_1_cf <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_1, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p_1_cf)</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dataset with individuals in group 0 only</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  data_0 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="dv">0</span>, </span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> X_0[, <span class="dv">1</span>], <span class="at">X2 =</span> X_0[, <span class="dv">2</span>], <span class="at">X3 =</span> X3_0, <span class="at">Y =</span> Y_0,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_cf =</span> X_0_cf[, <span class="dv">1</span>], <span class="at">X2_cf =</span> X_0_cf[, <span class="dv">2</span>], <span class="at">X3_cf =</span> X3_0_cf, <span class="at">Y_cf =</span> Y_0_cf,</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> eta_0, <span class="at">p =</span> p_0,</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_cf =</span> eta_0_cf, <span class="at">p_cf =</span> p_0_cf</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(prob_X3_0) <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_c</span>(<span class="st">"X3_"</span>, .))) <span class="sc">|&gt;</span> </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(prob_X3_0_cf) <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_c</span>(<span class="st">"X3_cf_"</span>, .)))</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dataset with individuals in group 1 only</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  data_1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="dv">1</span>, </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> X_1[, <span class="dv">1</span>], <span class="at">X2 =</span> X_1[, <span class="dv">2</span>], <span class="at">X3 =</span> X3_1, <span class="at">Y =</span> Y_1,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1_cf =</span> X_1_cf[, <span class="dv">1</span>], <span class="at">X2_cf =</span> X_1_cf[, <span class="dv">2</span>], <span class="at">X3_cf =</span> X3_1_cf, <span class="at">Y_cf =</span> Y_1_cf,</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> eta_1,  <span class="at">p =</span> p_1,</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta_cf =</span> eta_1_cf, <span class="at">p_cf =</span> p_1_cf</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(prob_X3_1) <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_c</span>(<span class="st">"X3_"</span>, .))) <span class="sc">|&gt;</span> </span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(prob_X3_1_cf) <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_c</span>(<span class="st">"X3_cf_"</span>, .)))</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Combine final dataset</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>  data_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_0, data_1)</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  data_all</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let us generate a dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tb <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(<span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">as.factor</span>(.x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The distribution of the true probabilities in <span style="color: #00A08A;">group&nbsp;0</span> and in <span style="color: #F2AD00;">group&nbsp;1</span> are shown in <a href="#fig-dist-true-prob" class="quarto-xref">Figure&nbsp;<span>13.1</span></a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> tb <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">A =</span> <span class="fu">factor</span>(A)) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(A, p, p_cf) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(p, p_cf), <span class="at">names_to =</span> <span class="st">"type"</span>, <span class="at">values_to =</span> <span class="st">"p"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"p"</span>, <span class="st">"p_cf"</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Obs."</span>, <span class="st">"Counterfactual"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> p)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> A), <span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">colour =</span> <span class="st">"black"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">bins =</span> <span class="dv">30</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>type) <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> colours[[<span class="st">"0"</span>]], <span class="st">"1"</span> <span class="ot">=</span> colours[[<span class="st">"1"</span>]])) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_paper</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-dist-true-prob" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-dist-true-prob-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.1: Distribution of the true probability of the outcome across groups for the <span style="color:#00A08A;">untreated</span> and the <span style="color:#D55E00;">treated</span>, for observed values (left) and unobserved values (right).
</figcaption>
<div aria-describedby="fig-dist-true-prob-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="xp-simulated_files/figure-html/fig-dist-true-prob-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="counterfactuals" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="counterfactuals"><span class="header-section-number">13.2</span> Counterfactuals</h2>
<p>We assume a structural model as shown in <a href="#fig-dag" class="quarto-xref">Figure&nbsp;<span>13.2</span></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"Y"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>adj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A  X1 X2 X3 Y</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># A</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># X1</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># X2</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,<span class="co"># X3</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>  <span class="co"># Y</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(variables),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">rep</span>(<span class="fu">list</span>(variables), <span class="dv">2</span>),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>causal_graph <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">graphModel</span>(adj)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(causal_graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-dag" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-dag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.2: Asumed Causal Structure
</figcaption>
<div aria-describedby="fig-dag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="xp-simulated_files/figure-html/fig-dag-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>Let us follow this DAG and build the counterfactuals of <span style="color: #00A08A;">untreated</span>: we thus transport individuals from <span class="math inline">\(A=0\)</span> to <span class="math inline">\(A=1\)</span>. Let us set a seed for reproducibility.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> <span class="dv">1234</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(seed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We call the <code class="sourceCode r"><span class="fu">seq_trans</span>()</code> function (see <a href="functions.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>) function to build the counterfactuals of <span style="color: #00A08A;">untreated units</span>. The estimations are done using parallel computation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>A_name <span class="ot">&lt;-</span> <span class="st">"A"</span> <span class="co"># treatment name</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>Y_name <span class="ot">&lt;-</span> <span class="st">"Y"</span> <span class="co"># outcome name</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>A_untreated <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> tb[[A_name]]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ind_untreated <span class="ot">&lt;-</span> <span class="fu">which</span>(A <span class="sc">==</span> A_untreated)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>tb_estim <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(A, X1, X2, X3, Y)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>tb_untreated <span class="ot">&lt;-</span> tb_estim[ind_untreated, ]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>tb_treated <span class="ot">&lt;-</span> tb_estim[<span class="sc">-</span>ind_untreated, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us follow the DAG from <a href="#fig-dag" class="quarto-xref">Figure&nbsp;<span>13.2</span></a> and build the counterfactuals of units from <span style="color: #00A08A;">group 0</span>: we thus transport individuals from <span class="math inline">\(A=0\)</span> to <span class="math inline">\(A=1\)</span>, using the predictions on the test set.</p>
<section id="multivariate-optimal-transport" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="multivariate-optimal-transport"><span class="header-section-number">13.2.1</span> Multivariate Optimal Transport</h3>
<p>We apply multivariate optimal transport (OT), following the methodology developed in <span class="citation" data-cites="de2024transport">De Lara et al. (<a href="references.html#ref-de2024transport" role="doc-biblioref">2024</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tb_untreated_wo_A <span class="ot">&lt;-</span> tb_untreated[ , <span class="sc">!</span>(<span class="fu">names</span>(tb_untreated) <span class="sc">%in%</span> A_name)]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>tb_treated_wo_A <span class="ot">&lt;-</span> tb_treated[ , <span class="sc">!</span>(<span class="fu">names</span>(tb_treated) <span class="sc">%in%</span> A_name)]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tb_untreated_wo_A)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tb_treated_wo_A)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> tb_untreated_wo_A[[Y_name]]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> tb_treated_wo_A[[Y_name]]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> tb_untreated_wo_A[ , <span class="sc">!</span>(<span class="fu">names</span>(tb_untreated_wo_A) <span class="sc">%in%</span> Y_name)]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> tb_treated_wo_A[ , <span class="sc">!</span>(<span class="fu">names</span>(tb_treated_wo_A) <span class="sc">%in%</span> Y_name)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To apply Optimal Transport on the dataset, we first need to one-hot the categorical variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>num_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(X0)[<span class="fu">sapply</span>(X0, is.numeric)]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>cat_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(X0)[<span class="fu">sapply</span>(X0, <span class="cf">function</span>(col) <span class="fu">is.factor</span>(col) <span class="sc">||</span> <span class="fu">is.character</span>(col))]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>X0_num <span class="ot">&lt;-</span> X0[ , num_cols]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>X1_num <span class="ot">&lt;-</span> X1[ , num_cols]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>X0_cat <span class="ot">&lt;-</span> X0[ , cat_cols]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>X1_cat <span class="ot">&lt;-</span> X1[ , cat_cols]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>cat_counts <span class="ot">&lt;-</span> <span class="fu">sapply</span>(X0[ , cat_cols], <span class="cf">function</span>(col) <span class="fu">length</span>(<span class="fu">unique</span>(col)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Categorical variables are one-hot encoded:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'caret'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>X0_cat_encoded <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>X1_cat_encoded <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> cat_cols) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># One-hot encoding with dummyVars</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"~"</span>, col))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  dummies <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">dummyVars</span>(formula, <span class="at">data =</span> X0_cat)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dummy variable</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  dummy_0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(dummies, <span class="at">newdata =</span> X0_cat) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  dummy_1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(dummies, <span class="at">newdata =</span> X1_cat) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scaling</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  dummy_0_scaled <span class="ot">&lt;-</span> <span class="fu">scale</span>(dummy_0)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  dummy_1_scaled <span class="ot">&lt;-</span> <span class="fu">scale</span>(dummy_1)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  dummy_0_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dummy_0_scaled)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  dummy_1_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dummy_1_scaled)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aling categories in both treated/untreated groups</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  all_cols <span class="ot">&lt;-</span> <span class="fu">union</span>(<span class="fu">colnames</span>(dummy_0_df), <span class="fu">colnames</span>(dummy_1_df))</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  dummy_0_df <span class="ot">&lt;-</span> dummy_0_df <span class="sc">|&gt;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="at">.fns =</span> identity)) <span class="sc">|&gt;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(all_cols)) <span class="sc">|&gt;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">replace_na</span>(.x, <span class="dv">0</span>)))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  dummy_1_df <span class="ot">&lt;-</span> dummy_1_df <span class="sc">|&gt;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="at">.fns =</span> identity)) <span class="sc">|&gt;</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(all_cols)) <span class="sc">|&gt;</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">replace_na</span>(.x, <span class="dv">0</span>)))</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  X0_cat_encoded[[col]] <span class="ot">&lt;-</span> dummy_0_df</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  X1_cat_encoded[[col]] <span class="ot">&lt;-</span> dummy_1_df</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculate Euclidean distance for numerical variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(proxy)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>num_dist <span class="ot">&lt;-</span> proxy<span class="sc">::</span><span class="fu">dist</span>(<span class="at">x =</span> X0_num, <span class="at">y =</span> X1_num, <span class="at">method =</span> <span class="st">"Euclidean"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>num_dist <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(num_dist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For categorical variables, we use the Hamming distance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>cat_dists <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> cat_cols) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  mat_0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X0_cat_encoded[[col]])</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  mat_1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X1_cat_encoded[[col]])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  dist_mat <span class="ot">&lt;-</span> proxy<span class="sc">::</span><span class="fu">dist</span>(<span class="at">x =</span> mat_0, <span class="at">y =</span> mat_1, <span class="at">method =</span> <span class="st">"Euclidean"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  cat_dists[[col]] <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dist_mat)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we need to combine the two distance matrices. We use weights equal to the proportion of numerical variables and the proportion of categorical variables, respectively for distances based on numerical and categorical variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>combined_cost <span class="ot">&lt;-</span> num_dist</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(cat_dists)) {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  combined_cost <span class="ot">&lt;-</span> combined_cost <span class="sc">+</span> cat_dists[[i]]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can compute the transport map:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uniform weights (equal mass)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>w0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n0, n0)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>w1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n1, n1)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute transport plan</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>transport_res <span class="ot">&lt;-</span> transport<span class="sc">::</span><span class="fu">transport</span>(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> w0,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> w1,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">costm =</span> combined_cost,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"shortsimplex"</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial solution based on shortlist is degenerate. Adding 199 basis vector(s)... done.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>transport_plan <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n0, <span class="at">ncol =</span> n1)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(transport_res))) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  transport_plan[transport_res<span class="sc">$</span>from[i], transport_res<span class="sc">$</span>to[i]] <span class="ot">&lt;-</span> transport_res<span class="sc">$</span>mass[i]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first transport the numerical variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>num_transported <span class="ot">&lt;-</span> n0 <span class="sc">*</span> (transport_plan <span class="sc">%*%</span> <span class="fu">as.matrix</span>(X1_num))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we transport the categorical variables with label reconstruction (not perfect here).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cat_transported <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> cat_cols) {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  cat_probs <span class="ot">&lt;-</span> transport_plan <span class="sc">%*%</span> <span class="fu">as.matrix</span>(X1_cat_encoded[[col]])</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  cat_encoded_columns <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X1_cat_encoded[[col]])</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each obs., we take the index with the maximum value (approx. proba)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  max_indices <span class="ot">&lt;-</span> <span class="fu">apply</span>(cat_probs, <span class="dv">1</span>, which.max)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  prefix_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"^"</span>, col, <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  cat_transported[[col]] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    max_indices, </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">sub</span>(prefix_pattern, <span class="st">""</span>, cat_encoded_columns[x])</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now store the results into a tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>tb_ot_transported <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(num_transported)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> cat_cols) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  tb_ot_transported[[col]] <span class="ot">&lt;-</span> cat_transported[[col]]</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tb_ot_transported, <span class="at">file =</span> <span class="st">"../output/ot-synthetic.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tb_ot_transported</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/ot-synthetic.rda"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>tb_ot_transported <span class="ot">&lt;-</span> tb_ot_transported <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">X3 =</span> <span class="fu">as.factor</span>(X3))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>tb_ot_transported <span class="ot">&lt;-</span> <span class="fu">as.list</span>(tb_ot_transported)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also use the function <code class="sourceCode r"><span class="fu">optimal_transport_cf</span>()</code> with default parameters (i.e., without any regularization).</p>
</section>
<section id="penalized-optimal-transport" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="penalized-optimal-transport"><span class="header-section-number">13.2.2</span> Penalized Optimal Transport</h3>
<p>We can directly compute the transport map using Sinkhorn penalty. Let us set the regularization parameter, <span class="math inline">\(\gamma=0.1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute transport plan</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>sinkhorn_transport_res <span class="ot">&lt;-</span> T4transport<span class="sc">::</span><span class="fu">sinkhornD</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  combined_cost, <span class="at">wx =</span> w0, <span class="at">wy =</span> w1, <span class="at">lambda =</span> <span class="fl">0.1</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>sinkhorn_transport_plan <span class="ot">&lt;-</span> sinkhorn_transport_res<span class="sc">$</span>plan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first transport the numerical variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>num_sinkhorn_transported <span class="ot">&lt;-</span> n0 <span class="sc">*</span> (sinkhorn_transport_plan <span class="sc">%*%</span> <span class="fu">as.matrix</span>(X1_num))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we transport the categorical variables with label reconstruction (not perfect here).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>cat_sinkhorn_transported <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> cat_cols) {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  cat_probs <span class="ot">&lt;-</span> sinkhorn_transport_plan <span class="sc">%*%</span> <span class="fu">as.matrix</span>(X1_cat_encoded[[col]])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  cat_encoded_columns <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X1_cat_encoded[[col]])</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each obs., we take the index with the maximum value (approx. proba)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  max_indices <span class="ot">&lt;-</span> <span class="fu">apply</span>(cat_probs, <span class="dv">1</span>, which.max)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  prefix_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"^"</span>, col, <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  cat_sinkhorn_transported[[col]] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    max_indices, </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) <span class="fu">sub</span>(prefix_pattern, <span class="st">""</span>, cat_encoded_columns[x])</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now store the results into a tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>tb_sinkhorn_transported <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(num_sinkhorn_transported)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> cat_cols) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  tb_sinkhorn_transported[[col]] <span class="ot">&lt;-</span> cat_sinkhorn_transported[[col]]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(tb_sinkhorn_transported, <span class="at">file =</span> <span class="st">"../output/sinkhorn-synthetic.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tb_sinkhorn_transported</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/sinkhorn-synthetic.rda"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>tb_sinkhorn_transported <span class="ot">&lt;-</span> tb_sinkhorn_transported <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">X3 =</span> <span class="fu">as.factor</span>(X3))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>tb_sinkhorn_transported <span class="ot">&lt;-</span> <span class="fu">as.list</span>(tb_sinkhorn_transported)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also use the function <code class="sourceCode r"><span class="fu">optimal_transport_cf</span>()</code> but this time we need to indicate a value for the parameter <code>pen</code> to apply Sinkhorn regularization.</p>
</section>
<section id="sequential-transport" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="sequential-transport"><span class="header-section-number">13.2.3</span> Sequential Transport</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ncl <span class="ot">&lt;-</span> <span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>(cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>socket cluster with 9 nodes on host 'localhost'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(cl, {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(transportsimplex)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"../scripts/functions.R"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>sequential_transport <span class="ot">&lt;-</span> <span class="fu">seq_trans</span>(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> tb_estim, </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">adj =</span> adj, </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">s =</span> A_name, </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">S_0 =</span> <span class="dv">0</span>, <span class="co"># source: untreated</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> Y_name, </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_neighbors =</span> <span class="dv">50</span>, </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_neighbors_q =</span> <span class="cn">NULL</span>,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">silent =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"shortsimplex"</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cl</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Transporting  X1 
Transporting  X2 
Transporting  X3 
Initial solution based on shortlist is degenerate. Adding 2 basis vector(s)... done.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(sequential_transport, <span class="at">file =</span> <span class="st">"../output/seq-t-synthetic.rda"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us load the results of the estimation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/seq-t-synthetic.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fairadapt" class="level3" data-number="13.2.4">
<h3 data-number="13.2.4" class="anchored" data-anchor-id="fairadapt"><span class="header-section-number">13.2.4</span> Fairadapt</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>adj_reduced <span class="ot">&lt;-</span> adj[<span class="sc">-</span><span class="dv">5</span>,<span class="sc">-</span><span class="dv">5</span>]</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>ind_0 <span class="ot">&lt;-</span> <span class="fu">which</span>(tb_estim<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> tb_estim <span class="sc">|&gt;</span> <span class="fu">select</span>(A, X1, X2, X3)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>A, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"0"</span>))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>fpt_model_0_to_1 <span class="ot">&lt;-</span> <span class="fu">fairadapt</span>(</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    X3 <span class="sc">~</span> ., </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">train.data =</span> data,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">prot.attr =</span> <span class="st">"A"</span>, <span class="at">adj.mat =</span> adj_reduced,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">quant.method =</span> rangerQuants</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>adapt_data_0 <span class="ot">&lt;-</span> <span class="fu">adaptedData</span>(fpt_model_0_to_1)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>adapt_data_0 <span class="ot">&lt;-</span> adapt_data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>A)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>adapt_data_0 <span class="ot">&lt;-</span> adapt_data_0[ind_0,]</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(adapt_data_0, <span class="at">file =</span> <span class="st">"../output/fairadapt-rf-synthetic.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us load the results of the estimation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/fairadapt-rf-synthetic.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="measuring-the-causal-effect" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="measuring-the-causal-effect"><span class="header-section-number">13.3</span> Measuring the Causal Effect</h2>
<section id="with-causal-mediation-analysis" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="with-causal-mediation-analysis"><span class="header-section-number">13.3.1</span> With Causal Mediation Analysis</h3>
<p>Let us use the <code class="sourceCode r"><span class="fu">multimed</span>()</code> function from {mediation} to estimate the direct effect:</p>
<ul>
<li>A -&gt; Y, and the different indirect effects:</li>
<li>A -&gt; X1 -&gt; Y,</li>
<li>A -&gt; X2 -&gt; Y,</li>
<li>A -&gt; X3 -&gt; Y,</li>
<li>A -&gt; X1 -&gt; X2 -&gt; Y,</li>
<li>A -&gt; X1 -&gt; X3 -&gt; Y,</li>
<li>A -&gt; X2 -&gt; X3 -&gt; Y,</li>
<li>A -&gt; X1 -&gt; X2 -&gt; X3 -&gt; Y.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(mediation) # we do not load it</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise it masks a lot of useful functions</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We encode the categorical variable as for optimal transport</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>tb_med <span class="ot">&lt;-</span> tb_estim <span class="sc">|&gt;</span> </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">X3 =</span> <span class="fu">case_when</span>(</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>      X3 <span class="sc">==</span> <span class="st">"A"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>      X3 <span class="sc">==</span> <span class="st">"B"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>      X3 <span class="sc">==</span> <span class="st">"C"</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>med_mod_X1 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.main =</span> <span class="st">"X1"</span>, </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.alt =</span> <span class="fu">c</span>(<span class="st">"X2"</span>, <span class="st">"X3"</span>), </span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> tb_med</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Indirect effect for X1: A -&gt; X1 -&gt; Y</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>delta_0_med_X1 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X1<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_X1<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct + Other indirect effects: A -&gt; Y, A -&gt; X2 -&gt; Y, A -&gt; X3 -&gt; Y, </span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># A -&gt; X1 -&gt; X2 -&gt; Y, A -&gt; X2 -&gt; X3 -&gt; Y, A -&gt; X1 -&gt; X3 -&gt; Y, A -&gt; X1 -&gt; X2 -&gt; X3 -&gt; Y</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>zeta_1_med_X1 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X1<span class="sc">$</span>z1.lb <span class="sc">+</span> med_mod_X1<span class="sc">$</span>z1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Total effect</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>tot_effect_med_X1 <span class="ot">&lt;-</span> delta_0_med_X1 <span class="sc">+</span> zeta_1_med_X1</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>med_mod_X2 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.main =</span> <span class="st">"X2"</span>, </span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.alt =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X3"</span>), </span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> tb_med</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Indirect effect for X2: A -&gt; X2 -&gt; Y, A -&gt; X1 -&gt; X2 -&gt; Y</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>delta_0_med_X2 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X2<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_X2<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct + Other indirect effects: A -&gt; Y, A -&gt; X1 -&gt; Y, A -&gt; X3 -&gt; Y, </span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="co"># A -&gt; X1 -&gt; X3 -&gt; Y, A -&gt; X2 -&gt; X3 -&gt; Y, A -&gt; X1 -&gt; X2 -&gt; X3</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>zeta_1_med_X2 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X2<span class="sc">$</span>z1.lb <span class="sc">+</span> med_mod_X2<span class="sc">$</span>z1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Total effect</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>tot_effect_med_X2 <span class="ot">&lt;-</span> delta_0_med_X2 <span class="sc">+</span> zeta_1_med_X2</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>med_mod_X3 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.main =</span> <span class="st">"X3"</span>, </span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">med.alt =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>), </span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> tb_med</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Indirect effect for ccd: A -&gt; X3 -&gt; Y, A -&gt; X1 -&gt; X3 -&gt; Y, A -&gt; X2 -&gt; X3 -&gt; Y,</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a><span class="co"># A -&gt; X1 -&gt; X2 -&gt; X3 -&gt; Y</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>delta_0_med_X3 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X3<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_X3<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct + Other indirect effects: A -&gt; Y, A -&gt; X1 -&gt; Y, A -&gt; X2 -&gt; Y, </span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a><span class="co"># A -&gt; X1 -&gt; X2 -&gt; Y</span></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>zeta_1_med_X3 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X3<span class="sc">$</span>z1.lb <span class="sc">+</span> med_mod_X3<span class="sc">$</span>z1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Total effect</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>tot_effect_med_X3 <span class="ot">&lt;-</span> delta_0_med_X3 <span class="sc">+</span> zeta_1_med_X3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The estimated values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Total effect</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>tot_effect_med <span class="ot">&lt;-</span> tot_effect_med_X1</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Indirect effects</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>delta_0_med <span class="ot">&lt;-</span> delta_0_med_X1 <span class="sc">+</span> delta_0_med_X2 <span class="sc">+</span> delta_0_med_X3</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct effect </span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>zeta_1_med <span class="ot">&lt;-</span> tot_effect_med <span class="sc">-</span> delta_0_med</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">delta_0 =</span> delta_0_med, <span class="at">zeta_1 =</span> zeta_1_med, <span class="at">tot_effect =</span> tot_effect_med)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      delta_0   zeta_1 tot_effect
[1,] 0.101747 0.203253      0.305</code></pre>
</div>
</div>
</section>
<section id="with-optimal-transport" class="level3" data-number="13.3.2">
<h3 data-number="13.3.2" class="anchored" data-anchor-id="with-optimal-transport"><span class="header-section-number">13.3.2</span> With Optimal Transport</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use a random forest to estimate the outcome model (see <code class="sourceCode r"><span class="fu">causal_effects_cf</span>()</code> in <a href="functions.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>causal_effects_ot <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(tb_ot_transported), </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated <span class="co"># 0</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_0 =</span> causal_effects_ot<span class="sc">$</span>delta_0,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeta_1 =</span> causal_effects_ot<span class="sc">$</span>zeta_1, </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">tot_effect =</span> causal_effects_ot<span class="sc">$</span>tot_effect</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       delta_0    zeta_1 tot_effect
[1,] 0.1190588 0.1873258  0.3063846</code></pre>
</div>
</div>
</section>
<section id="with-penalized-optimal-transport" class="level3" data-number="13.3.3">
<h3 data-number="13.3.3" class="anchored" data-anchor-id="with-penalized-optimal-transport"><span class="header-section-number">13.3.3</span> With Penalized Optimal Transport</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>causal_effects_sink_ot <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(tb_sinkhorn_transported), </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated <span class="co"># 0</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_0 =</span> causal_effects_sink_ot<span class="sc">$</span>delta_0,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeta_1 =</span> causal_effects_sink_ot<span class="sc">$</span>zeta_1, </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">tot_effect =</span> causal_effects_sink_ot<span class="sc">$</span>tot_effect</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        delta_0    zeta_1 tot_effect
[1,] 0.09763864 0.2091517  0.3067904</code></pre>
</div>
</div>
</section>
<section id="with-sequential-transport" class="level3" data-number="13.3.4">
<h3 data-number="13.3.4" class="anchored" data-anchor-id="with-sequential-transport"><span class="header-section-number">13.3.4</span> With Sequential Transport</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>causal_effects_st <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(sequential_transport<span class="sc">$</span>transported), </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_0 =</span> causal_effects_st<span class="sc">$</span>delta_0,</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeta_1 =</span> causal_effects_st<span class="sc">$</span>zeta_1, </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">tot_effect =</span> causal_effects_st<span class="sc">$</span>tot_effect</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        delta_0    zeta_1 tot_effect
[1,] 0.08191665 0.2212608  0.3031774</code></pre>
</div>
</div>
</section>
<section id="with-fairadapt" class="level3" data-number="13.3.5">
<h3 data-number="13.3.5" class="anchored" data-anchor-id="with-fairadapt"><span class="header-section-number">13.3.5</span> With Fairadapt</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>causal_effects_fairadapt <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(adapt_data_0), </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y_name =</span> Y_name, </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_name =</span> A_name, </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_0 =</span> causal_effects_fairadapt<span class="sc">$</span>delta_0,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">zeta_1 =</span> causal_effects_fairadapt<span class="sc">$</span>zeta_1, </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">tot_effect =</span> causal_effects_fairadapt<span class="sc">$</span>tot_effect</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       delta_0    zeta_1 tot_effect
[1,] 0.1155111 0.1943078  0.3098189</code></pre>
</div>
</div>
<p>Let us visualize the distribution on the individuals effects for each transport-based method, in <a href="#fig-xp-simul-indiv-effects" class="quarto-xref">Figure&nbsp;<span>13.3</span></a> (frequency on the y-axis).</p>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tikzDevice)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../scripts/utils.R"</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>plot_hist_effects <span class="ot">&lt;-</span> <span class="cf">function</span>(x, </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                              var_name, </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">tikz =</span> <span class="cn">FALSE</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">fill =</span> <span class="st">"red"</span>,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">printed_method =</span> <span class="st">""</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">x_lim =</span> <span class="cn">NULL</span>,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">print_main =</span> <span class="cn">TRUE</span>,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">print_x_axis =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (print_main <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    name_effect <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(var_name, <span class="st">"^delta_0"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">delta_i$"</span>,<span class="co">#"$\\delta_i(0)$",</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(var_name, <span class="st">"^zeta_1"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">zeta_i$"</span>,<span class="co">#"$\\zeta_i(1)$",</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(var_name, <span class="st">"^tot_effect"</span>) <span class="sc">~</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">tau_i$"</span>,<span class="co">#"$\\tau_i(1)$",</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"other"</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tikz <span class="sc">==</span> <span class="cn">FALSE</span>) name_effect <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(name_effect)</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    name_effect <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (var_name <span class="sc">==</span> <span class="st">"tot_effect"</span>) {</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    data_plot <span class="ot">&lt;-</span> x[[<span class="st">"delta_0_i"</span>]] <span class="sc">+</span> x[[<span class="st">"zeta_1_i"</span>]]</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    data_plot <span class="ot">&lt;-</span> x[[var_name]]</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(x_lim)) {</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>      data_plot, </span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">family =</span> font_family,</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> fill, <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist</span>(</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>      data_plot, </span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>, <span class="at">family =</span> font_family,</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> fill, <span class="at">xlim =</span> x_lim, <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (print_x_axis) <span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">family =</span> font_family)</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">family =</span> font_family)</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">title</span>(</span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> name_effect, <span class="at">cex.main =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family</span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (printed_method <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">title</span>(</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylab =</span> printed_method, <span class="at">line =</span> <span class="dv">2</span>, </span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">cex.lab =</span> <span class="dv">1</span>, <span class="at">family =</span> font_family</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(data_plot), <span class="at">col =</span> <span class="st">"darkred"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>colour_methods <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "OT" = "#CC79A7",</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT-M"</span> <span class="ot">=</span> <span class="st">"#009E73"</span>,</span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>  <span class="st">"skh"</span> <span class="ot">=</span> <span class="st">"darkgray"</span>,</span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>  <span class="st">"seq_1"</span> <span class="ot">=</span> <span class="st">"#0072B2"</span>, </span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">#"seq_2" = "#D55E00",</span></span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fairadapt"</span> <span class="ot">=</span> <span class="st">"#9966FF"</span></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>export_tikz <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fl">1.27</span></span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="st">"xp-simulated-indiv-effects"</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a>width_tikz <span class="ot">&lt;-</span> <span class="fl">2.3</span><span class="sc">*</span>scale</span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a>height_tikz <span class="ot">&lt;-</span> <span class="fl">1.7</span><span class="sc">*</span>scale</span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tikz</span>(<span class="fu">paste0</span>(<span class="st">"figs/"</span>, file_name, <span class="st">".tex"</span>), <span class="at">width =</span> width_tikz, <span class="at">height =</span> height_tikz)</span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(</span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">3</span>),</span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(.<span class="dv">9</span>, <span class="dv">2</span>)), <span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(.<span class="dv">72</span>, <span class="dv">2</span>))</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> causal_effects_fairadapt,</span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> causal_effects_ot,</span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> causal_effects_sink_ot,</span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> causal_effects_st</span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"FPT"</span>,</span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"OT-M"</span>,</span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"SKH"</span>,</span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a>    i <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"ST"</span></span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var_name <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"delta_0_i"</span>, <span class="st">"zeta_1_i"</span>, <span class="st">"tot_effect"</span>)) {</span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a>    mar_bottom <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i <span class="sc">==</span> <span class="dv">3</span>, <span class="fl">2.1</span>, .<span class="dv">6</span>)</span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a>    mar_left <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(var_name <span class="sc">==</span> <span class="st">"delta_0_i"</span>, <span class="fl">3.1</span>, <span class="fl">2.1</span>)</span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a>    mar_top <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(i <span class="sc">==</span> <span class="dv">1</span>, <span class="fl">2.1</span>, .<span class="dv">1</span>)</span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a>    mar_right <span class="ot">&lt;-</span> .<span class="dv">4</span></span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>    printed_method <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a>      var_name <span class="sc">==</span> <span class="st">"delta_0_i"</span>, </span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(method <span class="sc">==</span> <span class="st">"OT-M"</span>, <span class="st">"OT"</span>, method), </span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span></span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(mar_bottom, mar_left, mar_top, mar_right))</span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a>    x_lim_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a>      <span class="st">"delta_0_i"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">6</span>, .<span class="dv">6</span>),</span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a>      <span class="st">"zeta_1_i"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">6</span>, .<span class="dv">6</span>),</span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tot_effect"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_hist_effects</span>(</span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x, <span class="at">var_name =</span> var_name, <span class="at">tikz =</span> export_tikz, </span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> colour_methods[i],</span>
<span id="cb52-119"><a href="#cb52-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">printed_method =</span> printed_method, </span>
<span id="cb52-120"><a href="#cb52-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">x_lim =</span> x_lim_list[[var_name]],</span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">print_main =</span> i <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">print_x_axis =</span> i <span class="sc">==</span> <span class="dv">4</span></span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-127"><a href="#cb52-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-128"><a href="#cb52-128" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_tikz <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_to_pdf</span>(</span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file_name, </span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"./figs/"</span>, <span class="at">keep_tex =</span> <span class="cn">FALSE</span>, <span class="at">crop =</span> T</span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-134"><a href="#cb52-134" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-xp-simul-indiv-effects" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-xp-simul-indiv-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.3: Distribution of individual direct effect (<span class="math inline">\(\delta_i(0)\)</span>), indirect effect (<span class="math inline">\(\zeta_i(0)\)</span>), and total causal effect (<span class="math inline">\(\tau_i\)</span>) estimated with transport-based counterfactuals with optimal transport (OT-M), penalized transport (SKH), and sequential transport (ST).
</figcaption>
<div aria-describedby="fig-xp-simul-indiv-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="xp-simulated_files/figure-html/fig-xp-simul-indiv-effects-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="monte-carlo-experiment" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="monte-carlo-experiment"><span class="header-section-number">13.4</span> Monte-Carlo Experiment</h2>
<p>We run Monte-Carlo simulations to reproduce the previous steps. In each of the 200 iteration, we draw some data according to the DGP presented in <a href="#sec-dgp" class="quarto-xref"><span>Section 13.1</span></a>. Then, we use the <code class="sourceCode r"><span class="fu">seq_trans</span>()</code> function (see <a href="functions.html" class="quarto-xref">Chapter&nbsp;<span>4</span></a>) to perform sequential conditional transport to transport individuals from the <span style="color: #00A08A;">untreated group</span> (<span class="math inline">\(A=0\)</span>) to the <span style="color: #D55E00;">treated group</span> (<span class="math inline">\(A=1\)</span>). We also use multivariate OT, penalized OT, and fairadapt.</p>
<p>We set the seeds for each replication and we define placeholders.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>seeds <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>res_simul_opt_trans <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(seeds))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>res_simul_sink_trans <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(seeds))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>res_simul_seq_trans <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(seeds))</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>res_simul_fairadapt <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(seeds))</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>res_simul_effects <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="fu">length</span>(seeds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This chunk is not evaluated. </span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The results from previously run simulations are loaded after this chunk.</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Each of the 200 replications takes about 9 seconds per run on a MB Pro with</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># a Apple M2 Pro chip and 32GB RAM.</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>ncl <span class="ot">&lt;-</span> <span class="fu">detectCores</span>()<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>(cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncl))</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(cl, {</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(transportsimplex)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"../scripts/functions.R"</span>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>()</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(seeds)) {</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"Simulation "</span>, i, <span class="st">"/"</span>, <span class="fu">length</span>(seeds), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  seed <span class="ot">&lt;-</span> seeds[i]</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  tb_all <span class="ot">&lt;-</span> <span class="fu">gen_data</span>(seed)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  tb <span class="ot">&lt;-</span> tb_all <span class="sc">|&gt;</span> <span class="fu">select</span>(A, X1, X2, X3, Y) <span class="sc">|&gt;</span> </span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">as.factor</span>(.x)))</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  A_name <span class="ot">&lt;-</span> <span class="st">"A"</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  A_untreated <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  Y_name <span class="ot">&lt;-</span> <span class="st">"Y"</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optimal Transport</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  tb_ot_transported <span class="ot">&lt;-</span> <span class="fu">optimal_transport_cf</span>(</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    tb,</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    Y_name,</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    A_name,</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    A_untreated</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>  tb_ot_transported <span class="ot">&lt;-</span> tb_ot_transported <span class="sc">|&gt;</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">X3 =</span> <span class="fu">as.factor</span>(X3))</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  tb_ot_transported <span class="ot">&lt;-</span> <span class="fu">as.list</span>(tb_ot_transported)</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  res_simul_opt_trans[[i]] <span class="ot">&lt;-</span> tb_ot_transported</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Penalized (0.1) Optimal Transport with Sinkhorn</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  tb_sinkhorn_transported <span class="ot">&lt;-</span> <span class="fu">optimal_transport_cf</span>(</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    tb,</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>    Y_name,</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    A_name,</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    A_untreated,</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">pen =</span> <span class="fl">0.1</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>  tb_sinkhorn_transported <span class="ot">&lt;-</span> tb_sinkhorn_transported <span class="sc">|&gt;</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">X3 =</span> <span class="fu">as.factor</span>(X3))</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>  tb_sinkhorn_transported <span class="ot">&lt;-</span> <span class="fu">as.list</span>(tb_sinkhorn_transported)</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>  res_simul_sink_trans[[i]] <span class="ot">&lt;-</span> tb_sinkhorn_transported</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sequential Transport                                        </span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>  sequential_transport <span class="ot">&lt;-</span> <span class="fu">seq_trans</span>(</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tb, </span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">adj =</span> adj, </span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">s =</span> A_name, </span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">S_0 =</span> <span class="dv">0</span>, <span class="co"># source: untreated</span></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Y_name, </span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_neighbors =</span> <span class="dv">50</span>, </span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_neighbors_q =</span> <span class="cn">NULL</span>,</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">silent =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">cl =</span> cl</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>  res_simul_seq_trans[[i]] <span class="ot">&lt;-</span> sequential_transport<span class="sc">$</span>transported</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fairadapt</span></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>  adj_reduced <span class="ot">&lt;-</span> adj[<span class="sc">-</span><span class="dv">5</span>,<span class="sc">-</span><span class="dv">5</span>]</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>  ind_0 <span class="ot">&lt;-</span> <span class="fu">which</span>(tb<span class="sc">$</span>A <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">select</span>(A, X1, X2, X3)</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>A <span class="ot">&lt;-</span> <span class="fu">factor</span>(data<span class="sc">$</span>A, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"0"</span>))</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>  fpt_model_0_to_1 <span class="ot">&lt;-</span> <span class="fu">fairadapt</span>(</span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>      X3 <span class="sc">~</span> ., </span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">train.data =</span> data,</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">prot.attr =</span> <span class="st">"A"</span>, <span class="at">adj.mat =</span> adj_reduced,</span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant.method =</span> rangerQuants</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>  adapt_data_0 <span class="ot">&lt;-</span> <span class="fu">adaptedData</span>(fpt_model_0_to_1)</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>  adapt_data_0 <span class="ot">&lt;-</span> adapt_data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>A)</span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>  res_simul_fairadapt[[i]] <span class="ot">&lt;-</span> adapt_data_0[ind_0,]</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>  tb_untreated <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(A_name) <span class="sc">==</span> <span class="sc">!!</span>A_untreated)</span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>  tb_treated <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(A_name) <span class="sc">!=</span> <span class="sc">!!</span>A_untreated)</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>  n_untreated <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tb_untreated)</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>  n_treated <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tb_treated)</span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Measuring Causal Effect----</span></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With Causal Mediation Analysis</span></span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>  tb_med <span class="ot">&lt;-</span> tb <span class="sc">|&gt;</span> </span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">X3 =</span> <span class="fu">case_when</span>(</span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>        X3 <span class="sc">==</span> <span class="st">"A"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>        X3 <span class="sc">==</span> <span class="st">"B"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>        X3 <span class="sc">==</span> <span class="st">"C"</span> <span class="sc">~</span> <span class="dv">2</span></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>  med_mod_X1 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.main =</span> <span class="st">"X1"</span>, </span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.alt =</span> <span class="fu">c</span>(<span class="st">"X2"</span>, <span class="st">"X3"</span>), </span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tb_med</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>  delta_0_med_X1 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X1<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_X1<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>  zeta_1_med_X1 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X1<span class="sc">$</span>z1.lb <span class="sc">+</span> med_mod_X1<span class="sc">$</span>z1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a>  tot_effect_med_X1 <span class="ot">&lt;-</span> delta_0_med_X1 <span class="sc">+</span> zeta_1_med_X1</span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>  med_mod_X2 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.main =</span> <span class="st">"X2"</span>, </span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.alt =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X3"</span>), </span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tb_med</span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>  delta_0_med_X2 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X2<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_X2<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>  zeta_1_med_X2 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X2<span class="sc">$</span>z1.lb <span class="sc">+</span> med_mod_X2<span class="sc">$</span>z1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a>  tot_effect_med_X2 <span class="ot">&lt;-</span> delta_0_med_X2 <span class="sc">+</span> zeta_1_med_X2</span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a>  med_mod_X3 <span class="ot">&lt;-</span> mediation<span class="sc">::</span><span class="fu">multimed</span>(</span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="st">"Y"</span>, </span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.main =</span> <span class="st">"X3"</span>, </span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">med.alt =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>), </span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="st">"A"</span>, </span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tb_med</span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>  delta_0_med_X3 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X3<span class="sc">$</span>d0.lb <span class="sc">+</span> med_mod_X3<span class="sc">$</span>d0.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>  zeta_1_med_X3 <span class="ot">&lt;-</span> <span class="fu">mean</span>((med_mod_X3<span class="sc">$</span>z1.lb <span class="sc">+</span> med_mod_X3<span class="sc">$</span>z1.ub) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>  tot_effect_med_X3 <span class="ot">&lt;-</span> delta_0_med_X3 <span class="sc">+</span> zeta_1_med_X3</span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summary of the causal effects</span></span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a>  tot_effect_med <span class="ot">&lt;-</span> tot_effect_med_X1</span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a>  delta_0_med <span class="ot">&lt;-</span> delta_0_med_X1 <span class="sc">+</span> delta_0_med_X2 <span class="sc">+</span> delta_0_med_X3</span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a>  zeta_1_med <span class="ot">&lt;-</span> tot_effect_med <span class="sc">-</span> delta_0_med</span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># With Counterfactual Values</span></span>
<span id="cb54-138"><a href="#cb54-138" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Optimal Transport</span></span>
<span id="cb54-139"><a href="#cb54-139" aria-hidden="true" tabindex="-1"></a>  causal_effects_ot <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(tb_ot_transported), </span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb54-144"><a href="#cb54-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb54-145"><a href="#cb54-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb54-146"><a href="#cb54-146" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-147"><a href="#cb54-147" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Sinkhorn Optimal Transport</span></span>
<span id="cb54-148"><a href="#cb54-148" aria-hidden="true" tabindex="-1"></a>  causal_effects_sink_ot <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb54-149"><a href="#cb54-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb54-150"><a href="#cb54-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb54-151"><a href="#cb54-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(tb_sinkhorn_transported), </span>
<span id="cb54-152"><a href="#cb54-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb54-153"><a href="#cb54-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb54-154"><a href="#cb54-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb54-155"><a href="#cb54-155" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-156"><a href="#cb54-156" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Sequential Transport</span></span>
<span id="cb54-157"><a href="#cb54-157" aria-hidden="true" tabindex="-1"></a>  causal_effects_st <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb54-158"><a href="#cb54-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb54-159"><a href="#cb54-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb54-160"><a href="#cb54-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(sequential_transport<span class="sc">$</span>transported), </span>
<span id="cb54-161"><a href="#cb54-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb54-162"><a href="#cb54-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb54-163"><a href="#cb54-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb54-164"><a href="#cb54-164" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-165"><a href="#cb54-165" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Fairadapt</span></span>
<span id="cb54-166"><a href="#cb54-166" aria-hidden="true" tabindex="-1"></a>  causal_effects_fairadapt <span class="ot">&lt;-</span> <span class="fu">causal_effects_cf</span>(</span>
<span id="cb54-167"><a href="#cb54-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_untreated =</span> tb_untreated, </span>
<span id="cb54-168"><a href="#cb54-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_treated =</span> tb_treated,</span>
<span id="cb54-169"><a href="#cb54-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cf_untreated =</span> <span class="fu">as_tibble</span>(adapt_data_0[ind_0,]), </span>
<span id="cb54-170"><a href="#cb54-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_name =</span> Y_name, </span>
<span id="cb54-171"><a href="#cb54-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_name =</span> A_name, </span>
<span id="cb54-172"><a href="#cb54-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">A_untreated =</span> A_untreated</span>
<span id="cb54-173"><a href="#cb54-173" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-174"><a href="#cb54-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-175"><a href="#cb54-175" aria-hidden="true" tabindex="-1"></a>  res_simul_effects[[i]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-176"><a href="#cb54-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb54-177"><a href="#cb54-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_med =</span> delta_0_med, </span>
<span id="cb54-178"><a href="#cb54-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_med =</span> zeta_1_med, </span>
<span id="cb54-179"><a href="#cb54-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_med =</span> tot_effect_med,</span>
<span id="cb54-180"><a href="#cb54-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_ot =</span> causal_effects_ot<span class="sc">$</span>delta_0,</span>
<span id="cb54-181"><a href="#cb54-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_ot =</span> causal_effects_ot<span class="sc">$</span>zeta_1, </span>
<span id="cb54-182"><a href="#cb54-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_ot =</span> causal_effects_ot<span class="sc">$</span>tot_effect,</span>
<span id="cb54-183"><a href="#cb54-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_sink_ot =</span> causal_effects_sink_ot<span class="sc">$</span>delta_0,</span>
<span id="cb54-184"><a href="#cb54-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_sink_ot =</span> causal_effects_sink_ot<span class="sc">$</span>zeta_1, </span>
<span id="cb54-185"><a href="#cb54-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_sink_ot =</span> causal_effects_sink_ot<span class="sc">$</span>tot_effect,</span>
<span id="cb54-186"><a href="#cb54-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_st =</span> causal_effects_st<span class="sc">$</span>delta_0,</span>
<span id="cb54-187"><a href="#cb54-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_st =</span> causal_effects_st<span class="sc">$</span>zeta_1, </span>
<span id="cb54-188"><a href="#cb54-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_st =</span> causal_effects_st<span class="sc">$</span>tot_effect,</span>
<span id="cb54-189"><a href="#cb54-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_0_fairadapt =</span> causal_effects_fairadapt<span class="sc">$</span>delta_0,</span>
<span id="cb54-190"><a href="#cb54-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">zeta_1_fairadapt =</span> causal_effects_fairadapt<span class="sc">$</span>zeta_1, </span>
<span id="cb54-191"><a href="#cb54-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_effect_fairadapt =</span> causal_effects_fairadapt<span class="sc">$</span>tot_effect</span>
<span id="cb54-192"><a href="#cb54-192" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-193"><a href="#cb54-193" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-194"><a href="#cb54-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-195"><a href="#cb54-195" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(</span>
<span id="cb54-196"><a href="#cb54-196" aria-hidden="true" tabindex="-1"></a>  res_simul_opt_trans, </span>
<span id="cb54-197"><a href="#cb54-197" aria-hidden="true" tabindex="-1"></a>  res_simul_sink_trans, </span>
<span id="cb54-198"><a href="#cb54-198" aria-hidden="true" tabindex="-1"></a>  res_simul_seq_trans, </span>
<span id="cb54-199"><a href="#cb54-199" aria-hidden="true" tabindex="-1"></a>  res_simul_fairadapt,</span>
<span id="cb54-200"><a href="#cb54-200" aria-hidden="true" tabindex="-1"></a>  res_simul_effects, </span>
<span id="cb54-201"><a href="#cb54-201" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"../output/res_simul.rda"</span></span>
<span id="cb54-202"><a href="#cb54-202" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-203"><a href="#cb54-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-204"><a href="#cb54-204" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We load previously run simulations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../output/res_simul.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can look at the measures of causal effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>causal_effects <span class="ot">&lt;-</span> <span class="fu">list_rbind</span>(res_simul_effects)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Codes to create the Figure.</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tikzDevice)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>export_pdf <span class="ot">&lt;-</span> TRUE<span class="co">#FALSE</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>labels_strip <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">delta}$"</span>,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">zeta}$"</span>,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"$</span><span class="sc">\\</span><span class="st">bar{</span><span class="sc">\\</span><span class="st">tau}$"</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_pdf <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  labels_strip <span class="ot">=</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(labels_strip)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>data_plot <span class="ot">&lt;-</span> causal_effects <span class="sc">|&gt;</span> </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>seed, </span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"name"</span>, <span class="at">values_to =</span> <span class="st">"tau"</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"^delta"</span>) <span class="sc">~</span> <span class="st">"delta"</span>,</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"^zeta"</span>) <span class="sc">~</span> <span class="st">"zeta"</span>,</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"^tot_effect"</span>) <span class="sc">~</span> <span class="st">"tot_effect"</span>,</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">factor</span>(</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>      type, </span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"delta"</span>, <span class="st">"zeta"</span>, <span class="st">"tot_effect"</span>),</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> labels_strip</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">Method =</span> <span class="fu">case_when</span>(</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_med$"</span>) <span class="sc">~</span> <span class="st">"causal_med"</span>,</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_st$"</span>) <span class="sc">~</span> <span class="st">"seq_ot"</span>,</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_sink_ot$"</span>) <span class="sc">~</span> <span class="st">"sink_ot"</span>,</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_ot$"</span>) <span class="sc">~</span> <span class="st">"ot"</span>,</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(name, <span class="st">"_fairadapt$"</span>) <span class="sc">~</span> <span class="st">"fairadapt"</span>,</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">Method =</span> <span class="fu">factor</span>(</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>      Method,</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"seq_ot"</span>, <span class="st">"sink_ot"</span>, <span class="st">"ot"</span>, <span class="st">"fairadapt"</span>, <span class="st">"causal_med"</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"ST"</span>, <span class="st">"SKH"</span>, <span class="st">"OT"</span>, <span class="st">"FPT"</span>, <span class="st">"CM"</span>)</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_plot,</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> tau, <span class="at">y =</span> Method)</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mapping = aes(x = value, y = method, fill = method),</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> Method),</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">quantiles =</span>  <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>),</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">quantile.linetype =</span> <span class="st">"solid"</span></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_pdf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span> </span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> type, <span class="at">scales =</span> <span class="st">"free_x"</span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> type, <span class="at">scales =</span> <span class="st">"free_x"</span>,</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">labeller =</span> <span class="fu">as_labeller</span>(latex2exp<span class="sc">::</span>TeX, <span class="at">default =</span> label_parsed)</span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span>, </span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CM"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span>,</span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a>      <span class="st">"OT"</span> <span class="ot">=</span> colour_methods[[<span class="st">"OT-M"</span>]], </span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SKH"</span> <span class="ot">=</span> colour_methods[[<span class="st">"skh"</span>]], </span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ST"</span> <span class="ot">=</span>  colour_methods[[<span class="st">"seq_1"</span>]],</span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a>      <span class="st">"FPT"</span> <span class="ot">=</span>  colour_methods[[<span class="st">"fairadapt"</span>]]</span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_paper</span>()</span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (export_pdf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot2_to_pdf</span>(</span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"lines"</span>)) <span class="sc">+</span></span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_x_continuous</span>(</span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"$"</span>, x, <span class="st">"$"</span>),</span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"xp-simulated-violin-mc"</span>, <span class="at">path =</span> <span class="st">"figs/"</span>, </span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> scale<span class="sc">*</span><span class="fl">3.3</span>, <span class="at">height =</span> scale<span class="sc">*</span><span class="fl">1.3</span>,</span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">crop =</span> <span class="cn">TRUE</span></span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system</span>(<span class="fu">paste0</span>(<span class="st">"pdfcrop figs/xp-simulated-violin-mc.pdf figs/xp-simulated-violin-mc.pdf"</span>))</span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-simul-mc-causal-effects" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-simul-mc-causal-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.4: Causal effects, 200 replications.
</figcaption>
<div aria-describedby="fig-simul-mc-causal-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="xp-simulated_files/figure-html/fig-simul-mc-causal-effects-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-de2024transport" class="csl-entry" role="listitem">
De Lara, Lucas, Alberto GonzÃ¡lez-Sanz, Nicholas Asher, Laurent Risser, and Jean-Michel Loubes. 2024. <span>â€œTransport-Based Counterfactual Models.â€</span> <em>Journal of Machine Learning Research</em> 25 (136): 1â€“59.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./transport-gaussian-local-weights.html" class="pagination-link" aria-label="Gaussian Conditional Univariate Transport with Local Weights">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Gaussian Conditional Univariate Transport with Local Weights</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./xp-compas.html" class="pagination-link" aria-label="Compas">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Compas</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




</body></html>